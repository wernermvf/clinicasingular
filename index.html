<!DOCTYPE html>
<html lang="pt-BR" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clínica Singular - Gestão</title>
    
    <!-- 
        NOTA SOBRE AVISOS NO CONSOLE:
        - Tailwind CDN: Aviso sobre uso em produção - É seguro para desenvolvimento e projetos simples
        - Source Maps 404: Avisos normais do DevTools para bibliotecas CDN - Não afetam funcionalidade
        Esses avisos podem ser ignorados com segurança.
    -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FullCalendar (Agenda) -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

    <!-- Chart.js (Dashboard) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF (Relatórios) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.js"></script>
    
    <!-- idb (Offline Sync - IndexedDB) -->
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Estilos base */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Oculta páginas/views por padrão */
        .page {
            display: none;
        }
        
        /* Classe para mostrar a view ativa */
        .page.active {
            display: block;
        }

        /* Classes de utilidade para sync status */
        .sync-synced { color: #22c55e; } /* green-500 */
        .sync-syncing { color: #f59e0b; } /* amber-500 */
        .sync-offline { color: #8b5cf6; } /* violet-500 */
        .sync-error { color: #ef4444; } /* red-500 */

        /* Ajustes do FullCalendar com Tailwind */
        :root {
            --fc-border-color: #e5e7eb;
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-dot-width: 8px;
            --fc-event-bg-color: #3b82f6;
            --fc-event-border-color: #3b82f6;
            --fc-event-text-color: #ffffff;
            --fc-today-bg-color: #eff6ff;
            --fc-button-bg-color: #3b82f6;
            --fc-button-text-color: #ffffff;
            --fc-button-border-color: #3b82f6;
            --fc-button-hover-bg-color: #2563eb;
            --fc-button-hover-border-color: #2563eb;
            --fc-button-active-bg-color: #1d4ed8;
            --fc-button-active-border-color: #1d4ed8;
        }

        /* Estilos gerais do calendário */
        .fc {
            font-size: 0.875rem;
        }
        
        /* Melhorar visualização dos eventos */
        .fc-event {
            border-radius: 4px;
            padding: 2px 4px;
            margin: 1px 0;
            font-size: 0.8125rem;
            line-height: 1.4;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .fc-event:hover {
            opacity: 0.85;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Visualização Mensal */
        .fc-daygrid-event {
            white-space: normal;
            align-items: flex-start;
        }
        
        .fc-daygrid-day-number {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            padding: 8px;
        }
        
        .fc-day-today .fc-daygrid-day-number {
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Visualização Semanal/Diária */
        .fc-timegrid-event {
            border-radius: 4px;
            border-left-width: 4px !important;
        }
        
        .fc-timegrid-event-harness {
            margin-right: 2px;
        }
        
        .fc-timegrid-slot {
            height: 3em;
        }
        
        .fc-timegrid-slot-label {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        /* Visualização de Lista */
        .fc-list-event {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .fc-list-event:hover {
            background-color: #f9fafb;
        }
        
        .fc-list-event-dot {
            border-width: 4px;
        }
        
        .fc-list-day-cushion {
            background: #f3f4f6;
            font-weight: 600;
        }
        
        /* Botões do calendário */
        .fc-button {
            text-transform: capitalize;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .fc-button-primary:not(:disabled):active,
        .fc-button-primary:not(:disabled).fc-button-active {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        
        /* Header do calendário */
        .fc-toolbar-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }
        
        /* Dias da semana */
        .fc-col-header-cell {
            font-weight: 600;
            color: #374151;
            background: #f9fafb;
            padding: 12px 0;
        }
        
        /* Melhorar "mais eventos" */
        .fc-daygrid-more-link {
            color: #3b82f6;
            font-weight: 500;
            margin: 2px;
        }
        
        .fc-daygrid-more-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }
    </style>
</head>
<body class="h-full">

    <!-- 1. Tela de Login (View) -->
    <div id="login-view" class="flex items-center justify-center min-h-full bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-md space-y-8">
            <div>
                <svg class="mx-auto h-12 w-auto text-blue-600" data-lucide="brain"></svg>
                <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-gray-900">
                    Clínica Singular
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Acesse seu painel de gestão
                </p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email</label>
                        <input id="login-email" name="email" type="email" autocomplete="email" required
                            class="relative block w-full appearance-none rounded-none rounded-t-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-500 focus:outline-none focus:ring-blue-500 sm:text-sm"
                            placeholder="Endereço de email">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Senha</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password"
                            required
                            class="relative block w-full appearance-none rounded-none rounded-b-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-500 focus:outline-none focus:ring-blue-500 sm:text-sm"
                            placeholder="Senha">
                    </div>
                </div>
                <div>
                    <button type="submit"
                        class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-blue-500 group-hover:text-blue-400" data-lucide="lock"
                                aria-hidden="true"></svg>
                        </span>
                        Entrar
                    </button>
                </div>
                <p id="login-error" class="mt-2 text-center text-sm text-red-600"></p>
            </form>
        </div>
    </div>

    <!-- 2. Aplicação Principal (View) -->
    <div id="app-view" class="hidden h-full">
        <!-- Sidebar (Desktop) -->
        <div id="sidebar"
            class="fixed inset-y-0 z-50 hidden w-64 flex-col bg-white shadow-lg md:flex">
            <div class="flex flex-shrink-0 items-center px-6 h-16 border-b border-gray-200">
                <svg class="h-8 w-auto text-blue-600" data-lucide="brain"></svg>
                <span class="ml-3 text-xl font-bold text-gray-800">Clínica Singular</span>
            </div>
            <div class="flex flex-1 flex-col overflow-y-auto">
                <nav id="app-nav" class="flex-1 space-y-1 px-4 py-4"></nav>
            </div>
            <div class="border-t border-gray-200 p-4">
                <div class="flex items-center">
                    <div>
                        <div id="user-name" class="text-sm font-medium text-gray-800"></div>
                        <div id="user-role" class="text-xs text-gray-500"></div>
                    </div>
                </div>
                <button id="logout-button"
                    class="mt-4 w-full flex items-center justify-center rounded-md border border-transparent bg-gray-100 py-2 px-4 text-sm font-medium text-gray-700 hover:bg-gray-200">
                    <svg class="mr-2 h-4 w-4" data-lucide="log-out"></svg>
                    Sair
                </button>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="flex flex-1 flex-col md:pl-64">
            <!-- Header (Mobile + Info) -->
            <header class="sticky top-0 z-40 flex h-16 flex-shrink-0 items-center justify-between border-b border-gray-200 bg-white px-4 sm:px-6 lg:px-8">
                <!-- Botão Menu Mobile -->
                <button type="button" id="mobile-menu-button"
                    class="rounded-md p-2 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 md:hidden">
                    <span class="sr-only">Abrir menu</span>
                    <svg class="h-6 w-6" data-lucide="menu"></svg>
                </button>
                
                <!-- Placeholder para manter o título centralizado -->
                <div class="md:hidden"></div>

                <!-- Título da Página Atual -->
                <h1 id="page-title" class="text-lg font-semibold text-gray-800"></h1>

                <!-- Status da Sincronização -->
                <div id="sync-status" class="flex items-center space-x-2 text-sm">
                    <svg id="sync-icon" class="h-5 w-5" data-lucide="wifi"></svg>
                    <span id="sync-text" class="hidden sm:inline"></span>
                </div>
            </header>

            <!-- Conteúdo da Página -->
            <main class="flex-1">
                <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">

                    <!-- Página: Dashboard -->
                    <div id="dashboard-page" class="page">
                        <div class="mb-6">
                            <h2 class="text-3xl font-bold text-gray-900">Dashboard</h2>
                            <p class="mt-1 text-sm text-gray-600">Visão geral da clínica em tempo real</p>
                        </div>

                        <!-- Cards de Estatísticas -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Card: Total de Agendamentos -->
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-100 text-sm font-medium">Agendamentos (Mês)</p>
                                        <p id="stat-total-agendamentos" class="text-3xl font-bold mt-2">0</p>
                                    </div>
                                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                                        <i data-lucide="calendar" class="w-8 h-8"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card: Taxa de Presença -->
                            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100 text-sm font-medium">Taxa de Presença</p>
                                        <p id="stat-taxa-presenca" class="text-3xl font-bold mt-2">0%</p>
                                    </div>
                                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                                        <i data-lucide="check-circle" class="w-8 h-8"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card: Receita do Mês -->
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-purple-100 text-sm font-medium">Receita do Mês</p>
                                        <p id="stat-receita-mes" class="text-3xl font-bold mt-2">R$ 0</p>
                                    </div>
                                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                                        <i data-lucide="dollar-sign" class="w-8 h-8"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card: Pacotes Ativos -->
                            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-orange-100 text-sm font-medium">Pacotes Ativos</p>
                                        <p id="stat-pacotes-ativos" class="text-3xl font-bold mt-2">0</p>
                                    </div>
                                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                                        <i data-lucide="package" class="w-8 h-8"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gráficos -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- Gráfico: Status dos Agendamentos -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="pie-chart" class="w-5 h-5 text-blue-600"></i>
                                    Status dos Agendamentos
                                </h3>
                                <canvas id="chart-status" class="max-h-64"></canvas>
                            </div>

                            <!-- Gráfico: Receitas Mensais -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="trending-up" class="w-5 h-5 text-green-600"></i>
                                    Receitas (Últimos 6 Meses)
                                </h3>
                                <canvas id="chart-receitas" class="max-h-64"></canvas>
                            </div>
                        </div>

                        <!-- Ranking de Especialidades -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <i data-lucide="award" class="w-5 h-5 text-purple-600"></i>
                                Top Especialidades (Este Mês)
                            </h3>
                            <div id="ranking-especialidades" class="space-y-4">
                                <!-- Preenchido via JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Página: Agenda -->
                    <div id="agenda-page" class="page">
                        <!-- Header Moderno -->
                        <div class="mb-8">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div>
                                    <h2 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" data-lucide="calendar-days"></svg>
                                        </div>
                                        Agenda de Atendimentos
                                    </h2>
                                    <p class="mt-2 text-sm text-gray-600">Visualize e gerencie todos os agendamentos</p>
                                </div>
                                <button id="add-appointment-btn"
                                    class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 transition-all duration-200">
                                    <svg class="w-5 h-5" data-lucide="plus-circle"></svg>
                                    Novo Atendimento
                                </button>
                            </div>
                        </div>

                        <!-- Filtros Rápidos -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <!-- Filtro por Profissional -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-400" data-lucide="user-check"></svg>
                                        Profissional
                                    </label>
                                    <select id="filter-calendar-therapist" 
                                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                        <option value="">Todos</option>
                                    </select>
                                </div>

                                <!-- Filtro por Especialidade -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-400" data-lucide="clipboard-list"></svg>
                                        Especialidade
                                    </label>
                                    <select id="filter-calendar-specialty" 
                                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                        <option value="">Todas</option>
                                    </select>
                                </div>

                                <!-- Filtro por Status -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-400" data-lucide="filter"></svg>
                                        Status
                                    </label>
                                    <select id="filter-calendar-status" 
                                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                        <option value="">Todos</option>
                                        <option value="scheduled">Agendado</option>
                                        <option value="confirmed">Confirmado</option>
                                        <option value="present">Presente</option>
                                        <option value="absent">Ausente</option>
                                        <option value="cancelled">Cancelado</option>
                                    </select>
                                </div>

                                <!-- Botão Aplicar Filtros -->
                                <div class="flex items-end">
                                    <button id="apply-calendar-filters"
                                        class="w-full rounded-lg bg-gray-100 hover:bg-gray-200 px-4 py-2.5 text-sm font-medium text-gray-700 transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" data-lucide="search"></svg>
                                        Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Estatísticas Rápidas -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <!-- Total de Agendamentos -->
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90 font-medium">Total Hoje</p>
                                        <p id="stat-total-today" class="text-3xl font-bold mt-1">0</p>
                                    </div>
                                    <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" data-lucide="calendar"></svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Confirmados -->
                            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-5 text-white shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90 font-medium">Confirmados</p>
                                        <p id="stat-confirmed" class="text-3xl font-bold mt-1">0</p>
                                    </div>
                                    <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" data-lucide="check-circle"></svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Pendentes -->
                            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-5 text-white shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90 font-medium">Pendentes</p>
                                        <p id="stat-pending" class="text-3xl font-bold mt-1">0</p>
                                    </div>
                                    <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" data-lucide="clock"></svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Presentes -->
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white shadow-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90 font-medium">Presentes</p>
                                        <p id="stat-present" class="text-3xl font-bold mt-1">0</p>
                                    </div>
                                    <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6" data-lucide="user-check"></svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendário -->
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                            <div id="calendar" class="p-6"></div>
                        </div>

                        <!-- Legenda de Cores -->
                        <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                            <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4" data-lucide="palette"></svg>
                                Legenda de Status
                            </h3>
                            <div class="flex flex-wrap gap-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded bg-blue-500"></div>
                                    <span class="text-sm text-gray-600">Agendado</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded bg-green-500"></div>
                                    <span class="text-sm text-gray-600">Confirmado</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded bg-purple-500"></div>
                                    <span class="text-sm text-gray-600">Presente</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded bg-red-500"></div>
                                    <span class="text-sm text-gray-600">Ausente</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded bg-gray-400"></div>
                                    <span class="text-sm text-gray-600">Cancelado</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Página: Pacientes -->
                    <div id="pacientes-page" class="page">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Pacientes</h2>
                            <button id="add-patient-btn"
                                class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                                Novo Paciente
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                            <input type="text" id="search-pacientes" placeholder="Buscar paciente..." class="mb-4 w-full max-w-sm rounded-md border-gray-300 shadow-sm">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Nome</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Responsável</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Telefone</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Status</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Editar</span></th>
                                    </tr>
                                </thead>
                                <tbody id="pacientes-table-body" class="divide-y divide-gray-200 bg-white">
                                    <!-- Linhas injetadas via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Página: Pagamentos / Financeiro -->
                    <div id="financeiro-page" class="page">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">Gestão Financeira</h2>
                            <p class="mt-1 text-sm text-gray-600">Visão completa do financeiro da clínica</p>
                        </div>

                        <!-- Filtros -->
                        <div class="bg-white p-4 rounded-lg shadow mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Período</label>
                                    <select id="financial-period-filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="today">Hoje</option>
                                        <option value="week">Esta Semana</option>
                                        <option value="month" selected>Este Mês</option>
                                        <option value="quarter">Este Trimestre</option>
                                        <option value="year">Este Ano</option>
                                        <option value="custom">Personalizado</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Profissional</label>
                                    <select id="financial-professional-filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Especialidade</label>
                                    <select id="financial-specialty-filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Todas</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select id="financial-status-filter" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Todos</option>
                                        <option value="presence">Presença</option>
                                        <option value="absence">Ausência</option>
                                        <option value="scheduled">Agendado</option>
                                        <option value="cancelled">Cancelado</option>
                                    </select>
                                </div>
                            </div>
                            <div id="custom-date-range" class="mt-4 grid grid-cols-2 gap-4" style="display: none;">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Data Inicial</label>
                                    <input type="date" id="financial-start-date" class="w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Data Final</label>
                                    <input type="date" id="financial-end-date" class="w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                            </div>
                        </div>

                        <!-- KPIs -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-lg shadow text-white">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-medium opacity-90">Receita Bruta</h3>
                                    <svg class="w-8 h-8 opacity-80" data-lucide="dollar-sign"></svg>
                                </div>
                                <p class="text-3xl font-bold" id="kpi-gross-revenue">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-2" id="kpi-gross-count">0 atendimentos</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-lg shadow text-white">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-medium opacity-90">Receita Líquida</h3>
                                    <svg class="w-8 h-8 opacity-80" data-lucide="trending-up"></svg>
                                </div>
                                <p class="text-3xl font-bold" id="kpi-net-revenue">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-2" id="kpi-net-percentage">0% da bruta</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-lg shadow text-white">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-medium opacity-90">Comissões</h3>
                                    <svg class="w-8 h-8 opacity-80" data-lucide="users"></svg>
                                </div>
                                <p class="text-3xl font-bold" id="kpi-commissions">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-2" id="kpi-commission-percentage">0% da bruta</p>
                            </div>
                            <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-lg shadow text-white">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-medium opacity-90">Ticket Médio</h3>
                                    <svg class="w-8 h-8 opacity-80" data-lucide="calculator"></svg>
                                </div>
                                <p class="text-3xl font-bold" id="kpi-avg-ticket">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-2" id="kpi-avg-description">por atendimento</p>
                            </div>
                        </div>

                        <!-- Abas de Visualização -->
                        <div class="bg-white rounded-lg shadow mb-6">
                            <div class="border-b border-gray-200">
                                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                                    <button onclick="switchFinancialTab('overview')" class="financial-tab-btn border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600" data-tab="overview">
                                        Visão Geral
                                    </button>
                                    <button onclick="switchFinancialTab('professionals')" class="financial-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="professionals">
                                        Por Profissional
                                    </button>
                                    <button onclick="switchFinancialTab('specialties')" class="financial-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="specialties">
                                        Por Especialidade
                                    </button>
                                    <button onclick="switchFinancialTab('patients')" class="financial-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="patients">
                                        Por Paciente
                                    </button>
                                </nav>
                            </div>

                            <!-- Tab Content: Visão Geral -->
                            <div id="financial-tab-overview" class="financial-tab-content p-6">
                                <h3 class="text-lg font-semibold mb-4">Resumo do Período</h3>
                                <div id="overview-content" class="space-y-4">
                                    <!-- Conteúdo dinâmico -->
                                </div>
                            </div>

                            <!-- Tab Content: Por Profissional -->
                            <div id="financial-tab-professionals" class="financial-tab-content p-6 hidden">
                                <h3 class="text-lg font-semibold mb-4">Desempenho por Profissional</h3>
                                <div id="professionals-content" class="space-y-4">
                                    <!-- Conteúdo dinâmico -->
                                </div>
                            </div>

                            <!-- Tab Content: Por Especialidade -->
                            <div id="financial-tab-specialties" class="financial-tab-content p-6 hidden">
                                <h3 class="text-lg font-semibold mb-4">Receita por Especialidade</h3>
                                <div id="specialties-content" class="space-y-4">
                                    <!-- Conteúdo dinâmico -->
                                </div>
                            </div>

                            <!-- Tab Content: Por Paciente -->
                            <div id="financial-tab-patients" class="financial-tab-content p-6 hidden">
                                <h3 class="text-lg font-semibold mb-4">Histórico por Paciente</h3>
                                <div id="patients-content" class="space-y-4">
                                    <!-- Conteúdo dinâmico -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Página: Relatórios -->
                    <div id="relatorios-page" class="page">
                        <h2 class="text-2xl font-bold mb-6">Relatórios</h2>
                        <!-- Conteúdo de Relatórios -->
                    </div>

                    <!-- Página: Usuários (Admin) -->
                    <div id="usuarios-page" class="page">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">Gestão de Usuários</h2>
                                <p class="mt-1 text-sm text-gray-600">Gerencie usuários e permissões do sistema</p>
                            </div>
                            <button id="add-user-btn" onclick="openModalUsuario()"
                                class="flex items-center gap-2 rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                                <svg class="w-5 h-5" data-lucide="user-plus"></svg>
                                Novo Usuário
                            </button>
                        </div>
                        
                        <!-- Filtros -->
                        <div class="bg-white p-4 rounded-lg shadow mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" id="search-usuarios" placeholder="Buscar por nome ou email..." 
                                    class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <select id="filter-role" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Todas as Funções</option>
                                    <option value="administrator">Administrador</option>
                                    <option value="reception">Recepção</option>
                                    <option value="therapist">Terapeuta</option>
                                </select>
                                <select id="filter-status" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Todos os Status</option>
                                    <option value="active">Ativo</option>
                                    <option value="inactive">Inativo</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Tabela de Usuários -->
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Usuário
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Email
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Função
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Status
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Último Acesso
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Ações
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="usuarios-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Linhas serão inseridas via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Página: Profissionais -->
                    <div id="profissionais-page" class="page">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Profissionais</h2>
                            <button id="add-professional-btn"
                                class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                                Novo Profissional
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                            <input type="text" id="search-profissionais" placeholder="Buscar profissional..." 
                                class="mb-4 w-full max-w-sm rounded-md border-gray-300 shadow-sm">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Nome</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Especialidades</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Email/Telefone</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Status</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
                                    </tr>
                                </thead>
                                <tbody id="profissionais-table-body" class="divide-y divide-gray-200 bg-white">
                                    <!-- Linhas injetadas via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Página: Especialidades -->
                    <div id="especialidades-page" class="page">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Especialidades</h2>
                            <button id="add-especialidade-btn"
                                class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                                Nova Especialidade
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="especialidades-grid">
                            <!-- Cards injetados via JS -->
                        </div>
                    </div>

                    <!-- Página: Agendas Fixas -->
                    <div id="agendas-fixas-page" class="page">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Agendas Fixas Semanais</h2>
                            <div class="flex gap-3">
                                <button onclick="generateAppointmentsFromFixedSchedules(3)"
                                    class="rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 flex items-center gap-2">
                                    <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                                    Gerar Agendamentos (3 meses)
                                </button>
                                <button id="add-agenda-fixa-btn"
                                    class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Nova Agenda Fixa
                                </button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="mb-4 flex space-x-4">
                                <select id="filter-professional" class="rounded-md border-gray-300 shadow-sm">
                                    <option value="">Todos os Profissionais</option>
                                </select>
                                <select id="filter-day" class="rounded-md border-gray-300 shadow-sm">
                                    <option value="">Todos os Dias</option>
                                    <option value="1">Segunda-feira</option>
                                    <option value="2">Terça-feira</option>
                                    <option value="3">Quarta-feira</option>
                                    <option value="4">Quinta-feira</option>
                                    <option value="5">Sexta-feira</option>
                                    <option value="6">Sábado</option>
                                    <option value="0">Domingo</option>
                                </select>
                            </div>
                            <div id="agendas-fixas-list">
                                <!-- Lista injetada via JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Página: Atendimentos -->
                    <div id="atendimentos-page" class="page">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Registro de Atendimentos</h2>
                            <div class="flex space-x-2">
                                <input type="date" id="filter-date" class="rounded-md border-gray-300 shadow-sm">
                                <select id="filter-status" class="rounded-md border-gray-300 shadow-sm">
                                    <option value="">Todos os Status</option>
                                    <option value="scheduled">Agendado</option>
                                    <option value="present">Presente</option>
                                    <option value="absent">Ausente</option>
                                    <option value="cancelled">Cancelado</option>
                                </select>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Data/Hora</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Paciente</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Profissional</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Especialidade</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Valores</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
                                    </tr>
                                </thead>
                                <tbody id="atendimentos-table-body" class="divide-y divide-gray-200 bg-white">
                                    <!-- Linhas injetadas via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Página: Minha Agenda (Therapist) -->
                    <div id="minha-agenda-page" class="page">
                        <h2 class="text-2xl font-bold mb-6">Minha Agenda</h2>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div id="therapist-calendar"></div>
                        </div>
                        <div class="mt-6 bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4">Resumo do Mês</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">Total de Atendimentos</p>
                                    <p class="text-2xl font-bold" id="my-total-appointments">0</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Presenças</p>
                                    <p class="text-2xl font-bold text-green-600" id="my-present">0</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Total de Repasse</p>
                                    <p class="text-2xl font-bold text-blue-600" id="my-total-value">R$ 0,00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Página: Auditoria -->
                    <div id="auditoria-page" class="page">
                        <h2 class="text-2xl font-bold mb-6">Registro de Auditoria</h2>
                        
                        <!-- Área de Gerenciamento do Banco de Dados -->
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 border-l-4 border-orange-500 p-6 rounded-lg shadow mb-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <svg class="w-6 h-6 text-orange-600" data-lucide="database"></svg>
                                Gerenciamento do Banco de Dados
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">Ferramentas críticas para administração do sistema. Use com cautela!</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Backup -->
                                <div class="bg-white p-4 rounded-lg border border-gray-200">
                                    <div class="flex items-center gap-2 mb-2">
                                        <svg class="w-5 h-5 text-blue-600" data-lucide="download-cloud"></svg>
                                        <h4 class="font-semibold text-gray-900">Backup</h4>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-3">Criar backup completo do banco de dados</p>
                                    <button onclick="createBackup()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                        Criar Backup
                                    </button>
                                </div>
                                
                                <!-- Restauração -->
                                <div class="bg-white p-4 rounded-lg border border-gray-200">
                                    <div class="flex items-center gap-2 mb-2">
                                        <svg class="w-5 h-5 text-green-600" data-lucide="upload-cloud"></svg>
                                        <h4 class="font-semibold text-gray-900">Restauração</h4>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-3">Restaurar dados de um backup anterior</p>
                                    <button onclick="openRestoreModal()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium">
                                        Restaurar Backup
                                    </button>
                                </div>
                                
                                <!-- Exclusão Total -->
                                <div class="bg-white p-4 rounded-lg border border-red-300">
                                    <div class="flex items-center gap-2 mb-2">
                                        <svg class="w-5 h-5 text-red-600" data-lucide="trash-2"></svg>
                                        <h4 class="font-semibold text-gray-900">Exclusão Total</h4>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-3">Apagar TODOS os dados (mantém estrutura)</p>
                                    <button onclick="deleteAllData()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">
                                        Apagar Tudo
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Lista de Backups -->
                            <div class="mt-4 bg-white p-4 rounded-lg border border-gray-200">
                                <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-gray-600" data-lucide="history"></svg>
                                    Backups Disponíveis
                                </h4>
                                <div id="backups-list" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- Lista de backups será inserida aqui -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="date" id="audit-data-inicio" class="rounded-md border-gray-300 shadow-sm">
                                <input type="date" id="audit-data-fim" class="rounded-md border-gray-300 shadow-sm">
                                <select id="audit-usuario" class="rounded-md border-gray-300 shadow-sm">
                                    <option value="">Todos Usuários</option>
                                </select>
                                <select id="audit-tipo" class="rounded-md border-gray-300 shadow-sm">
                                    <option value="">Todas Ações</option>
                                    <option value="create">Criação</option>
                                    <option value="update">Atualização</option>
                                    <option value="delete">Exclusão</option>
                                    <option value="status_change">Mudança de Status</option>
                                </select>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Data/Hora</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Usuário</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Ação</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Entidade</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Detalhes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditoria-table-body" class="divide-y divide-gray-200 bg-white">
                                        <!-- Linhas injetadas via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Página: Relatórios -->
                    <div id="relatorios-page" class="page">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">Relatórios em PDF</h2>
                            <p class="mt-2 text-sm text-gray-600">Gere relatórios detalhados para análise e impressão</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- Card: Agenda Semanal -->
                            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4">
                                    <div class="flex items-center gap-3 text-white">
                                        <i data-lucide="calendar-days" class="w-8 h-8"></i>
                                        <h3 class="text-xl font-bold">Agenda Semanal</h3>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <p class="text-gray-600 mb-4">Relatório de agendamentos por período com filtros personalizados</p>
                                    <div class="space-y-3 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Período</label>
                                            <div class="grid grid-cols-2 gap-2">
                                                <input type="date" id="report-agenda-inicio" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                <input type="date" id="report-agenda-fim" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Profissional</label>
                                            <select id="report-agenda-professional" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                <option value="">Todos</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button onclick="generateAgendaPDF()" 
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                        Gerar PDF
                                    </button>
                                </div>
                            </div>

                            <!-- Card: Relatório Financeiro -->
                            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                                <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4">
                                    <div class="flex items-center gap-3 text-white">
                                        <i data-lucide="dollar-sign" class="w-8 h-8"></i>
                                        <h3 class="text-xl font-bold">Relatório Financeiro</h3>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <p class="text-gray-600 mb-4">Receitas, comissões e análise financeira mensal</p>
                                    <div class="space-y-3 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Mês/Ano</label>
                                            <input type="month" id="report-financeiro-mes" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        </div>
                                    </div>
                                    <button onclick="generateFinanceiroPDF()" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                        Gerar PDF
                                    </button>
                                </div>
                            </div>

                            <!-- Card: Comissões por Profissional -->
                            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                                <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4">
                                    <div class="flex items-center gap-3 text-white">
                                        <i data-lucide="user-check" class="w-8 h-8"></i>
                                        <h3 class="text-xl font-bold">Comissões</h3>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <p class="text-gray-600 mb-4">Detalhamento de comissões por profissional</p>
                                    <div class="space-y-3 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Profissional</label>
                                            <select id="report-comissao-professional" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                <option value="">Selecione...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Mês/Ano</label>
                                            <input type="month" id="report-comissao-mes" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        </div>
                                    </div>
                                    <button onclick="generateComissaoPDF()" 
                                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                        Gerar PDF
                                    </button>
                                </div>
                            </div>

                            <!-- Card: Pacotes Ativos -->
                            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                                <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4">
                                    <div class="flex items-center gap-3 text-white">
                                        <i data-lucide="package" class="w-8 h-8"></i>
                                        <h3 class="text-xl font-bold">Pacotes Ativos</h3>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <p class="text-gray-600 mb-4">Lista de pacientes com pacotes e sessões restantes</p>
                                    <div class="space-y-3 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Filtro</label>
                                            <select id="report-pacotes-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                <option value="all">Todos os pacotes</option>
                                                <option value="active">Apenas com sessões restantes</option>
                                                <option value="expiring">Próximos a expirar</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button onclick="generatePacotesPDF()" 
                                        class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                        Gerar PDF
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Página: Configurações -->
                    <div id="configuracoes-page" class="page">
                        <h2 class="text-2xl font-bold mb-6">Configurações do Sistema</h2>
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4">Dados da Clínica</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Clínica</label>
                                        <input type="text" id="config-clinic-name" class="w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ</label>
                                        <input type="text" id="config-clinic-cnpj" class="w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                        <input type="text" id="config-clinic-phone" class="w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="config-clinic-email" class="w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-4">Configurações Financeiras</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Percentual Padrão de Repasse (%)</label>
                                        <input type="number" id="config-default-repass" min="0" max="100" class="w-full md:w-64 rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="config-auto-reports" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="ml-2 text-sm text-gray-700">Gerar relatórios automaticamente</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Zona de Perigo - Apenas Admin -->
                            <div id="danger-zone-section" class="bg-red-50 border-2 border-red-200 p-6 rounded-lg shadow" style="display: none;">
                                <h3 class="text-lg font-semibold text-red-900 mb-2">
                                    <svg class="inline-block w-5 h-5 mr-2" data-lucide="alert-triangle"></svg>
                                    Zona de Perigo
                                </h3>
                                <p class="text-sm text-red-700 mb-4">As ações abaixo são irreversíveis. Use com extrema cautela.</p>
                                
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between bg-white p-4 rounded border border-red-200">
                                        <div>
                                            <h4 class="font-medium text-gray-900">Limpar Todos os Atendimentos</h4>
                                            <p class="text-sm text-gray-600">Remove todos os atendimentos do sistema, mantendo apenas o mais recente como backup.</p>
                                        </div>
                                        <button onclick="confirmClearAppointments()" class="ml-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 whitespace-nowrap">
                                            <svg class="inline-block w-4 h-4 mr-1" data-lucide="trash-2"></svg>
                                            Limpar Atendimentos
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <button id="btn-save-config" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                                    Salvar Configurações
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>

        <!-- Menu Mobile (Overlay) -->
        <div id="mobile-menu" class="relative z-50 md:hidden" style="display: none;">
            <!-- Overlay -->
            <div id="mobile-menu-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-75"></div>
            <!-- Painel -->
            <div class="fixed inset-0 flex">
                <div class="relative flex w-full max-w-xs flex-1 flex-col bg-white">
                    <!-- Botão Fechar -->
                    <div class="absolute top-0 right-0 -mr-12 pt-2">
                        <button type="button" id="mobile-menu-close"
                            class="ml-1 flex h-10 w-10 items-center justify-center rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                            <span class="sr-only">Fechar menu</span>
                            <svg class="h-6 w-6 text-white" data-lucide="x"></svg>
                        </button>
                    </div>
                    <!-- Logo -->
                    <div class="flex flex-shrink-0 items-center px-6 h-16 border-b border-gray-200">
                        <svg class="h-8 w-auto text-blue-600" data-lucide="brain"></svg>
                        <span class="ml-3 text-xl font-bold text-gray-800">Clínica Singular</span>
                    </div>
                    <!-- Navegação -->
                    <div class="flex-1 overflow-y-auto">
                        <nav id="mobile-app-nav" class="space-y-1 px-4 py-4"></nav>
                    </div>
                    <!-- Usuário e Logout -->
                    <div class="border-t border-gray-200 p-4">
                        <div class="flex items-center">
                            <div>
                                <div id="mobile-user-name" class="text-sm font-medium text-gray-800"></div>
                                <div id="mobile-user-role" class="text-xs text-gray-500"></div>
                            </div>
                        </div>
                        <button id="mobile-logout-button"
                            class="mt-4 w-full flex items-center justify-center rounded-md border border-transparent bg-gray-100 py-2 px-4 text-sm font-medium text-gray-700 hover:bg-gray-200">
                            <svg class="mr-2 h-4 w-4" data-lucide="log-out"></svg>
                            Sair
                        </button>
                    </div>
                </div>
                <div class="w-14 flex-shrink-0"></div> <!-- Dummy element to force sidebar to shrink -->
            </div>
        </div>
    </div>
    
    <!-- Modal Genérico -->
    <div id="modal-container" class="relative z-[100]" style="display: none;">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div id="modal-icon" class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                <!-- Ícone via JS -->
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-lg font-semibold leading-6 text-gray-900" id="modal-title"></h3>
                                <div class="mt-2 w-full">
                                    <div id="modal-content" class="text-sm text-gray-500">
                                        <!-- Conteúdo do Form/Modal via JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" id="modal-primary-btn"
                            class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto">
                            Salvar
                        </button>
                        <button type="button" id="modal-secondary-btn"
                            class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Especialidade -->
    <div id="modal-especialidade" class="relative z-[100]" style="display: none;">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <form id="form-especialidade">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4" id="especialidade-title">Nova Especialidade</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                                    <input type="text" id="esp-name" required
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        placeholder="Ex: Psicologia">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                                    <textarea id="esp-description" rows="3"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        placeholder="Descrição da especialidade"></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor Paciente (R$) *</label>
                                        <input type="number" id="esp-patient-value" required step="0.01" min="0"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="150.00">
                                        <p class="mt-1 text-xs text-gray-500">Valor cobrado do paciente</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor Profissional (R$) *</label>
                                        <input type="number" id="esp-professional-value" required step="0.01" min="0"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="75.00">
                                        <p class="mt-1 text-xs text-gray-500">Repasse ao profissional</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit"
                                class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto">
                                Salvar
                            </button>
                            <button type="button" onclick="closeModalEspecialidade()"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Profissional -->
    <div id="modal-profissional" class="relative z-[100]" style="display: none;">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                    <form id="form-profissional">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4" id="profissional-title">Novo Profissional</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
                                        <input type="text" id="prof-name" required
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="Dr. João Silva">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="prof-email"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="joao@clinica.com">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                        <input type="tel" id="prof-phone"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="(11) 98765-4321">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
                                        <input type="text" id="prof-cpf"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="000.000.000-00">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Especialidades e Repasses</label>
                                    <div id="prof-specialties-container" class="space-y-2">
                                        <!-- Especialidades injetadas via JS -->
                                    </div>
                                    <button type="button" onclick="addSpecialtyToProf()"
                                        class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                                        + Adicionar Especialidade
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit"
                                class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto">
                                Salvar
                            </button>
                            <button type="button" onclick="closeModalProfissional()"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Atualizar Status Atendimento -->
    <div id="modal-status" class="relative z-[100]" style="display: none;">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <form id="form-status">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4">Atualizar Status do Atendimento</h3>
                            <div class="space-y-4">
                                <div id="status-info" class="bg-gray-50 p-3 rounded-md text-sm">
                                    <!-- Info do atendimento -->
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Novo Status *</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                                            <input type="radio" name="status" value="present" class="mr-3">
                                            <div>
                                                <div class="font-medium text-green-700">Presente</div>
                                                <div class="text-xs text-gray-500">Paciente compareceu - valores serão gerados</div>
                                            </div>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                                            <input type="radio" name="status" value="absent" class="mr-3">
                                            <div>
                                                <div class="font-medium text-red-700">Ausente</div>
                                                <div class="text-xs text-gray-500">Faltou sem avisar - valores serão gerados</div>
                                            </div>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-md cursor-pointer hover:bg-gray-50">
                                            <input type="radio" name="status" value="cancelled" class="mr-3">
                                            <div>
                                                <div class="font-medium text-yellow-700">Cancelado</div>
                                                <div class="text-xs text-gray-500">Com aviso/atestado - SEM cobrança</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div id="cancel-reason-container" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Motivo do Cancelamento</label>
                                    <textarea id="status-cancel-reason" rows="2"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        placeholder="Descreva o motivo..."></textarea>
                                    <label class="flex items-center mt-2">
                                        <input type="checkbox" id="status-medical-cert" class="rounded border-gray-300">
                                        <span class="ml-2 text-sm text-gray-700">Possui atestado médico</span>
                                    </label>
                                </div>
                                <div id="financial-preview" class="bg-blue-50 p-3 rounded-md" style="display: none;">
                                    <p class="text-sm font-medium text-blue-900 mb-2">Valores que serão gerados:</p>
                                    <div class="text-sm space-y-1">
                                        <div>Cobrança do Paciente: <span class="font-semibold" id="preview-patient-value">R$ 0,00</span></div>
                                        <div>Repasse ao Profissional: <span class="font-semibold" id="preview-prof-value">R$ 0,00</span></div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                                    <textarea id="status-notes" rows="2"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        placeholder="Observações adicionais..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit"
                                class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto">
                                Confirmar
                            </button>
                            <button type="button" onclick="closeModalStatus()"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Paciente -->
    <div id="modal-paciente" class="relative z-[100]" style="display: none;">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                    <form id="form-paciente">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4" id="paciente-title">Novo Paciente</h3>
                            
                            <!-- Tabs -->
                            <div class="border-b border-gray-200 mb-4">
                                <nav class="-mb-px flex space-x-8" id="patient-tabs">
                                    <button type="button" onclick="switchPatientTab('dados')" 
                                        class="patient-tab-btn border-blue-500 text-blue-600 whitespace-nowrap border-b-2 py-2 px-1 text-sm font-medium"
                                        data-tab="dados">
                                        Dados Pessoais
                                    </button>
                                    <button type="button" onclick="switchPatientTab('valores')" 
                                        class="patient-tab-btn border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-2 px-1 text-sm font-medium"
                                        data-tab="valores">
                                        Valores e Descontos
                                    </button>
                                    <button type="button" onclick="switchPatientTab('pacotes')" 
                                        class="patient-tab-btn border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-2 px-1 text-sm font-medium"
                                        data-tab="pacotes">
                                        Pacotes
                                    </button>
                                </nav>
                            </div>

                            <!-- Tab: Dados Pessoais -->
                            <div id="patient-tab-dados" class="patient-tab-content">
                                <input type="hidden" id="patient-id">
                                <div class="space-y-4">
                                    <h4 class="text-md font-medium text-gray-800 border-b pb-2">Informações do Paciente</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
                                            <input type="text" id="patient-name" required
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                                placeholder="Nome do paciente">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Data de Nascimento *</label>
                                            <input type="date" id="patient-birthdate" required
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                    </div>
                                    
                                    <h4 class="text-md font-medium text-gray-800 border-b pb-2 pt-4">Responsável</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Responsável *</label>
                                            <input type="text" id="resp-name" required
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                                placeholder="Nome do responsável">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Telefone (WhatsApp) *</label>
                                            <input type="tel" id="resp-phone" required
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                                placeholder="(11) 98765-4321">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                            <input type="email" id="resp-email"
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                                placeholder="email@exemplo.com">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
                                            <input type="text" id="resp-cpf"
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                                placeholder="000.000.000-00">
                                        </div>
                                    </div>
                                    
                                    <h4 class="text-md font-medium text-gray-800 border-b pb-2 pt-4">Endereço</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Logradouro</label>
                                            <input type="text" id="patient-address"
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                                placeholder="Rua, Av., etc.">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Número</label>
                                            <input type="text" id="patient-number"
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                                placeholder="123">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Bairro</label>
                                            <input type="text" id="patient-neighborhood"
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
                                            <input type="text" id="patient-city"
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                                            <input type="text" id="patient-state" maxlength="2"
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                                placeholder="SP">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                        <select id="patient-status" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="active">Ativo</option>
                                            <option value="inactive">Inativo</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: Valores e Descontos -->
                            <div id="patient-tab-valores" class="patient-tab-content" style="display: none;">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Desconto Global (%)</label>
                                        <input type="number" id="patient-discount" min="0" max="100" step="1" value="0"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                            placeholder="0">
                                        <p class="mt-1 text-sm text-gray-500">Desconto aplicado em todas as especialidades</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Valores Customizados por Especialidade</label>
                                        <div id="custom-values-container" class="space-y-2">
                                            <!-- Valores customizados injetados via JS -->
                                        </div>
                                        <button type="button" onclick="addCustomValue()"
                                            class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                                            + Adicionar Valor Customizado
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: Pacotes -->
                            <div id="patient-tab-pacotes" class="patient-tab-content" style="display: none;">
                                <div class="space-y-4">
                                    <div id="packages-container" class="space-y-3">
                                        <!-- Pacotes injetados via JS -->
                                    </div>
                                    <button type="button" onclick="addPackage()"
                                        class="w-full py-2 px-4 border border-dashed border-gray-300 rounded-md text-sm text-gray-600 hover:border-blue-500 hover:text-blue-600">
                                        + Adicionar Pacote
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit"
                                class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto">
                                Salvar
                            </button>
                            <button type="button" onclick="closeModalPaciente()"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Agendamento -->
    <div id="modal-agendamento" class="relative z-[100]" style="display: none;">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <form id="form-agendamento">
                        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4" id="agendamento-title">Novo Agendamento</h3>
                            <input type="hidden" id="appt-id">
                            
                            <div class="space-y-4">
                                <!-- Seleção de Paciente -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Paciente *</label>
                                    <select id="appt-patient" required
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Selecione um paciente...</option>
                                    </select>
                                </div>

                                <!-- Seleção de Especialidade -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Especialidade *</label>
                                    <select id="appt-specialty" required
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Selecione uma especialidade...</option>
                                    </select>
                                </div>

                                <!-- Seleção de Profissional -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Profissional *</label>
                                    <select id="appt-professional" required
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Selecione um profissional...</option>
                                    </select>
                                    <p class="mt-1 text-xs text-gray-500" id="appt-professional-hint">
                                        Selecione uma especialidade primeiro
                                    </p>
                                </div>

                                <!-- Data e Horário -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Data *</label>
                                        <input type="date" id="appt-date" required
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Horário *</label>
                                        <input type="time" id="appt-time" required
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                </div>

                                <!-- Duração (baseada na especialidade) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Duração</label>
                                    <input type="text" id="appt-duration" readonly
                                        class="w-full rounded-md border-gray-300 bg-gray-50 shadow-sm"
                                        placeholder="Selecione uma especialidade">
                                </div>

                                <!-- Preview de Conflitos -->
                                <div id="appt-conflicts" class="hidden p-3 bg-red-50 border border-red-200 rounded-md">
                                    <div class="flex items-start">
                                        <svg class="h-5 w-5 text-red-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                        </svg>
                                        <p class="ml-2 text-sm text-red-700" id="appt-conflicts-text"></p>
                                    </div>
                                </div>

                                <!-- Observações -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                                    <textarea id="appt-notes" rows="2"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        placeholder="Observações sobre o agendamento..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit"
                                class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto">
                                Agendar
                            </button>
                            <button type="button" onclick="closeModalAgendamento()"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay Global -->
    <div id="global-loader" class="fixed inset-0 z-[200] flex items-center justify-center bg-white bg-opacity-75" style="display: none;">
        <div class="flex flex-col items-center">
            <svg class="h-12 w-12 animate-spin text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="mt-4 text-lg font-medium text-gray-700">Carregando...</span>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- MODAL: HORARIOS FIXOS                                                   -->
    <!-- ====================================================================== -->
    <div id="modal-horario-fixo" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 flex items-center justify-between rounded-t-xl">
                <div class="flex items-center gap-3">
                    <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                    <h2 id="modal-horario-fixo-title" class="text-xl font-bold">Novo Horário Fixo</h2>
                </div>
                <button onclick="closeModalHorarioFixo()" class="text-white hover:text-gray-200 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Formulário -->
            <form id="form-horario-fixo" class="p-6">
                <input type="hidden" id="fixed-schedule-id">
                
                <div class="space-y-5">
                    <!-- Especialidade -->
                    <div>
                        <label for="fixed-specialty" class="block text-sm font-semibold text-gray-700 mb-2">
                            Especialidade *
                        </label>
                        <select id="fixed-specialty" required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <option value="">Selecione...</option>
                        </select>
                    </div>

                    <!-- Profissional -->
                    <div>
                        <label for="fixed-professional" class="block text-sm font-semibold text-gray-700 mb-2">
                            Profissional *
                        </label>
                        <select id="fixed-professional" required disabled
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="">Selecione uma especialidade primeiro</option>
                        </select>
                        <p id="fixed-prof-hint" class="mt-1 text-xs text-gray-500"></p>
                    </div>

                    <!-- Dia da Semana -->
                    <div>
                        <label for="fixed-day-of-week" class="block text-sm font-semibold text-gray-700 mb-2">
                            Dia da Semana *
                        </label>
                        <select id="fixed-day-of-week" required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <option value="">Selecione...</option>
                            <option value="0">Domingo</option>
                            <option value="1">Segunda-feira</option>
                            <option value="2">Terça-feira</option>
                            <option value="3">Quarta-feira</option>
                            <option value="4">Quinta-feira</option>
                            <option value="5">Sexta-feira</option>
                            <option value="6">Sábado</option>
                        </select>
                    </div>

                    <!-- Horário de Início -->
                    <div>
                        <label for="fixed-start-time" class="block text-sm font-semibold text-gray-700 mb-2">
                            Horário de Início *
                        </label>
                        <input type="time" id="fixed-start-time" required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>

                    <!-- Duração (calculada) -->
                    <div>
                        <label for="fixed-duration" class="block text-sm font-semibold text-gray-700 mb-2">
                            Duração
                        </label>
                        <input type="text" id="fixed-duration" readonly
                            class="w-full px-4 py-2.5 border border-gray-200 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                            placeholder="Selecione a especialidade para calcular">
                    </div>

                    <!-- Status Ativo -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label for="fixed-active" class="text-sm font-semibold text-gray-700">
                                Horário Ativo
                            </label>
                            <p class="text-xs text-gray-500 mt-1">
                                Horários ativos serão usados para gerar agendamentos automaticamente
                            </p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="fixed-active" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <!-- Observações -->
                    <div>
                        <label for="fixed-notes" class="block text-sm font-semibold text-gray-700 mb-2">
                            Observações
                        </label>
                        <textarea id="fixed-notes" rows="3"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"
                            placeholder="Informações adicionais sobre este horário fixo..."></textarea>
                    </div>
                </div>

                <!-- Botões -->
                <div class="flex gap-3 mt-6 pt-4 border-t">
                    <button type="button" onclick="closeModalHorarioFixo()"
                        class="flex-1 px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-lg shadow-blue-500/30">
                        Salvar Horário
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Gestão de Usuário -->
    <div id="modal-usuario" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-4 flex items-center justify-between rounded-t-xl">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6" data-lucide="user-cog"></svg>
                    <h2 id="modal-usuario-title" class="text-xl font-bold">Novo Usuário</h2>
                </div>
                <button onclick="closeModalUsuario()" class="text-white hover:text-gray-200 transition-colors">
                    <svg class="w-6 h-6" data-lucide="x"></svg>
                </button>
            </div>

            <!-- Formulário -->
            <form id="form-usuario" class="p-6">
                <input type="hidden" id="user-id">
                
                <div class="space-y-5">
                    <!-- Nome -->
                    <div>
                        <label for="user-name" class="block text-sm font-semibold text-gray-700 mb-2">
                            Nome Completo *
                        </label>
                        <input type="text" id="user-name" required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                            placeholder="Digite o nome completo">
                    </div>

                    <!-- Email -->
                    <div>
                        <label for="user-email" class="block text-sm font-semibold text-gray-700 mb-2">
                            Email *
                        </label>
                        <input type="email" id="user-email" required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                            placeholder="email@exemplo.com">
                        <p class="mt-1 text-xs text-gray-500">Será usado para login no sistema</p>
                    </div>

                    <!-- Senha (apenas para novo usuário) -->
                    <div id="password-container">
                        <label for="user-password" class="block text-sm font-semibold text-gray-700 mb-2">
                            Senha *
                        </label>
                        <input type="password" id="user-password"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                            placeholder="Mínimo 6 caracteres">
                        <p class="mt-1 text-xs text-gray-500">Deixe em branco para manter a senha atual (apenas ao editar)</p>
                    </div>

                    <!-- Função -->
                    <div>
                        <label for="user-role" class="block text-sm font-semibold text-gray-700 mb-2">
                            Função no Sistema *
                        </label>
                        <select id="user-role" required
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                            <option value="">Selecione...</option>
                            <option value="administrator">Administrador</option>
                            <option value="reception">Recepção</option>
                            <option value="therapist">Terapeuta</option>
                        </select>
                        <div class="mt-2 space-y-1 text-xs text-gray-600">
                            <p><strong>Administrador:</strong> Acesso total ao sistema</p>
                            <p><strong>Recepção:</strong> Gestão de agendamentos e pacientes</p>
                            <p><strong>Terapeuta:</strong> Visualização de agenda própria e atendimentos</p>
                        </div>
                    </div>

                    <!-- Telefone -->
                    <div>
                        <label for="user-phone" class="block text-sm font-semibold text-gray-700 mb-2">
                            Telefone
                        </label>
                        <input type="tel" id="user-phone"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                            placeholder="(00) 00000-0000">
                    </div>

                    <!-- CPF -->
                    <div>
                        <label for="user-cpf" class="block text-sm font-semibold text-gray-700 mb-2">
                            CPF
                        </label>
                        <input type="text" id="user-cpf"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                            placeholder="000.000.000-00">
                    </div>

                    <!-- Profissional Vinculado (apenas para terapeutas) -->
                    <div id="professional-link-container" class="hidden">
                        <label for="user-professional-id" class="block text-sm font-semibold text-gray-700 mb-2">
                            Vincular a Profissional
                        </label>
                        <select id="user-professional-id"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                            <option value="">Nenhum</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500">Vincule este usuário a um cadastro de profissional existente</p>
                    </div>

                    <!-- Status -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label for="user-active" class="text-sm font-semibold text-gray-700">
                                Usuário Ativo
                            </label>
                            <p class="text-xs text-gray-500 mt-1">
                                Usuários inativos não poderão fazer login no sistema
                            </p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="user-active" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>
                </div>

                <!-- Aviso importante -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mt-6">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-2" data-lucide="info"></svg>
                        <div class="text-sm text-blue-800">
                            <p class="font-semibold mb-1">Nota sobre criação de usuários:</p>
                            <p class="text-xs">Em produção, a criação de novos usuários deve ser feita via Firebase Authentication. Este formulário cria apenas o registro no banco de dados. Configure Cloud Functions para automatizar o processo completo.</p>
                        </div>
                    </div>
                </div>

                <!-- Botões -->
                <div class="flex gap-3 mt-6 pt-4 border-t">
                    <button type="button" onclick="closeModalUsuario()"
                        class="flex-1 px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium shadow-lg shadow-purple-500/30">
                        Salvar Usuário
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- ====================================================================== -->
    <!-- JAVASCRIPT APLICACAO                                                     -->
    <!-- ====================================================================== -->
    <script type="module">
    
        // --- VIRTUAL FILE: firebaseConfig.js ---
        // SDKs do Firebase (Modular v9+)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            onValue, 
            push, 
            update, 
            query, 
            orderByChild, 
            equalTo, 
            serverTimestamp,
            off
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // !!! IMPORTANTE !!!
        // Configuração do Firebase - Clínica Singular
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBwsw9ahi73ylE8KSOqsIzUuiZDsyyYHrg",
            authDomain: "clinicasingular-folha.firebaseapp.com",
            databaseURL: "https://clinicasingular-folha-default-rtdb.firebaseio.com",
            projectId: "clinicasingular-folha",
            storageBucket: "clinicasingular-folha.firebasestorage.app",
            messagingSenderId: "556191358983",
            appId: "1:556191358983:web:dd2992c59d91b91aeecaa2",
            measurementId: "G-EM9F8SBCRE"
        };
        
        // Inicializa Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
            console.log("Firebase inicializado com sucesso.");
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            document.body.innerHTML = `<div class="p-8 text-center text-red-600">
                <h1 class="text-2xl font-bold">Erro na Configuração</h1>
                <p class="mt-4">Não foi possível inicializar o Firebase. Verifique se o objeto 'firebaseConfig' no 
                início do script <pre>index.html</pre> está correto. Copie e cole a configuração do seu projeto Firebase.</p>
                <p class="mt-2 text-sm text-gray-500">${error.message}</p>
            </div>`;
        }

        /* ========================================================================
           INSTRUÇÕES PARA CRIAR USUÁRIOS NO FIREBASE
           ========================================================================
           
           Para criar os 3 usuários de teste no Firebase, siga os passos:
           
           1. Acesse o Firebase Console: https://console.firebase.google.com/
           2. Selecione o projeto "clinicasingular-folha"
           3. No menu lateral, vá em "Authentication" > "Users"
           4. Clique em "Add user" e crie os seguintes usuários:
           
           USUÁRIO 1 - ADMINISTRADOR:
           - Email: admin@clinicasingular.com
           - Senha: Admin@123
           
           USUÁRIO 2 - PSICÓLOGO:
           - Email: psicologo@clinicasingular.com
           - Senha: Psi@123
           
           USUÁRIO 3 - SECRETÁRIO:
           - Email: secretario@clinicasingular.com
           - Senha: Sec@123
           
           5. Após criar os usuários na aba Authentication, vá em "Realtime Database"
           6. Na estrutura do banco, adicione os perfis dos usuários em "users/":
           
           users/
             {uid-do-admin}/
               email: "admin@clinicasingular.com"
               name: "Admin"
               role: "administrator"
               status: "active"
               createdAt: {timestamp atual}
             
             {uid-do-psicologo}/
               email: "psicologo@clinicasingular.com"
               name: "Psicólogo"
               role: "therapist"
               status: "active"
               createdAt: {timestamp atual}
             
             {uid-do-secretario}/
               email: "secretario@clinicasingular.com"
               name: "Secretário"
               role: "reception"
               status: "active"
               createdAt: {timestamp atual}
           
           NOTA: Substitua {uid-do-admin}, {uid-do-psicologo}, {uid-do-secretario} 
           pelos UIDs reais que o Firebase gerou ao criar cada usuário.
           
           ROLES DISPONÍVEIS:
           - administrator: Acesso total ao sistema
           - therapist: Acesso a agenda e pacientes (visualização)
           - reception: Acesso a agenda, pacientes e financeiro
           
        ======================================================================== */

        // --- VIRTUAL FILE: offlineSync.js ---
        // (usando 'idb' importado globalmente)
        const { openDB } = idb;
        const DB_NAME = 'clinic-singular-db';
        const DB_VERSION = 1;
        const SYNC_QUEUE_STORE = 'syncQueue';
        
        let offlineDbPromise;

        function initOfflineDb() {
            if (!offlineDbPromise) {
                offlineDbPromise = openDB(DB_NAME, DB_VERSION, {
                    upgrade(db) {
                        if (!db.objectStoreNames.contains(SYNC_QUEUE_STORE)) {
                            db.createObjectStore(SYNC_QUEUE_STORE, { keyPath: 'id', autoIncrement: true });
                        }
                        // Outras stores para cache (ex: pacientes) podem ser criadas aqui
                    },
                });
            }
            return offlineDbPromise;
        }
        
        /**
         * Reseta o banco de dados offline em caso de erro crítico.
         * ATENÇÃO: Esta função apaga todos os dados offline não sincronizados!
         */
        async function resetOfflineDb() {
            try {
                const dbs = await indexedDB.databases();
                const dbExists = dbs.find(db => db.name === DB_NAME);
                if (dbExists) {
                    indexedDB.deleteDatabase(DB_NAME);
                    console.log('Banco de dados offline resetado.');
                }
                offlineDbPromise = null;
                await initOfflineDb();
            } catch (error) {
                console.error('Erro ao resetar banco offline:', error);
            }
        }
        
        /**
         * Adiciona uma ação à fila de sincronização offline.
         * @param {string} action - Tipo da ação (ex: 'CREATE_PATIENT', 'UPDATE_ATTENDANCE')
         * @param {object} payload - Dados necessários para executar a ação
         */
        async function addToSyncQueue(action, payload) {
            try {
                const db = await initOfflineDb();
                const tx = db.transaction(SYNC_QUEUE_STORE, 'readwrite');
                await tx.store.add({
                    action,
                    payload,
                    timestamp: new Date().toISOString()
                });
                await tx.done;
                console.log(`Ação ${action} adicionada à fila offline.`);
                updateSyncStatus('offline', 'Fila pendente');
                // Tenta sincronizar imediatamente se estiver online
                if (navigator.onLine) {
                    processSyncQueue();
                }
            } catch (error) {
                console.error("Erro ao adicionar à fila de sincronização:", error);
            }
        }

        /**
         * Processa a fila de sincronização pendente.
         */
        async function processSyncQueue() {
            if (!navigator.onLine) {
                console.log("Offline. Sincronização pausada.");
                updateSyncStatus('offline', 'Offline');
                return;
            }

            if (syncStatus === 'syncing') {
                console.log("Sincronização já em progresso.");
                return;
            }

            updateSyncStatus('syncing', 'Sincronizando...');

            try {
                const db = await initOfflineDb();
                const tx = db.transaction(SYNC_QUEUE_STORE, 'readwrite');
                const store = tx.store;
                let cursor = await store.openCursor(); // Pega o cursor sem usar índice

                if (!cursor) {
                    console.log("Fila de sincronização vazia.");
                    updateSyncStatus('synced', 'Sincronizado');
                    return;
                }

                while (cursor) {
                    const { id, action, payload } = cursor.value;
                    console.log(`Processando item ${id}: ${action}`);

                    try {
                        // Lógica de execução da ação
                        // Esta é a parte complexa que precisa mapear 'action' para uma função do Firebase
                        switch (action) {
                            case 'CREATE_PATIENT':
                                // Exemplo:
                                // const newPatientRef = push(ref(db, 'patients'));
                                // await set(newPatientRef, payload);
                                console.log('Sincronizando CREATE_PATIENT (simulado)', payload);
                                break;
                            case 'UPDATE_ATTENDANCE':
                                // Exemplo:
                                // const { appointmentId, data } = payload;
                                // const apptRef = ref(db, `appointments/${appointmentId}`);
                                // await update(apptRef, data);
                                console.log('Sincronizando UPDATE_ATTENDANCE (simulado)', payload);
                                break;
                            // ... outros casos
                            default:
                                console.warn(`Ação desconhecida na fila: ${action}`);
                        }

                        // Se teve sucesso, remove da fila
                        await store.delete(id);
                        console.log(`Item ${id} sincronizado e removido.`);
                        
                        cursor = await cursor.continue();

                    } catch (error) {
                        console.error(`Erro ao sincronizar item ${id} (${action}):`, error);
                        // Decide o que fazer em caso de erro
                        // Parar? Tentar de novo? Marcar como 'com erro'?
                        // Por enquanto, paramos para evitar perda de dados
                        updateSyncStatus('error', 'Erro ao sincronizar');
                        return; // Para o processamento
                    }
                }
                
                await tx.done;
                console.log("Fila de sincronização processada com sucesso.");
                updateSyncStatus('synced', 'Sincronizado');

            } catch (error) {
                console.error("Erro grave no processamento da fila de sincronização:", error);
                updateSyncStatus('error', 'Erro na fila');
                
                // Se for um erro de estrutura do IndexedDB, sugerir reset
                if (error.name === 'NotFoundError' || error.code === 8) {
                    console.warn('Erro de estrutura do IndexedDB detectado. Execute resetOfflineDb() no console para corrigir.');
                }
            }
        }
        
        // --- VIRTUAL FILE: utils.js ---
        
        // Estado global da UI
        let currentModal = {
            primaryAction: null,
            secondaryAction: null
        };
        let syncStatus = 'synced'; // synced, syncing, offline, error
        
        // Elementos da DOM (cache)
        const $ = (selector) => document.querySelector(selector);
        
        const $globalLoader = $('#global-loader');
        const $loginView = $('#login-view');
        const $appView = $('#app-view');
        const $loginForm = $('#login-form');
        const $loginError = $('#login-error');
        const $logoutButton = $('#logout-button');
        const $mobileLogoutButton = $('#mobile-logout-button');
        
        const $syncStatusEl = $('#sync-status');
        const $syncIcon = $('#sync-icon');
        const $syncText = $('#sync-text');
        
        const $sidebar = $('#sidebar');
        const $mobileMenu = $('#mobile-menu');
        const $mobileMenuButton = $('#mobile-menu-button');
        const $mobileMenuClose = $('#mobile-menu-close');
        const $mobileMenuOverlay = $('#mobile-menu-overlay');

        const $modalContainer = $('#modal-container');
        const $modalTitle = $('#modal-title');
        const $modalContent = $('#modal-content');
        const $modalIcon = $('#modal-icon');
        const $modalPrimaryBtn = $('#modal-primary-btn');
        const $modalSecondaryBtn = $('#modal-secondary-btn');
        
        const $pageTitle = $('#page-title');

        /**
         * Exibe o overlay de carregamento global.
         */
        function showGlobalLoader() {
            $globalLoader.style.display = 'flex';
        }

        /**
         * Oculta o overlay de carregamento global.
         */
        function hideGlobalLoader() {
            $globalLoader.style.display = 'none';
        }

        /**
         * Atualiza o indicador de status da sincronização.
         * @param {'synced'|'syncing'|'offline'|'error'} status
         * @param {string} text
         */
        function updateSyncStatus(status, text) {
            syncStatus = status;
            $syncText.textContent = text;
            
            // Lista de todas as classes de status possíveis
            const statusClasses = ['sync-synced', 'sync-syncing', 'sync-offline', 'sync-error', 'animate-spin'];
            
            // Remove todas as classes de status anteriores
            $syncStatusEl.classList.remove(...statusClasses);
            
            let iconName = 'wifi';
            let classesToAdd = ['sync-synced']; // Agora é um array

            switch (status) {
                case 'synced':
                    iconName = 'check-circle';
                    classesToAdd = ['sync-synced'];
                    break;
                case 'syncing':
                    iconName = 'refresh-cw';
                    classesToAdd = ['sync-syncing', 'animate-spin']; // Separado
                    break;
                case 'offline':
                    iconName = 'wifi-off';
                    classesToAdd = ['sync-offline'];
                    break;
                case 'error':
                    iconName = 'alert-triangle';
                    classesToAdd = ['sync-error'];
                    break;
            }
            
            $syncIcon.setAttribute('data-lucide', iconName);
            // Adiciona as novas classes
            $syncStatusEl.classList.add(...classesToAdd); // Usando spread
            
            lucide.createIcons({
                nodes: [$syncIcon]
            });
        }
        
        /**
         * Exibe o modal genérico.
         * @param {object} options
         * @param {string} options.title - Título do modal.
         * @param {string} options.contentHtml - HTML a ser injetado no corpo.
         * @param {string} [options.icon='info'] - Ícone (lucide).
         * @param {string} [options.primaryText='Salvar'] - Texto do botão primário.
         * @param {string} [options.secondaryText='Cancelar'] - Texto do botão secundário.
         * @param {function} [options.onPrimaryClick] - Callback do botão primário.
         * @param {function} [options.onSecondaryClick] - Callback do botão secundário.
         */
        function showModal({ 
            title, 
            contentHtml, 
            icon = 'info', 
            primaryText = 'Salvar', 
            secondaryText = 'Cancelar',
            tertiaryText = null,
            tertiaryClass = 'bg-red-600 hover:bg-red-700 text-white',
            onPrimaryClick = null,
            onSecondaryClick = null,
            onTertiaryClick = null,
            hideSecondary = false
        }) {
            $modalTitle.textContent = title;
            $modalContent.innerHTML = contentHtml;
            $modalIcon.innerHTML = `<svg class="h-6 w-6 text-blue-600" data-lucide="${icon}"></svg>`;
            lucide.createIcons({ nodes: [$modalIcon.firstElementChild] });

            // Remove listeners antigos clonando os botões
            $modalPrimaryBtn.replaceWith($modalPrimaryBtn.cloneNode(true));
            $modalSecondaryBtn.replaceWith($modalSecondaryBtn.cloneNode(true));
            
            // Reatribui botões ao DOM
            const newPrimaryBtn = $('#modal-primary-btn');
            const newSecondaryBtn = $('#modal-secondary-btn');
            
            // Define os textos DEPOIS de clonar
            newPrimaryBtn.textContent = primaryText || 'Salvar';
            
            // Gerenciar botão secundário
            if (hideSecondary || !secondaryText) {
                newSecondaryBtn.style.display = 'none';
            } else {
                newSecondaryBtn.textContent = secondaryText;
                newSecondaryBtn.style.display = 'inline-flex';
            }

            if (onPrimaryClick) {
                newPrimaryBtn.style.display = 'inline-flex';
                newPrimaryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onPrimaryClick();
                });
            } else {
                newPrimaryBtn.style.display = 'none';
            }
            
            if (onSecondaryClick && !hideSecondary && secondaryText) {
                newSecondaryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onSecondaryClick();
                });
            } else if (!hideSecondary && secondaryText) {
                // O padrão é fechar
                newSecondaryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    hideModal();
                });
            }
            
            // Gerenciar botão terciário (se existir)
            let tertiaryBtn = $('#modal-tertiary-btn');
            if (!tertiaryBtn) {
                // Criar botão terciário se não existir
                tertiaryBtn = document.createElement('button');
                tertiaryBtn.id = 'modal-tertiary-btn';
                tertiaryBtn.className = 'px-4 py-2 rounded-md font-medium';
                newSecondaryBtn.parentNode.insertBefore(tertiaryBtn, newSecondaryBtn);
            }
            
            if (tertiaryText && onTertiaryClick) {
                tertiaryBtn.textContent = tertiaryText;
                tertiaryBtn.className = `px-4 py-2 rounded-md font-medium ${tertiaryClass}`;
                tertiaryBtn.style.display = 'inline-flex';
                // Remove listener antigo
                tertiaryBtn.replaceWith(tertiaryBtn.cloneNode(true));
                tertiaryBtn = $('#modal-tertiary-btn');
                tertiaryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onTertiaryClick();
                });
            } else {
                tertiaryBtn.style.display = 'none';
            }

            $modalContainer.style.display = 'block';
        }
        
        /**
         * Oculta o modal genérico.
         */
        function hideModal() {
            $modalContainer.style.display = 'none';
            $modalTitle.textContent = '';
            $modalContent.innerHTML = '';
        }

        /**
         * Exibe um alerta simples usando o modal.
         * @param {string} title
         * @param {string} message
         * @param {'info'|'warning'|'error'} type
         */
        function showAlert(title, message, type = 'info') {
            let icon = 'info';
            if (type === 'warning') icon = 'alert-triangle';
            if (type === 'error') icon = 'alert-circle';

            showModal({
                title,
                contentHtml: `<p>${message}</p>`,
                icon,
                primaryText: 'OK',
                onPrimaryClick: hideModal,
                secondaryText: 'Fechar',
                onSecondaryClick: hideModal
            });
            // Esconde o botão 'Fechar' para um alerta simples
            $('#modal-secondary-btn').style.display = 'none';
        }
        
        /**
         * Adiciona funcionalidade de duplo clique para fechar modal.
         * @param {HTMLElement} modalElement - Elemento do modal
         * @param {function} closeFunction - Função para fechar o modal
         */
        function addDoubleClickToCloseModal(modalElement, closeFunction) {
            let clickCount = 0;
            let clickTimer = null;
            
            modalElement.addEventListener('click', (e) => {
                // Só conta cliques no overlay (background), não no conteúdo do modal
                if (e.target === modalElement || 
                    e.target.classList.contains('bg-opacity-75') ||
                    e.target.classList.contains('bg-opacity-50') ||
                    e.target.classList.contains('bg-black')) {
                    clickCount++;
                    
                    // Se for o primeiro clique, inicia o timer
                    if (clickCount === 1) {
                        clickTimer = setTimeout(() => {
                            clickCount = 0;
                        }, 500); // 500ms para considerar duplo clique
                    }
                    
                    // Se for o segundo clique dentro do tempo, fecha o modal
                    if (clickCount === 2) {
                        closeFunction();
                        clickCount = 0;
                        if (clickTimer) {
                            clearTimeout(clickTimer);
                            clickTimer = null;
                        }
                    }
                }
            });
        }
        
        /**
         * Exibe um diálogo de confirmação usando o modal.
         * @param {string} title
         * @param {string} message
         * @returns {Promise<boolean>}
         */
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                showModal({
                    title,
                    contentHtml: `<p>${message}</p>`,
                    icon: 'help-circle',
                    primaryText: 'Confirmar',
                    secondaryText: 'Cancelar',
                    onPrimaryClick: () => {
                        hideModal();
                        resolve(true);
                    },
                    onSecondaryClick: () => {
                        hideModal();
                        resolve(false);
                    }
                });
            });
        }
        
        /**
         * Formata data (ex: 2024-10-30T10:00:00Z -> 30/10/2024)
         * @param {string | Date} dateInput
         * @returns {string}
         */
        function formatDate(dateInput) {
            if (!dateInput) return 'N/A';
            try {
                const date = new Date(dateInput);
                return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' }); // UTC para evitar off-by-one
            } catch (e) {
                return 'Data inválida';
            }
        }
        
        /**
         * Formata data e hora (ex: -> 30/10/2024 10:30)
         * @param {string | Date} dateInput
         * @returns {string}
         */
        function formatDateTime(dateInput) {
            if (!dateInput) return 'N/A';
            try {
                const date = new Date(dateInput);
                return date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return 'Data inválida';
            }
        }


        // --- VIRTUAL FILE: modals.js ---
        
        // Cache de dados para modais
        let allSpecialties = [];
        let allSpecialtiesCache = []; // Alias para compatibilidade
        let currentEditingId = null;
        let currentAppointmentData = null;

        // ===== ESPECIALIDADES =====
        
        async function loadAllSpecialties() {
            try {
                const specialtiesRef = ref(db, 'specialties');
                const snapshot = await get(specialtiesRef);
                allSpecialties = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    allSpecialties = Object.keys(data).map(id => ({
                        id,
                        ...data[id]
                    })).filter(s => s.active !== false);
                    allSpecialtiesCache = allSpecialties; // Sincronizar cache
                } else {
                    allSpecialtiesCache = [];
                }
                return allSpecialties;
            } catch (error) {
                console.error("Erro ao carregar especialidades:", error);
                return [];
            }
        }

        function openModalEspecialidade(especialidadeId = null, especialidadeData = null) {
            currentEditingId = especialidadeId;
            const modal = $('#modal-especialidade');
            const title = $('#especialidade-title');
            
            // Resetar formulário primeiro
            $('#form-especialidade').reset();
            
            if (especialidadeId && especialidadeData) {
                title.textContent = 'Editar Especialidade';
                $('#esp-name').value = especialidadeData.name || '';
                $('#esp-description').value = especialidadeData.description || '';
                $('#esp-patient-value').value = especialidadeData.patientValue || especialidadeData.defaultValue || '';
                $('#esp-professional-value').value = especialidadeData.professionalValue || (especialidadeData.defaultValue ? especialidadeData.defaultValue * 0.5 : '') || '';
            } else if (especialidadeId) {
                // Fallback: buscar dos dados em cache
                title.textContent = 'Editar Especialidade';
                const especialidade = allSpecialties.find(e => e.id === especialidadeId);
                if (especialidade) {
                    $('#esp-name').value = especialidade.name || '';
                    $('#esp-description').value = especialidade.description || '';
                    $('#esp-patient-value').value = especialidade.patientValue || especialidade.defaultValue || '';
                    $('#esp-professional-value').value = especialidade.professionalValue || (especialidade.defaultValue ? especialidade.defaultValue * 0.5 : '') || '';
                }
            } else {
                title.textContent = 'Nova Especialidade';
            }
            
            modal.style.display = 'block';
        }

        function closeModalEspecialidade() {
            $('#modal-especialidade').style.display = 'none';
            $('#form-especialidade').reset();
            currentEditingId = null;
        }

        async function saveEspecialidade(event) {
            event.preventDefault();
            showGlobalLoader();
            
            const patientValue = parseFloat($('#esp-patient-value').value);
            const professionalValue = parseFloat($('#esp-professional-value').value);
            
            // Validação adicional
            if (patientValue < professionalValue) {
                hideGlobalLoader();
                showAlert('Atenção', 'O valor do repasse não pode ser maior que o valor do paciente.', 'warning');
                return;
            }
            
            const data = {
                name: $('#esp-name').value.trim(),
                description: $('#esp-description').value.trim(),
                patientValue: patientValue,
                professionalValue: professionalValue,
                active: true,
                updatedAt: Date.now(),
                updatedBy: currentUser.uid
            };

            try {
                let especialidadeId;
                if (currentEditingId) {
                    // Editar
                    especialidadeId = currentEditingId;
                    const especialidadeRef = ref(db, `specialties/${especialidadeId}`);
                    
                    // Buscar dados anteriores para auditoria
                    const oldSnapshot = await get(especialidadeRef);
                    const oldData = oldSnapshot.val();
                    
                    await update(especialidadeRef, data);
                    
                    // Registrar auditoria
                    await logAudit('update', 'specialty', especialidadeId, [
                        { field: 'name', oldValue: oldData.name, newValue: data.name },
                        { field: 'patientValue', oldValue: oldData.patientValue, newValue: data.patientValue },
                        { field: 'professionalValue', oldValue: oldData.professionalValue, newValue: data.professionalValue }
                    ]);
                } else {
                    // Criar
                    const especialidadesRef = ref(db, 'specialties');
                    const newRef = push(especialidadesRef);
                    especialidadeId = newRef.key;
                    data.createdAt = Date.now();
                    data.createdBy = currentUser.uid;
                    
                    await set(newRef, data);
                    
                    // Registrar auditoria
                    await logAudit('create', 'specialty', especialidadeId, []);
                }
                
                hideGlobalLoader();
                closeModalEspecialidade();
                showAlert('Sucesso', 'Especialidade salva com sucesso!', 'info');
                
                // Atualizar página apenas se estivermos na página de especialidades
                if (currentPage === '#/especialidades') {
                    await loadEspecialidadesPage();
                }
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao salvar especialidade:", error);
                showAlert('Erro', 'Não foi possível salvar a especialidade.', 'error');
            }
        }

        // ===== PROFISSIONAIS =====
        
        async function openModalProfissional(professionalId = null, professionalData = null) {
            currentEditingId = professionalId;
            const modal = $('#modal-profissional');
            const title = $('#profissional-title');
            
            // Resetar formulário
            $('#form-profissional').reset();
            
            // Garantir que especialidades estão carregadas
            if (allSpecialties.length === 0) {
                await loadAllSpecialties();
            }
            
            if (professionalId && professionalData) {
                title.textContent = 'Editar Profissional';
                
                // Preencher dados básicos (usando IDs corretos do HTML)
                $('#prof-name').value = professionalData.name || '';
                $('#prof-email').value = professionalData.email || '';
                $('#prof-phone').value = formatPhone(professionalData.phone || '');
                $('#prof-cpf').value = formatCPF(professionalData.cpf || '');
                
                // Preencher especialidades
                const specialtiesArray = professionalData.specialties 
                    ? Object.keys(professionalData.specialties).map(id => {
                        const specData = professionalData.specialties[id];
                        // Se for objeto com repassValue, usar; senão buscar da especialidade
                        if (typeof specData === 'object' && specData.repassValue !== undefined) {
                            return { id, repassValue: specData.repassValue };
                        }
                        // Se for true (formato antigo), retornar apenas o ID
                        return id;
                    })
                    : [];
                
                await renderProfSpecialties(specialtiesArray);
            } else {
                title.textContent = 'Novo Profissional';
                await renderProfSpecialties([]);
            }
            
            modal.style.display = 'block';
        }

        function closeModalProfissional() {
            $('#modal-profissional').style.display = 'none';
            $('#form-profissional').reset();
            currentEditingId = null;
        }

        async function renderProfSpecialties(selectedSpecialties = []) {
            if (allSpecialties.length === 0) {
                await loadAllSpecialties();
            }
            
            const container = $('#prof-specialties-container');
            
            // Converter selectedSpecialties para objetos padronizados
            const specialtiesArray = selectedSpecialties.map(item => {
                if (typeof item === 'string') {
                    // É um ID, buscar a especialidade e pegar o valor de repasse padrão
                    const spec = allSpecialties.find(s => s.id === item);
                    const repassValue = spec?.professionalValue || (spec?.defaultValue ? spec.defaultValue * 0.5 : 0) || 0;
                    return { id: item, name: spec?.name || 'Desconhecida', repassValue };
                } else if (item && typeof item === 'object' && item.id) {
                    // Já é um objeto com id e repassValue
                    const spec = allSpecialties.find(s => s.id === item.id);
                    return { 
                        id: item.id, 
                        name: spec?.name || 'Desconhecida', 
                        repassValue: item.repassValue !== undefined ? item.repassValue : (spec?.professionalValue || 0)
                    };
                }
                // Fallback
                return { id: '', name: 'Erro', repassValue: 0 };
            });
            
            container.innerHTML = specialtiesArray.map((spec, index) => `
                <div class="flex items-center space-x-2 bg-gray-50 p-2 rounded">
                    <select class="flex-1 rounded-md border-gray-300 text-sm" data-spec-select="${index}" onchange="updateRepassFromSpecialty(${index})">
                        <option value="">Selecione...</option>
                        ${allSpecialties.map(s => `
                            <option value="${s.id}" ${s.id === spec.id ? 'selected' : ''}>${s.name}</option>
                        `).join('')}
                    </select>
                    <input type="number" placeholder="R$ Repasse" min="0" step="0.01"
                        class="w-32 rounded-md border-gray-300 text-sm" data-spec-repass="${index}"
                        value="${spec.repassValue || 0}">
                    <button type="button" onclick="removeSpecialtyFromProf(${index})" class="text-red-600 hover:text-red-800">
                        <svg class="h-5 w-5" data-lucide="x"></svg>
                    </button>
                </div>
            `).join('');
            
            lucide.createIcons({ nodes: container });
        }

        function addSpecialtyToProf() {
            const container = $('#prof-specialties-container');
            const currentCount = container.children.length;
            
            const newDiv = document.createElement('div');
            newDiv.className = 'flex items-center space-x-2 bg-gray-50 p-2 rounded';
            newDiv.innerHTML = `
                <select class="flex-1 rounded-md border-gray-300 text-sm" data-spec-select="${currentCount}" onchange="updateRepassFromSpecialty(${currentCount})">
                    <option value="">Selecione...</option>
                    ${allSpecialties.map(s => `
                        <option value="${s.id}">${s.name}</option>
                    `).join('')}
                </select>
                <input type="number" placeholder="R$ Repasse" min="0" step="0.01"
                    class="w-32 rounded-md border-gray-300 text-sm" data-spec-repass="${currentCount}" value="0">
                <button type="button" onclick="removeSpecialtyFromProf(${currentCount})" class="text-red-600 hover:text-red-800">
                    <svg class="h-5 w-5" data-lucide="x"></svg>
                </button>
            `;
            
            container.appendChild(newDiv);
            lucide.createIcons({ nodes: newDiv });
        }

        window.updateRepassFromSpecialty = function(index) {
            const selectElement = document.querySelector(`[data-spec-select="${index}"]`);
            const repassInput = document.querySelector(`[data-spec-repass="${index}"]`);
            
            if (!selectElement || !repassInput) return;
            
            const specialtyId = selectElement.value;
            if (!specialtyId) return;
            
            // Buscar a especialidade selecionada
            const specialty = allSpecialties.find(s => s.id === specialtyId);
            
            console.log('Especialidade selecionada:', specialty);
            
            if (specialty) {
                const professionalValue = specialty.professionalValue || (specialty.defaultValue ? specialty.defaultValue * 0.5 : 0) || 0;
                
                console.log('Valor de repasse encontrado:', professionalValue);
                
                // Usar o valor direto em Reais
                repassInput.value = professionalValue.toFixed(2);
            }
        }

        function removeSpecialtyFromProf(index) {
            const container = $('#prof-specialties-container');
            const divs = Array.from(container.children);
            if (divs[index]) {
                divs[index].remove();
            }
        }

        async function saveProfissional(event) {
            event.preventDefault();
            showGlobalLoader();
            
            // Coletar especialidades selecionadas
            const specialtiesData = {};
            const container = $('#prof-specialties-container');
            const specDivs = container.querySelectorAll('.flex.items-center');
            
            specDivs.forEach((div) => {
                const select = div.querySelector('[data-spec-select]');
                const repassInput = div.querySelector('[data-spec-repass]');
                
                if (select && repassInput) {
                    const specId = select.value;
                    const repassValue = parseFloat(repassInput.value) || 0;
                    
                    if (specId) {
                        // Salvar o valor de repasse em Reais
                        specialtiesData[specId] = { repassValue: repassValue };
                    }
                }
            });
            
            const data = {
                name: $('#prof-name').value.trim(),
                email: $('#prof-email').value.trim(),
                phone: unformatPhone($('#prof-phone').value.trim()),
                cpf: unformatCPF($('#prof-cpf').value.trim()),
                specialties: specialtiesData,
                active: true,
                updatedAt: Date.now(),
                updatedBy: currentUser.uid
            };

            try {
                let professionalId;
                if (currentEditingId) {
                    // Editar
                    professionalId = currentEditingId;
                    const profRef = ref(db, `professionals/${professionalId}`);
                    
                    const oldSnapshot = await get(profRef);
                    const oldData = oldSnapshot.val();
                    
                    await update(profRef, data);
                    
                    await logAudit('update', 'professional', professionalId, [
                        { field: 'name', oldValue: oldData.name, newValue: data.name }
                    ]);
                } else {
                    // Criar
                    const professionalsRef = ref(db, 'professionals');
                    const newRef = push(professionalsRef);
                    professionalId = newRef.key;
                    data.createdAt = Date.now();
                    data.createdBy = currentUser.uid;
                    
                    await set(newRef, data);
                    
                    await logAudit('create', 'professional', professionalId, []);
                }
                
                hideGlobalLoader();
                closeModalProfissional();
                showAlert('Sucesso', 'Profissional salvo com sucesso!', 'info');
                
                // Atualizar página apenas se estivermos na página de profissionais
                if (currentPage === '#/profissionais') {
                    await loadProfissionaisPage();
                }
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao salvar profissional:", error);
                showAlert('Erro', 'Não foi possível salvar o profissional.', 'error');
            }
        }

        // ===== STATUS DE ATENDIMENTO =====
        
        async function openModalStatus(appointmentId) {
            try {
                showGlobalLoader();
                
                // Buscar dados do atendimento
                const appointmentRef = ref(db, `appointments/${appointmentId}`);
                const snapshot = await get(appointmentRef);
                
                if (!snapshot.exists()) {
                    throw new Error('Atendimento não encontrado');
                }
                
                currentAppointmentData = {
                    id: appointmentId,
                    ...snapshot.val()
                };
                
                // Buscar dados do paciente e especialidade para cálculo
                const patientSnapshot = await get(ref(db, `patients/${currentAppointmentData.patientId}`));
                const specialtySnapshot = await get(ref(db, `specialties/${currentAppointmentData.specialtyId}`));
                const professionalSnapshot = await get(ref(db, `professionals/${currentAppointmentData.professionalId}`));
                
                currentAppointmentData.patientData = patientSnapshot.val();
                currentAppointmentData.specialtyData = specialtySnapshot.val();
                currentAppointmentData.professionalData = professionalSnapshot.val();
                
                // Preencher informações
                $('#status-info').innerHTML = `
                    <div><strong>Paciente:</strong> ${currentAppointmentData.patientData?.name || 'N/A'}</div>
                    <div><strong>Profissional:</strong> ${currentAppointmentData.professionalData?.name || 'N/A'}</div>
                    <div><strong>Especialidade:</strong> ${currentAppointmentData.specialtyData?.name || 'N/A'}</div>
                    <div><strong>Data:</strong> ${currentAppointmentData.date} às ${currentAppointmentData.startTime}</div>
                `;
                
                // Limpar seleção
                document.querySelectorAll('#form-status input[type="radio"]').forEach(r => r.checked = false);
                $('#status-cancel-reason').value = '';
                $('#status-medical-cert').checked = false;
                $('#status-notes').value = '';
                
                hideGlobalLoader();
                $('#modal-status').style.display = 'block';
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao abrir modal de status:", error);
                showAlert('Erro', 'Não foi possível carregar os dados do atendimento.', 'error');
            }
        }

        function closeModalStatus() {
            $('#modal-status').style.display = 'none';
            currentAppointmentData = null;
        }

        // Listener para mudança de status
        document.addEventListener('DOMContentLoaded', () => {
            const statusRadios = document.querySelectorAll('#form-status input[name="status"]');
            statusRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const value = e.target.value;
                    const cancelContainer = $('#cancel-reason-container');
                    const financialPreview = $('#financial-preview');
                    
                    if (value === 'cancelled') {
                        cancelContainer.style.display = 'block';
                        financialPreview.style.display = 'none';
                    } else {
                        cancelContainer.style.display = 'none';
                        financialPreview.style.display = 'block';
                        
                        // Calcular preview
                        calculateFinancialPreview(value);
                    }
                });
            });
        });

        function calculateFinancialPreview(status) {
            if (!currentAppointmentData) return;
            
            const { patientValue, professionalValue } = calculateAppointmentValues(
                currentAppointmentData.patientData,
                currentAppointmentData.specialtyData,
                currentAppointmentData.professionalData,
                currentAppointmentData.specialtyId
            );
            
            $('#preview-patient-value').textContent = `R$ ${patientValue.toFixed(2)}`;
            $('#preview-prof-value').textContent = `R$ ${professionalValue.toFixed(2)}`;
        }

        function calculateAppointmentValues(patientData, specialtyData, professionalData, specialtyId) {
            // 1. Determinar valor a cobrar do paciente
            let patientValue = specialtyData?.defaultValue || 0;
            
            // Verificar se paciente tem valor customizado para esta especialidade
            if (patientData?.customValues && patientData.customValues[specialtyId]) {
                patientValue = patientData.customValues[specialtyId].value;
            }
            
            // Verificar pacote ativo
            if (patientData?.packages) {
                const activePackage = Object.values(patientData.packages).find(pkg => 
                    pkg.specialtyId === specialtyId && 
                    pkg.active && 
                    pkg.usedSessions < pkg.totalSessions
                );
                if (activePackage) {
                    patientValue = activePackage.valuePerSession;
                }
            }
            
            // Aplicar desconto global
            if (patientData?.globalDiscount) {
                patientValue = patientValue * (1 - patientData.globalDiscount / 100);
            }
            
            // 2. Calcular repasse ao profissional
            let professionalValue = 0;
            if (professionalData?.specialties && professionalData.specialties[specialtyId]) {
                const specConfig = professionalData.specialties[specialtyId];
                if (specConfig.repassFixedValue) {
                    professionalValue = specConfig.repassFixedValue;
                } else {
                    const percentage = specConfig.repassPercentage || 70;
                    professionalValue = patientValue * (percentage / 100);
                }
            }
            
            return { patientValue, professionalValue };
        }

        async function saveStatus(event) {
            event.preventDefault();
            
            const selectedStatus = document.querySelector('#form-status input[name="status"]:checked');
            if (!selectedStatus) {
                showAlert('Atenção', 'Selecione um status.', 'warning');
                return;
            }
            
            showGlobalLoader();
            
            const newStatus = selectedStatus.value;
            const notes = $('#status-notes').value.trim();
            
            try {
                const updateData = {
                    status: newStatus,
                    statusUpdatedAt: Date.now(),
                    statusUpdatedBy: currentUser.uid,
                    notes: notes
                };
                
                // Se cancelado, adicionar motivo
                if (newStatus === 'cancelled') {
                    updateData.cancellationReason = $('#status-cancel-reason').value.trim();
                    updateData.hasMedicalCertificate = $('#status-medical-cert').checked;
                }
                
                // Se presente ou ausente, calcular valores
                if (newStatus === 'present' || newStatus === 'absent') {
                    const { patientValue, professionalValue } = calculateAppointmentValues(
                        currentAppointmentData.patientData,
                        currentAppointmentData.specialtyData,
                        currentAppointmentData.professionalData,
                        currentAppointmentData.specialtyId
                    );
                    
                    updateData.financial = {
                        patientValue,
                        professionalValue,
                        usedPackage: false, // TODO: implementar lógica de pacote
                        packageId: null,
                        discount: currentAppointmentData.patientData?.globalDiscount || null,
                        notes: ''
                    };
                }
                
                // Atualizar no Firebase
                const appointmentRef = ref(db, `appointments/${currentAppointmentData.id}`);
                await update(appointmentRef, updateData);
                
                // Registrar auditoria
                await logAudit('status_change', 'appointment', currentAppointmentData.id, [
                    { field: 'status', oldValue: currentAppointmentData.status, newValue: newStatus }
                ]);
                
                hideGlobalLoader();
                closeModalStatus();
                showAlert('Sucesso', 'Status atualizado com sucesso!', 'info');
                
                // Recarregar página de atendimentos
                if (window.location.hash === '#/atendimentos') {
                    await loadAtendimentosPage();
                }
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao atualizar status:", error);
                showAlert('Erro', 'Não foi possível atualizar o status.', 'error');
            }
        }

        // ===== AUDITORIA =====
        
        async function logAudit(action, entityType, entityId, changes) {
            try {
                const auditRef = ref(db, 'auditLog');
                const newLogRef = push(auditRef);
                
                // Sanitizar changes para remover undefined
                const sanitizedChanges = Array.isArray(changes) 
                    ? changes.map(c => ({
                        field: c.field || '',
                        oldValue: c.oldValue !== undefined ? String(c.oldValue) : '',
                        newValue: c.newValue !== undefined ? String(c.newValue) : ''
                    }))
                    : [];
                
                await set(newLogRef, {
                    timestamp: Date.now(),
                    userId: currentUser?.uid || 'unknown',
                    userName: currentUserProfile?.name || 'Unknown User',
                    userRole: currentUserProfile?.role || 'unknown',
                    action: action || 'Unknown Action',
                    entityType: entityType || 'unknown',
                    entityId: entityId || '',
                    changes: sanitizedChanges,
                    details: typeof changes === 'string' ? changes : '',
                    ipAddress: '',
                    userAgent: navigator.userAgent || ''
                });
            } catch (error) {
                console.error("Erro ao registrar auditoria:", error);
                // Não bloqueia a operação principal
            }
        }

        // ===== FUNÇÕES AUXILIARES PARA EDIÇÃO E ATUALIZAÇÃO =====
        
        /**
         * Edita uma especialidade existente.
         */
        async function editEspecialidade(specialtyId) {
            try {
                showGlobalLoader();
                const specRef = ref(db, `specialties/${specialtyId}`);
                const snapshot = await get(specRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Erro', 'Especialidade não encontrada.', 'error');
                    return;
                }
                
                hideGlobalLoader();
                await openModalEspecialidade(specialtyId, snapshot.val());
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao buscar especialidade:", error);
                showAlert('Erro', 'Não foi possível carregar os dados da especialidade.', 'error');
            }
        }
        
        /**
         * Edita um profissional existente.
         */
        async function editProfessional(professionalId) {
            try {
                showGlobalLoader();
                const profRef = ref(db, `professionals/${professionalId}`);
                const snapshot = await get(profRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Erro', 'Profissional não encontrado.', 'error');
                    return;
                }
                
                hideGlobalLoader();
                await openModalProfissional(professionalId, snapshot.val());
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao buscar profissional:", error);
                showAlert('Erro', 'Não foi possível carregar os dados do profissional.', 'error');
            }
        }
        
        /**
         * Atualiza o status de um atendimento (chamada rápida via botão inline).
         */
        async function updateStatus(appointmentId, newStatus) {
            try {
                showGlobalLoader();
                
                // Buscar dados completos do agendamento
                const appointmentRef = ref(db, `appointments/${appointmentId}`);
                const appointmentSnapshot = await get(appointmentRef);
                
                if (!appointmentSnapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Erro', 'Agendamento não encontrado.', 'error');
                    return;
                }
                
                const appointmentData = appointmentSnapshot.val();
                
                // Buscar dados relacionados para cálculo financeiro
                const [patientSnapshot, specialtySnapshot, professionalSnapshot] = await Promise.all([
                    get(ref(db, `patients/${appointmentData.patientId}`)),
                    get(ref(db, `specialties/${appointmentData.specialtyId}`)),
                    get(ref(db, `professionals/${appointmentData.professionalId}`))
                ]);
                
                const patientData = patientSnapshot.val();
                const specialtyData = specialtySnapshot.val();
                const professionalData = professionalSnapshot.val();
                
                hideGlobalLoader();
                
                // Abrir modal com os dados completos
                await openModalStatus(
                    appointmentId,
                    appointmentData,
                    patientData,
                    specialtyData,
                    professionalData,
                    newStatus
                );
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao preparar atualização de status:", error);
                showAlert('Erro', 'Não foi possível carregar os dados do agendamento.', 'error');
            }
        }
        
        /**
         * Visualiza a agenda de horários fixos de um profissional.
         */
        async function viewProfessionalSchedule(professionalId) {
            try {
                showGlobalLoader();
                
                // Buscar horários fixos do profissional (sem usar index)
                const schedulesRef = ref(db, 'fixedSchedules');
                const snapshot = await get(schedulesRef);
                
                let schedules = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    schedules = Object.keys(data)
                        .map(id => ({ id, ...data[id] }))
                        .filter(schedule => schedule.professionalId === professionalId);
                }
                
                // Buscar nome do profissional e especialidades
                const [profSnapshot, specSnapshot] = await Promise.all([
                    get(ref(db, `professionals/${professionalId}`)),
                    get(ref(db, 'specialties'))
                ]);
                
                const professionalName = profSnapshot.exists() ? profSnapshot.val().name : 'Profissional';
                const specialties = specSnapshot.exists() ? specSnapshot.val() : {};
                
                hideGlobalLoader();
                
                // Agrupar por dia da semana
                const daysOfWeek = {
                    0: 'Domingo',
                    1: 'Segunda-feira',
                    2: 'Terça-feira',
                    3: 'Quarta-feira',
                    4: 'Quinta-feira',
                    5: 'Sexta-feira',
                    6: 'Sábado'
                };
                
                const groupedByDay = schedules.reduce((acc, schedule) => {
                    const day = schedule.dayOfWeek;
                    if (!acc[day]) acc[day] = [];
                    acc[day].push(schedule);
                    return acc;
                }, {});
                
                // Ordenar cada dia por horário
                Object.keys(groupedByDay).forEach(day => {
                    groupedByDay[day].sort((a, b) => a.startTime.localeCompare(b.startTime));
                });
                
                // Montar HTML da agenda
                let schedulesHtml = '';
                
                if (schedules.length === 0) {
                    schedulesHtml = '<p class="text-gray-500 text-center py-8">Nenhum horário fixo cadastrado para este profissional</p>';
                } else {
                    schedulesHtml = '<div class="max-h-96 overflow-y-auto space-y-4">';
                    
                    [1, 2, 3, 4, 5, 6, 0].forEach(dayNum => { // Segunda a Domingo
                        if (!groupedByDay[dayNum] || groupedByDay[dayNum].length === 0) return;
                        
                        schedulesHtml += `
                            <div class="border-b pb-3">
                                <h4 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-blue-600" data-lucide="calendar"></svg>
                                    ${daysOfWeek[dayNum]}
                                </h4>
                                <div class="space-y-2 ml-6">
                                    ${groupedByDay[dayNum].map(sch => `
                                        <div class="flex items-center gap-3 text-sm ${sch.active === false ? 'opacity-50' : ''}">
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 font-medium rounded min-w-[60px] text-center">
                                                ${sch.startTime}
                                            </span>
                                            <span class="flex-1">
                                                ${specialties[sch.specialtyId]?.name || 'Especialidade não encontrada'}
                                                <span class="text-gray-500">(${sch.durationMinutes} min)</span>
                                            </span>
                                            ${sch.active === false ? 
                                                '<span class="px-2 py-0.5 bg-gray-200 text-gray-600 text-xs rounded">INATIVO</span>' : 
                                                '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">ATIVO</span>'
                                            }
                                        </div>
                                        ${sch.notes ? `<div class="ml-[76px] text-xs text-gray-600 italic">${sch.notes}</div>` : ''}
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                    
                    schedulesHtml += '</div>';
                }
                
                showModal({
                    title: `Agenda de ${professionalName}`,
                    contentHtml: schedulesHtml,
                    icon: 'calendar',
                    primaryText: 'Fechar',
                    onPrimaryClick: hideModal,
                    hideSecondary: true
                });
                
                // Recriar ícones do Lucide dentro do modal
                lucide.createIcons({ nodes: $modalContent.querySelectorAll('svg') });
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao buscar agenda:", error);
                showAlert('Erro', 'Não foi possível carregar a agenda do profissional.', 'error');
            }
        }
        
        /**
         * Retorna o nome do dia da semana.
         */
        function getDayName(dayIndex) {
            const days = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            return days[dayIndex] || 'N/A';
        }

        // ===== MODAL DE PACIENTE =====

        let currentPatientData = {
            customValues: {},
            packages: {}
        };

        /**
         * Alterna entre as tabs do modal de paciente.
         */
        function switchPatientTab(tabName) {
            // Remove active de todos os botões
            document.querySelectorAll('.patient-tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Oculta todos os conteúdos
            document.querySelectorAll('.patient-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Ativa o tab selecionado
            const activeBtn = document.querySelector(`.patient-tab-btn[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('border-blue-500', 'text-blue-600');
                activeBtn.classList.remove('border-transparent', 'text-gray-500');
            }
            
            const activeContent = $(`#patient-tab-${tabName}`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
        }

        /**
         * Adiciona um campo de valor customizado.
         */
        function addCustomValue() {
            const container = $('#custom-values-container');
            const index = Date.now();
            
            if (!allSpecialtiesCache || allSpecialtiesCache.length === 0) {
                showAlert('Atenção', 'Carregue as especialidades primeiro.', 'warning');
                return;
            }
            
            const html = `
                <div class="flex gap-2 items-end custom-value-item" data-index="${index}">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Especialidade</label>
                        <select class="custom-value-specialty w-full rounded-md border-gray-300 shadow-sm">
                            <option value="">Selecione...</option>
                            ${allSpecialtiesCache.map(spec => 
                                `<option value="${spec.id}">${spec.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                        <input type="number" class="custom-value-price w-full rounded-md border-gray-300 shadow-sm" 
                            step="0.01" min="0" placeholder="120.00">
                    </div>
                    <button type="button" onclick="removeCustomValue(${index})"
                        class="px-3 py-2 text-red-600 hover:text-red-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        /**
         * Remove um campo de valor customizado.
         */
        function removeCustomValue(index) {
            const item = document.querySelector(`.custom-value-item[data-index="${index}"]`);
            if (item) item.remove();
        }

        /**
         * Adiciona um pacote.
         */
        function addPackage() {
            const container = $('#packages-container');
            const index = Date.now();
            
            if (!allSpecialtiesCache || allSpecialtiesCache.length === 0) {
                showAlert('Atenção', 'Carregue as especialidades primeiro.', 'warning');
                return;
            }
            
            const html = `
                <div class="package-item border rounded-md p-4 bg-gray-50" data-index="${index}">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-medium text-gray-900">Pacote #${container.children.length + 1}</h5>
                        <button type="button" onclick="removePackage(${index})"
                            class="text-red-600 hover:text-red-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Especialidade</label>
                            <select class="package-specialty w-full rounded-md border-gray-300 shadow-sm text-sm">
                                <option value="">Selecione...</option>
                                ${allSpecialtiesCache.map(spec => 
                                    `<option value="${spec.id}">${spec.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total de Sessões</label>
                            <input type="number" class="package-total-sessions w-full rounded-md border-gray-300 shadow-sm text-sm" 
                                min="1" value="10" placeholder="10">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Valor por Sessão (R$)</label>
                            <input type="number" class="package-value-per-session w-full rounded-md border-gray-300 shadow-sm text-sm" 
                                step="0.01" min="0" placeholder="100.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data de Validade</label>
                            <input type="date" class="package-expires w-full rounded-md border-gray-300 shadow-sm text-sm">
                        </div>
                    </div>
                    <div class="mt-2 flex items-center">
                        <input type="checkbox" class="package-active rounded border-gray-300 text-blue-600" checked>
                        <label class="ml-2 text-sm text-gray-700">Pacote ativo</label>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        /**
         * Remove um pacote.
         */
        function removePackage(index) {
            const item = document.querySelector(`.package-item[data-index="${index}"]`);
            if (item) item.remove();
        }

        /**
         * Abre o modal de paciente (criar ou editar).
         */
        async function openModalPaciente(patientId = null, patientData = null) {
            // Garantir que especialidades estão carregadas
            if (!allSpecialtiesCache || allSpecialtiesCache.length === 0) {
                await loadAllSpecialties();
            }
            
            const modal = $('#modal-paciente');
            const title = $('#paciente-title');
            const form = $('#form-paciente');
            
            // Resetar formulário
            form.reset();
            currentPatientData = {
                customValues: {},
                packages: {}
            };
            
            // Limpar containers dinâmicos
            $('#custom-values-container').innerHTML = '';
            $('#packages-container').innerHTML = '';
            
            // Voltar para primeira tab
            switchPatientTab('dados');
            
            if (patientId && patientData) {
                // Modo edição
                title.textContent = 'Editar Paciente';
                $('#patient-id').value = patientId;
                
                // Dados pessoais
                $('#patient-name').value = patientData.name || '';
                $('#patient-birthdate').value = patientData.birthDate || '';
                $('#patient-status').value = patientData.status || 'active';
                
                // Responsável
                $('#resp-name').value = patientData.responsible?.name || '';
                $('#resp-phone').value = formatPhone(patientData.responsible?.phone || '');
                $('#resp-email').value = patientData.responsible?.email || '';
                $('#resp-cpf').value = formatCPF(patientData.responsible?.cpf || '');
                
                // Endereço
                $('#patient-address').value = patientData.address?.street || '';
                $('#patient-number').value = patientData.address?.number || '';
                $('#patient-neighborhood').value = patientData.address?.neighborhood || '';
                $('#patient-city').value = patientData.address?.city || '';
                $('#patient-state').value = patientData.address?.state || '';
                
                // Desconto global
                $('#patient-discount').value = patientData.globalDiscount || 0;
                
                // Valores customizados
                if (patientData.customValues) {
                    Object.entries(patientData.customValues).forEach(([specialtyId, data]) => {
                        addCustomValue();
                        const items = document.querySelectorAll('.custom-value-item');
                        const lastItem = items[items.length - 1];
                        lastItem.querySelector('.custom-value-specialty').value = specialtyId;
                        lastItem.querySelector('.custom-value-price').value = data.value;
                    });
                }
                
                // Pacotes
                if (patientData.packages) {
                    Object.entries(patientData.packages).forEach(([pkgId, pkg]) => {
                        addPackage();
                        const items = document.querySelectorAll('.package-item');
                        const lastItem = items[items.length - 1];
                        lastItem.querySelector('.package-specialty').value = pkg.specialtyId;
                        lastItem.querySelector('.package-total-sessions').value = pkg.totalSessions;
                        lastItem.querySelector('.package-value-per-session').value = pkg.valuePerSession || 0;
                        
                        // Validar data antes de converter
                        if (pkg.expiresAt) {
                            try {
                                const expiresDate = new Date(pkg.expiresAt);
                                if (!isNaN(expiresDate.getTime())) {
                                    lastItem.querySelector('.package-expires').value = expiresDate.toISOString().split('T')[0];
                                }
                            } catch (e) {
                                console.warn('Data de expiração inválida:', pkg.expiresAt);
                            }
                        }
                        
                        lastItem.querySelector('.package-active').checked = pkg.active !== false;
                        lastItem.dataset.pkgId = pkgId;
                        lastItem.dataset.usedSessions = pkg.usedSessions || 0;
                    });
                }
                
            } else {
                // Modo criação
                title.textContent = 'Novo Paciente';
                $('#patient-id').value = '';
            }
            
            modal.style.display = 'block';
        }

        /**
         * Fecha o modal de paciente.
         */
        function closeModalPaciente() {
            $('#modal-paciente').style.display = 'none';
        }

        /**
         * Salva o paciente (criar ou editar).
         */
        async function savePaciente(event) {
            event.preventDefault();
            
            const patientId = $('#patient-id').value;
            const isEditing = !!patientId;
            
            // Validação
            const name = $('#patient-name').value.trim();
            const birthDate = $('#patient-birthdate').value;
            const respName = $('#resp-name').value.trim();
            const respPhone = $('#resp-phone').value.trim();
            
            if (!name || !birthDate || !respName || !respPhone) {
                showAlert('Atenção', 'Preencha todos os campos obrigatórios.', 'warning');
                return;
            }
            
            showGlobalLoader();
            
            try {
                // Coletar valores customizados
                const customValues = {};
                document.querySelectorAll('.custom-value-item').forEach(item => {
                    const specialtyId = item.querySelector('.custom-value-specialty').value;
                    const value = parseFloat(item.querySelector('.custom-value-price').value);
                    if (specialtyId && value > 0) {
                        customValues[specialtyId] = { value };
                    }
                });
                
                // Coletar pacotes
                const packages = {};
                document.querySelectorAll('.package-item').forEach(item => {
                    const specialtyId = item.querySelector('.package-specialty').value;
                    const totalSessions = parseInt(item.querySelector('.package-total-sessions').value);
                    const valuePerSession = parseFloat(item.querySelector('.package-value-per-session').value);
                    const expiresDate = item.querySelector('.package-expires').value;
                    const active = item.querySelector('.package-active').checked;
                    
                    if (specialtyId && totalSessions > 0 && valuePerSession > 0) {
                        const pkgId = item.dataset.pkgId || `pkg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        packages[pkgId] = {
                            specialtyId,
                            totalSessions,
                            usedSessions: parseInt(item.dataset.usedSessions) || 0,
                            valuePerSession,
                            expiresAt: expiresDate ? new Date(expiresDate).getTime() : null,
                            active,
                            createdAt: Date.now()
                        };
                    }
                });
                
                // Montar objeto do paciente
                const patientData = {
                    name,
                    birthDate,
                    responsible: {
                        name: respName,
                        phone: unformatPhone(respPhone),
                        email: $('#resp-email').value.trim() || null,
                        cpf: unformatCPF($('#resp-cpf').value.trim() || '')
                    },
                    address: {
                        street: $('#patient-address').value.trim() || null,
                        number: $('#patient-number').value.trim() || null,
                        neighborhood: $('#patient-neighborhood').value.trim() || null,
                        city: $('#patient-city').value.trim() || null,
                        state: $('#patient-state').value.trim() || null
                    },
                    status: $('#patient-status').value,
                    globalDiscount: parseFloat($('#patient-discount').value) || 0,
                    customValues,
                    packages,
                    updatedAt: Date.now()
                };
                
                if (isEditing) {
                    // Atualizar
                    const patientRef = ref(db, `patients/${patientId}`);
                    await update(patientRef, patientData);
                    
                    await logAudit('update', 'patient', patientId, [
                        { field: 'name', oldValue: null, newValue: name }
                    ]);
                    
                    showAlert('Sucesso', 'Paciente atualizado com sucesso!', 'info');
                } else {
                    // Criar
                    patientData.createdAt = Date.now();
                    const newPatientRef = push(ref(db, 'patients'));
                    await set(newPatientRef, patientData);
                    
                    await logAudit('create', 'patient', newPatientRef.key, [
                        { field: 'name', oldValue: null, newValue: name }
                    ]);
                    
                    showAlert('Sucesso', 'Paciente criado com sucesso!', 'info');
                }
                
                hideGlobalLoader();
                closeModalPaciente();
                
                // Atualizar página apenas se estivermos na página de pacientes
                if (currentPage === '#/pacientes') {
                    await loadPacientesPage();
                }
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao salvar paciente:", error);
                showAlert('Erro', 'Não foi possível salvar o paciente.', 'error');
            }
        }

        /**
         * Edita um paciente existente.
         */
        async function editPaciente(patientId) {
            try {
                showGlobalLoader();
                const patientRef = ref(db, `patients/${patientId}`);
                const snapshot = await get(patientRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Erro', 'Paciente não encontrado.', 'error');
                    return;
                }
                
                hideGlobalLoader();
                await openModalPaciente(patientId, snapshot.val());
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao buscar paciente:", error);
                showAlert('Erro', 'Não foi possível carregar os dados do paciente.', 'error');
            }
        }

        // ===== MODAL DE AGENDAMENTO =====

        let cachedPatients = [];
        let cachedProfessionals = [];

        /**
         * Abre o modal de agendamento (criar ou editar).
         */
        async function openModalAgendamento(appointmentId = null, appointmentData = null) {
            // Garantir que dados estão carregados
            if (!allSpecialtiesCache || allSpecialtiesCache.length === 0) {
                await loadAllSpecialties();
            }
            
            showGlobalLoader();
            
            try {
                // Carregar pacientes e profissionais
                const [patientsSnapshot, professionalsSnapshot] = await Promise.all([
                    get(ref(db, 'patients')),
                    get(ref(db, 'professionals'))
                ]);
                
                cachedPatients = [];
                if (patientsSnapshot.exists()) {
                    const data = patientsSnapshot.val();
                    cachedPatients = Object.keys(data)
                        .filter(id => data[id].status === 'active')
                        .map(id => ({ id, ...data[id] }))
                        .sort((a, b) => a.name.localeCompare(b.name));
                }
                
                cachedProfessionals = [];
                if (professionalsSnapshot.exists()) {
                    const data = professionalsSnapshot.val();
                    cachedProfessionals = Object.keys(data)
                        .filter(id => data[id].active !== false)
                        .map(id => ({ id, ...data[id] }));
                }
                
                hideGlobalLoader();
                
                const modal = $('#modal-agendamento');
                const title = $('#agendamento-title');
                const form = $('#form-agendamento');
                
                // Resetar formulário
                form.reset();
                $('#appt-conflicts').classList.add('hidden');
                
                // Preencher select de pacientes
                const patientSelect = $('#appt-patient');
                patientSelect.innerHTML = '<option value="">Selecione um paciente...</option>' +
                    cachedPatients.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                
                // Preencher select de especialidades
                const specialtySelect = $('#appt-specialty');
                specialtySelect.innerHTML = '<option value="">Selecione uma especialidade...</option>' +
                    allSpecialtiesCache.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                
                // Configurar listeners
                specialtySelect.onchange = updateProfessionalsList;
                
                // Listeners para validação de conflitos
                $('#appt-date').onchange = checkConflicts;
                $('#appt-time').onchange = checkConflicts;
                $('#appt-professional').onchange = checkConflicts;
                $('#appt-patient').onchange = checkConflicts;
                
                if (appointmentId && appointmentData) {
                    // Modo edição
                    title.textContent = 'Editar Agendamento';
                    $('#appt-id').value = appointmentId;
                    
                    $('#appt-patient').value = appointmentData.patientId;
                    $('#appt-specialty').value = appointmentData.specialtyId;
                    
                    // Atualizar lista de profissionais e selecionar
                    await updateProfessionalsList();
                    $('#appt-professional').value = appointmentData.professionalId;
                    
                    $('#appt-date').value = appointmentData.date;
                    $('#appt-time').value = appointmentData.startTime;
                    $('#appt-notes').value = appointmentData.notes || '';
                    
                    // Atualizar duração
                    updateDuration();
                    
                } else {
                    // Modo criação
                    title.textContent = 'Novo Agendamento';
                    $('#appt-id').value = '';
                    
                    // Definir data mínima como hoje
                    const today = new Date().toISOString().split('T')[0];
                    $('#appt-date').setAttribute('min', today);
                }
                
                modal.style.display = 'block';
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao abrir modal de agendamento:", error);
                showAlert('Erro', 'Não foi possível abrir o modal de agendamento.', 'error');
            }
        }

        /**
         * Fecha o modal de agendamento.
         */
        function closeModalAgendamento() {
            $('#modal-agendamento').style.display = 'none';
        }

        /**
         * Atualiza a lista de profissionais baseado na especialidade selecionada.
         */
        function updateProfessionalsList() {
            const specialtyId = $('#appt-specialty').value;
            const professionalSelect = $('#appt-professional');
            const hint = $('#appt-professional-hint');
            
            if (!specialtyId) {
                professionalSelect.innerHTML = '<option value="">Selecione um profissional...</option>';
                professionalSelect.disabled = true;
                hint.textContent = 'Selecione uma especialidade primeiro';
                $('#appt-duration').value = '';
                return;
            }
            
            // Filtrar profissionais que atendem esta especialidade
            const availableProfessionals = cachedProfessionals.filter(prof => 
                prof.specialties && prof.specialties[specialtyId]
            );
            
            if (availableProfessionals.length === 0) {
                professionalSelect.innerHTML = '<option value="">Nenhum profissional disponível</option>';
                professionalSelect.disabled = true;
                hint.textContent = 'Nenhum profissional atende esta especialidade';
                return;
            }
            
            professionalSelect.disabled = false;
            professionalSelect.innerHTML = '<option value="">Selecione um profissional...</option>' +
                availableProfessionals.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            hint.textContent = `${availableProfessionals.length} profissional(is) disponível(is)`;
            
            // Atualizar duração
            updateDuration();
        }

        /**
         * Atualiza a duração baseada na especialidade selecionada.
         */
        function updateDuration() {
            const specialtyId = $('#appt-specialty').value;
            const durationInput = $('#appt-duration');
            
            if (!specialtyId) {
                durationInput.value = '';
                return;
            }
            
            const specialty = allSpecialtiesCache.find(s => s.id === specialtyId);
            if (specialty && specialty.defaultDuration) {
                durationInput.value = `${specialty.defaultDuration} minutos`;
            } else {
                durationInput.value = '50 minutos'; // Padrão
            }
        }

        /**
         * Verifica conflitos de agendamento em tempo real.
         */
        async function checkConflicts() {
            const date = $('#appt-date').value;
            const time = $('#appt-time').value;
            const professionalId = $('#appt-professional').value;
            const patientId = $('#appt-patient').value;
            const appointmentId = $('#appt-id').value;
            
            const conflictsDiv = $('#appt-conflicts');
            const conflictsText = $('#appt-conflicts-text');
            
            // Só verificar se tiver todos os campos necessários
            if (!date || !time || !professionalId || !patientId) {
                conflictsDiv.classList.add('hidden');
                return;
            }
            
            try {
                const conflict = await checkAppointmentConflict(date, time, professionalId, patientId, appointmentId);
                
                if (conflict) {
                    conflictsText.textContent = conflict;
                    conflictsDiv.classList.remove('hidden');
                } else {
                    conflictsDiv.classList.add('hidden');
                }
                
            } catch (error) {
                console.error("Erro ao verificar conflitos:", error);
            }
        }

        /**
         * Salva o agendamento (criar ou editar).
         */
        async function saveAgendamento(event) {
            event.preventDefault();
            
            const appointmentId = $('#appt-id').value;
            const isEditing = !!appointmentId;
            
            // Coletar dados
            const patientId = $('#appt-patient').value;
            const specialtyId = $('#appt-specialty').value;
            const professionalId = $('#appt-professional').value;
            const date = $('#appt-date').value;
            const time = $('#appt-time').value;
            const notes = $('#appt-notes').value.trim();
            
            // Validação
            if (!patientId || !specialtyId || !professionalId || !date || !time) {
                showAlert('Atenção', 'Preencha todos os campos obrigatórios.', 'warning');
                return;
            }
            
            // Verificar conflitos
            const conflict = await checkAppointmentConflict(date, time, professionalId, patientId, appointmentId);
            if (conflict) {
                showAlert('Conflito de Horário', conflict + '\n\nDeseja agendar mesmo assim?', 'warning');
                return;
            }
            
            showGlobalLoader();
            
            try {
                // Calcular horário de término
                const specialty = allSpecialtiesCache.find(s => s.id === specialtyId);
                const duration = specialty?.defaultDuration || 50;
                const [hours, minutes] = time.split(':').map(Number);
                const endMinutes = hours * 60 + minutes + duration;
                const endHours = Math.floor(endMinutes / 60);
                const endMins = endMinutes % 60;
                const endTime = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
                
                // Montar objeto
                const appointmentData = {
                    patientId,
                    specialtyId,
                    professionalId,
                    date,
                    startTime: time,
                    endTime,
                    status: 'scheduled',
                    notes,
                    updatedAt: Date.now(),
                    updatedBy: currentUser.uid
                };
                
                if (isEditing) {
                    // Atualizar
                    const apptRef = ref(db, `appointments/${appointmentId}`);
                    await update(apptRef, appointmentData);
                    
                    await logAudit('update', 'appointment', appointmentId, [
                        { field: 'date', oldValue: null, newValue: date },
                        { field: 'startTime', oldValue: null, newValue: time }
                    ]);
                    
                    showAlert('Sucesso', 'Agendamento atualizado com sucesso!', 'info');
                } else {
                    // Criar
                    appointmentData.createdAt = Date.now();
                    appointmentData.createdBy = currentUser.uid;
                    
                    const newApptRef = push(ref(db, 'appointments'));
                    await set(newApptRef, appointmentData);
                    
                    await logAudit('create', 'appointment', newApptRef.key, [
                        { field: 'date', oldValue: null, newValue: date }
                    ]);
                    
                    showAlert('Sucesso', 'Agendamento criado com sucesso!', 'info');
                }
                
                hideGlobalLoader();
                closeModalAgendamento();
                
                // Recarregar página se estiver em agenda ou atendimentos
                const hash = window.location.hash;
                if (hash === '#/agenda' || hash === '#/atendimentos') {
                    await loadAgendaPage();
                }
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao salvar agendamento:", error);
                showAlert('Erro', 'Não foi possível salvar o agendamento.', 'error');
            }
        }

        /**
         * Edita um agendamento existente.
         */
        async function editAgendamento(appointmentId) {
            try {
                showGlobalLoader();
                const apptRef = ref(db, `appointments/${appointmentId}`);
                const snapshot = await get(apptRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Erro', 'Agendamento não encontrado.', 'error');
                    return;
                }
                
                hideGlobalLoader();
                await openModalAgendamento(appointmentId, snapshot.val());
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao buscar agendamento:", error);
                showAlert('Erro', 'Não foi possível carregar os dados do agendamento.', 'error');
            }
        }

        /**
         * Verifica se há conflitos de horário para um novo agendamento.
         * @returns {string|null} Mensagem de conflito, ou null se não houver.
         */
        async function checkAppointmentConflict(date, time, professionalId, patientId, excludingId = null) {
            try {
                // Buscar todos os agendamentos da data
                const appointmentsRef = ref(db, 'appointments');
                const snapshot = await get(appointmentsRef);
                
                if (!snapshot.exists()) {
                    return null;
                }
                
                const appointments = snapshot.val();
                
                for (const [key, appt] of Object.entries(appointments)) {
                    // Pular o próprio agendamento em edição
                    if (key === excludingId) continue;
                    
                    // Só verificar agendamentos da mesma data e não cancelados
                    if (appt.date !== date || appt.status === 'cancelled') continue;
                    
                    // Verificar conflito de profissional
                    if (appt.professionalId === professionalId && appt.startTime === time) {
                        return 'O profissional já tem um atendimento neste horário.';
                    }
                    
                    // Verificar conflito de paciente
                    if (appt.patientId === patientId && appt.startTime === time) {
                        return 'O paciente já tem um atendimento neste horário.';
                    }
                }
                
                return null; // Sem conflitos
                
            } catch (error) {
                console.error("Erro ao verificar conflitos:", error);
                return "Erro ao verificar a agenda. Tente novamente.";
            }
        }

        /**
         * Visualiza detalhes de um agendamento.
         */
        async function viewAppointmentDetails(appointmentId) {
            try {
                showGlobalLoader();
                
                const apptRef = ref(db, `appointments/${appointmentId}`);
                const snapshot = await get(apptRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Erro', 'Agendamento não encontrado.', 'error');
                    return;
                }
                
                const appointment = snapshot.val();
                
                // Buscar dados relacionados
                const [patientSnapshot, professionalSnapshot, specialtySnapshot] = await Promise.all([
                    get(ref(db, `patients/${appointment.patientId}`)),
                    get(ref(db, `professionals/${appointment.therapistId}`)),
                    get(ref(db, `specialties/${appointment.specialtyId}`))
                ]);
                
                const patient = patientSnapshot.val();
                const professional = professionalSnapshot.val();
                const specialty = specialtySnapshot.val();
                
                hideGlobalLoader();
                
                const statusLabels = {
                    scheduled: 'Agendado',
                    presence: 'Presença',
                    absence: 'Ausência',
                    cancellation: 'Cancelamento'
                };
                
                const detailsHtml = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Data</h4>
                                <p class="text-sm">${formatDate(appointment.date)}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Horário</h4>
                                <p class="text-sm">${appointment.time || 'undefined - undefined'}</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-1">Paciente</h4>
                            <p class="text-sm">${patient?.name || 'Não encontrado'}</p>
                            <p class="text-xs text-gray-500">${patient?.responsible?.phone ? formatPhone(patient.responsible.phone) : ''}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-1">Profissional</h4>
                            <p class="text-sm">${professional?.name || 'Não encontrado'}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-1">Especialidade</h4>
                            <p class="text-sm">${specialty?.name || 'Não encontrado'}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-1">Status</h4>
                            <p class="text-sm">${statusLabels[appointment.status] || appointment.status}</p>
                        </div>
                        
                        ${(appointment.status === 'presence' || appointment.status === 'absence') ? `
                            <div class="border-t pt-3">
                                <h4 class="font-semibold text-gray-900 mb-2">Valores</h4>
                                ${specialty && (specialty.patientValue > 0 || specialty.professionalValue > 0) ? `
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div>
                                            <p class="text-gray-600">Paciente:</p>
                                            <p class="font-medium">R$ ${(specialty.patientValue || 0).toFixed(2)}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600">Repasse:</p>
                                            <p class="font-medium">R$ ${(specialty.professionalValue || 0).toFixed(2)}</p>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                                        <div class="flex">
                                            <svg class="h-5 w-5 text-yellow-400" data-lucide="alert-triangle"></svg>
                                            <div class="ml-3">
                                                <p class="text-sm text-yellow-700">
                                                    <strong>Valores não configurados</strong><br>
                                                    A especialidade "${specialty?.name || 'esta'}" não possui valores de atendimento configurados. 
                                                    Configure os valores em Cadastros > Especialidades.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                `}
                            </div>
                        ` : ''}
                        
                        ${appointment.observation ? `
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Observações</h4>
                                <p class="text-sm text-gray-600">${appointment.observation}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                showModal({
                    title: `Detalhes do Agendamento`,
                    contentHtml: detailsHtml,
                    icon: 'calendar',
                    primaryText: appointment.status === 'scheduled' ? 'Editar' : 'Fechar',
                    onPrimaryClick: () => {
                        hideModal();
                        if (appointment.status === 'scheduled') {
                            editAgendamento(appointmentId);
                        }
                    },
                    secondaryText: appointment.status === 'scheduled' ? 'Fechar' : null,
                    onSecondaryClick: hideModal,
                    hideSecondary: appointment.status !== 'scheduled'
                });
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao buscar detalhes do agendamento:", error);
                showAlert('Erro', 'Não foi possível carregar os detalhes do agendamento.', 'error');
            }
        }
        
        // ===================================================================
        // MODAL: HORARIOS FIXOS
        // ===================================================================
        
        /**
         * Abre modal de Horário Fixo (criar novo ou editar existente).
         */
        async function openModalHorarioFixo(scheduleId = null, scheduleData = null) {
            const modal = $('#modal-horario-fixo');
            const title = $('#modal-horario-fixo-title');
            const form = $('#form-horario-fixo');
            const fixedScheduleIdInput = $('#fixed-schedule-id');
            
            // Limpar formulário
            form.reset();
            fixedScheduleIdInput.value = '';
            
            // Carregar especialidades
            const specialtiesRef = ref(db, 'specialties');
            const specialtiesSnapshot = await get(specialtiesRef);
            const specialtySelect = $('#fixed-specialty');
            specialtySelect.innerHTML = '<option value="">Selecione...</option>';
            
            if (specialtiesSnapshot.exists()) {
                const specialties = specialtiesSnapshot.val();
                Object.entries(specialties)
                    .filter(([_, spec]) => spec.active)
                    .sort((a, b) => a[1].name.localeCompare(b[1].name))
                    .forEach(([id, spec]) => {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = spec.name;
                        opt.dataset.duration = spec.defaultDuration || 50;
                        specialtySelect.appendChild(opt);
                    });
            }
            
            // Carregar profissionais
            const professionalsRef = ref(db, 'professionals');
            const professionalsSnapshot = await get(professionalsRef);
            
            if (professionalsSnapshot.exists()) {
                window.cachedProfessionals = Object.entries(professionalsSnapshot.val())
                    .filter(([_, prof]) => prof.active)
                    .map(([id, prof]) => ({ id, ...prof }));
            } else {
                window.cachedProfessionals = [];
            }
            
            // Modo edição
            if (scheduleId && scheduleData) {
                title.textContent = 'Editar Horário Fixo';
                fixedScheduleIdInput.value = scheduleId;
                
                // Preencher campos
                $('#fixed-specialty').value = scheduleData.specialtyId || '';
                await updateFixedProfessionalsList(); // Atualizar lista de profissionais
                $('#fixed-professional').value = scheduleData.professionalId || '';
                $('#fixed-day-of-week').value = scheduleData.dayOfWeek?.toString() || '';
                $('#fixed-start-time').value = scheduleData.startTime || '';
                $('#fixed-active').checked = scheduleData.active !== false;
                $('#fixed-notes').value = scheduleData.notes || '';
                
                updateFixedDuration();
            } else {
                title.textContent = 'Novo Horário Fixo';
                $('#fixed-active').checked = true;
            }
            
            // Mostrar modal
            modal.classList.remove('hidden');
            lucide.createIcons();
            
            // Event listeners
            $('#fixed-specialty').addEventListener('change', async () => {
                await updateFixedProfessionalsList();
                updateFixedDuration();
            });
        }
        
        /**
         * Fecha modal de Horário Fixo.
         */
        function closeModalHorarioFixo() {
            const modal = $('#modal-horario-fixo');
            modal.classList.add('hidden');
        }
        
        /**
         * Atualiza lista de profissionais baseado na especialidade selecionada.
         */
        async function updateFixedProfessionalsList() {
            const specialtyId = $('#fixed-specialty').value;
            const professionalSelect = $('#fixed-professional');
            const hint = $('#fixed-prof-hint');
            
            professionalSelect.innerHTML = '';
            
            if (!specialtyId) {
                professionalSelect.disabled = true;
                professionalSelect.innerHTML = '<option value="">Selecione uma especialidade primeiro</option>';
                hint.textContent = '';
                return;
            }
            
            // Filtrar profissionais que atendem esta especialidade
            const filteredProfessionals = (window.cachedProfessionals || []).filter(prof => 
                prof.specialties && prof.specialties[specialtyId] === true
            );
            
            professionalSelect.innerHTML = '<option value="">Selecione...</option>';
            
            filteredProfessionals
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(prof => {
                    const opt = document.createElement('option');
                    opt.value = prof.id;
                    opt.textContent = prof.name;
                    professionalSelect.appendChild(opt);
                });
            
            professionalSelect.disabled = false;
            hint.textContent = `${filteredProfessionals.length} profissional(is) disponível(is)`;
        }
        
        /**
         * Atualiza campo de duração baseado na especialidade selecionada.
         */
        function updateFixedDuration() {
            const specialtySelect = $('#fixed-specialty');
            const selectedOption = specialtySelect.options[specialtySelect.selectedIndex];
            const durationInput = $('#fixed-duration');
            
            if (selectedOption && selectedOption.dataset.duration) {
                const minutes = selectedOption.dataset.duration;
                durationInput.value = `${minutes} minutos`;
            } else {
                durationInput.value = '';
                durationInput.placeholder = 'Selecione a especialidade para calcular';
            }
        }
        
        /**
         * Salva horário fixo (criar ou atualizar).
         */
        async function saveHorarioFixo(event) {
            event.preventDefault();
            
            const scheduleId = $('#fixed-schedule-id').value;
            const specialtyId = $('#fixed-specialty').value;
            const professionalId = $('#fixed-professional').value;
            const dayOfWeek = parseInt($('#fixed-day-of-week').value);
            const startTime = $('#fixed-start-time').value;
            const active = $('#fixed-active').checked;
            const notes = $('#fixed-notes').value.trim();
            
            // Validação
            if (!specialtyId || !professionalId || isNaN(dayOfWeek) || !startTime) {
                showAlert('Atenção', 'Por favor, preencha todos os campos obrigatórios.', 'warning');
                return;
            }
            
            // Verificar se profissional atende a especialidade
            const professional = window.cachedProfessionals?.find(p => p.id === professionalId);
            if (!professional || !professional.specialties || !professional.specialties[specialtyId]) {
                showAlert('Erro', 'O profissional selecionado não atende esta especialidade.', 'error');
                return;
            }
            
            // Verificar conflito com outros horários fixos
            const conflictMessage = await checkFixedScheduleConflict(dayOfWeek, startTime, professionalId, scheduleId);
            if (conflictMessage) {
                const confirmSave = confirm(`⚠️ ${conflictMessage}\n\nDeseja salvar mesmo assim?`);
                if (!confirmSave) return;
            }
            
            showGlobalLoader();
            
            try {
                const scheduleData = {
                    specialtyId,
                    professionalId,
                    dayOfWeek,
                    startTime,
                    active,
                    notes: notes || null,
                    updatedAt: Date.now(),
                    updatedBy: currentUser?.uid || 'system'
                };
                
                if (scheduleId) {
                    // Atualizar existente
                    const scheduleRef = ref(db, `fixedSchedules/${scheduleId}`);
                    const oldSnapshot = await get(scheduleRef);
                    const oldData = oldSnapshot.val() || {};
                    
                    await update(scheduleRef, scheduleData);
                    
                    // Auditoria
                    await logAudit('update', 'fixedSchedule', scheduleId, oldData, scheduleData);
                    
                    showAlert('Sucesso', 'Horário fixo atualizado!', 'success');
                } else {
                    // Criar novo
                    scheduleData.createdAt = Date.now();
                    scheduleData.createdBy = currentUser?.uid || 'system';
                    
                    const schedulesRef = ref(db, 'fixedSchedules');
                    const newScheduleRef = push(schedulesRef);
                    await set(newScheduleRef, scheduleData);
                    
                    // Auditoria
                    await logAudit('create', 'fixedSchedule', newScheduleRef.key, {}, scheduleData);
                    
                    showAlert('Sucesso', 'Horário fixo criado!', 'success');
                }
                
                closeModalHorarioFixo();
                
                // Recarregar página se estiver na tela de horários fixos
                if (currentPage === 'horarios-fixos') {
                    loadPage('horarios-fixos');
                }
                
            } catch (error) {
                console.error('Erro ao salvar horário fixo:', error);
                showAlert('Erro', 'Não foi possível salvar o horário fixo.', 'error');
            } finally {
                hideGlobalLoader();
            }
        }
        
        /**
         * Verifica conflito de horário fixo (mesmo profissional, mesmo dia, mesmo horário).
         */
        async function checkFixedScheduleConflict(dayOfWeek, startTime, professionalId, excludingId = null) {
            const schedulesRef = ref(db, 'fixedSchedules');
            const snapshot = await get(schedulesRef);
            
            if (!snapshot.exists()) return null;
            
            const schedules = snapshot.val();
            
            for (const [key, schedule] of Object.entries(schedules)) {
                if (key === excludingId) continue;
                if (!schedule.active) continue;
                if (schedule.dayOfWeek !== dayOfWeek) continue;
                if (schedule.startTime !== startTime) continue;
                if (schedule.professionalId === professionalId) {
                    return 'O profissional já possui um horário fixo neste dia e horário.';
                }
            }
            
            return null;
        }
        
        /**
         * Edita horário fixo existente.
         */
        async function editHorarioFixo(scheduleId) {
            showGlobalLoader();
            
            try {
                const scheduleRef = ref(db, `fixedSchedules/${scheduleId}`);
                const snapshot = await get(scheduleRef);
                
                if (!snapshot.exists()) {
                    showAlert('Erro', 'Horário fixo não encontrado.', 'error');
                    return;
                }
                
                const scheduleData = snapshot.val();
                hideGlobalLoader();
                
                await openModalHorarioFixo(scheduleId, scheduleData);
                
            } catch (error) {
                console.error('Erro ao carregar horário fixo:', error);
                showAlert('Erro', 'Não foi possível carregar o horário fixo.', 'error');
                hideGlobalLoader();
            }
        }
        
        /**
         * Exclui horário fixo.
         */
        async function deleteHorarioFixo(scheduleId) {
            showGlobalLoader();
            
            try {
                // Buscar dados do horário fixo
                const scheduleRef = ref(db, `fixedSchedules/${scheduleId}`);
                const snapshot = await get(scheduleRef);
                const scheduleData = snapshot.val();
                
                if (!scheduleData) {
                    showAlert('Erro', 'Horário fixo não encontrado.', 'error');
                    hideGlobalLoader();
                    return;
                }
                
                // Buscar agendamentos futuros vazios gerados por este horário fixo
                const appointmentsRef = ref(db, 'appointments');
                const appointmentsSnapshot = await get(appointmentsRef);
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayString = today.toISOString().split('T')[0];
                
                let emptyFutureAppointments = [];
                
                if (appointmentsSnapshot.exists()) {
                    const appointments = appointmentsSnapshot.val();
                    emptyFutureAppointments = Object.entries(appointments)
                        .filter(([id, appt]) => 
                            appt.generatedFromFixedSchedule === scheduleId && 
                            !appt.patientId && // Vazio (sem paciente)
                            appt.date >= todayString // Futuro
                        )
                        .map(([id, appt]) => ({ id, ...appt }));
                }
                
                hideGlobalLoader();
                
                // Perguntar ao usuário
                let message = 'Tem certeza que deseja excluir este horário fixo?';
                
                if (emptyFutureAppointments.length > 0) {
                    message += `\n\nForam encontrados ${emptyFutureAppointments.length} horário(s) vazio(s) futuro(s) gerado(s) por este horário fixo.\n\nDeseja excluí-los também?`;
                    
                    const deleteAppointments = await showConfirm(
                        'Excluir Horário Fixo e Agendamentos Vazios',
                        message
                    );
                    
                    if (!deleteAppointments) {
                        // Usuário cancelou
                        return;
                    }
                    
                    showGlobalLoader();
                    
                    // Excluir agendamentos vazios
                    for (const appt of emptyFutureAppointments) {
                        const apptRef = ref(db, `appointments/${appt.id}`);
                        await set(apptRef, null);
                        await logAudit('delete', 'appointment', appt.id, appt, {});
                    }
                } else {
                    const confirmDelete = await showConfirm(
                        'Excluir Horário Fixo',
                        message
                    );
                    
                    if (!confirmDelete) return;
                    
                    showGlobalLoader();
                }
                
                // Excluir o horário fixo
                await set(scheduleRef, null);
                
                // Auditoria
                await logAudit('delete', 'fixedSchedule', scheduleId, scheduleData, {});
                
                hideGlobalLoader();
                
                const deletedCount = emptyFutureAppointments.length;
                const successMsg = deletedCount > 0 
                    ? `Horário fixo excluído!\n${deletedCount} agendamento(s) vazio(s) também foram excluído(s).`
                    : 'Horário fixo excluído!';
                
                showAlert('Sucesso', successMsg, 'success');
                
                // Recarregar página
                if (currentPage === 'horarios-fixos') {
                    loadPage('horarios-fixos');
                }
                
            } catch (error) {
                console.error('Erro ao excluir horário fixo:', error);
                showAlert('Erro', 'Não foi possível excluir o horário fixo.', 'error');
            } finally {
                hideGlobalLoader();
            }
        }
        
        /**
         * Alterna status ativo/inativo de horário fixo.
         */
        async function toggleFixedScheduleActive(scheduleId, currentStatus) {
            showGlobalLoader();
            
            try {
                const scheduleRef = ref(db, `fixedSchedules/${scheduleId}`);
                const newStatus = !currentStatus;
                
                await update(scheduleRef, {
                    active: newStatus,
                    updatedAt: Date.now(),
                    updatedBy: currentUser?.uid || 'system'
                });
                
                // Auditoria
                await logAudit('update', 'fixedSchedule', scheduleId, 
                    { active: currentStatus }, 
                    { active: newStatus }
                );
                
                showAlert('Sucesso', `Horário fixo ${newStatus ? 'ativado' : 'desativado'}!`, 'success');
                
                // Recarregar página
                if (currentPage === 'horarios-fixos') {
                    loadPage('horarios-fixos');
                }
                
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                showAlert('Erro', 'Não foi possível alterar o status.', 'error');
            } finally {
                hideGlobalLoader();
            }
        }
        
        /**
         * Gera agendamentos automaticamente a partir dos horários fixos ativos.
         * Gera para os próximos N meses, evitando conflitos.
         */
        async function generateAppointmentsFromFixedSchedules(monthsAhead = 3) {
            const confirmMsg = `Deseja gerar agendamentos automaticamente para os próximos ${monthsAhead} meses?\n\nIsso criará agendamentos baseados nos horários fixos ativos.`;
            
            if (!confirm(confirmMsg)) return;
            
            showGlobalLoader();
            
            try {
                // Buscar horários fixos ativos
                const schedulesRef = ref(db, 'fixedSchedules');
                const schedulesSnapshot = await get(schedulesRef);
                
                if (!schedulesSnapshot.exists()) {
                    showAlert('Aviso', 'Nenhum horário fixo cadastrado.', 'warning');
                    hideGlobalLoader();
                    return;
                }
                
                const fixedSchedules = Object.entries(schedulesSnapshot.val())
                    .filter(([_, schedule]) => schedule.active !== false)
                    .map(([id, schedule]) => ({ id, ...schedule }));
                
                if (fixedSchedules.length === 0) {
                    showAlert('Aviso', 'Nenhum horário fixo ativo encontrado.', 'warning');
                    hideGlobalLoader();
                    return;
                }
                
                // Buscar agendamentos existentes
                const appointmentsRef = ref(db, 'appointments');
                const appointmentsSnapshot = await get(appointmentsRef);
                const existingAppointments = appointmentsSnapshot.exists() 
                    ? Object.values(appointmentsSnapshot.val()) 
                    : [];
                
                // Buscar especialidades para duração
                const specialtiesRef = ref(db, 'specialties');
                const specialtiesSnapshot = await get(specialtiesRef);
                const specialties = specialtiesSnapshot.exists() ? specialtiesSnapshot.val() : {};
                
                let created = 0;
                let skipped = 0;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const endDate = new Date(today);
                endDate.setMonth(endDate.getMonth() + monthsAhead);
                
                // Para cada horário fixo
                for (const fixedSchedule of fixedSchedules) {
                    const { dayOfWeek, startTime, specialtyId, professionalId } = fixedSchedule;
                    
                    // Calcular duração e horário de término
                    const specialty = specialties[specialtyId];
                    const duration = specialty?.defaultDuration || 50;
                    
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const totalMinutes = hours * 60 + minutes + duration;
                    const endHours = Math.floor(totalMinutes / 60);
                    const endMinutes = totalMinutes % 60;
                    const endTime = `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
                    
                    // Encontrar todas as datas deste dia da semana no período
                    let currentDate = new Date(today);
                    
                    // Avançar até o próximo dia da semana correspondente
                    while (currentDate.getDay() !== dayOfWeek) {
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    // Gerar agendamentos para cada ocorrência
                    while (currentDate <= endDate) {
                        const dateString = currentDate.toISOString().split('T')[0];
                        
                        // Verificar se já existe agendamento
                        const conflict = existingAppointments.some(appt => 
                            appt.date === dateString &&
                            appt.time === startTime &&
                            appt.therapistId === professionalId &&
                            appt.status !== 'cancelled'
                        );
                        
                        if (conflict) {
                            skipped++;
                        } else {
                            // Criar novo agendamento (SLOT VAGO - sem paciente)
                            const newAppointment = {
                                therapistId: professionalId,
                                specialtyId,
                                date: dateString,
                                time: startTime,
                                duration: duration,
                                status: 'scheduled',
                                notes: `Horário disponível - gerado automaticamente`,
                                generatedFromFixedSchedule: fixedSchedule.id,
                                createdAt: Date.now(),
                                createdBy: currentUser?.uid || 'system',
                                updatedAt: Date.now(),
                                updatedBy: currentUser?.uid || 'system'
                            };
                            
                            const newAppointmentRef = push(appointmentsRef);
                            await set(newAppointmentRef, newAppointment);
                            
                            // Auditoria
                            await logAudit('create', 'appointment', newAppointmentRef.key, {}, newAppointment);
                            
                            created++;
                        }
                        
                        // Avançar para a próxima semana
                        currentDate.setDate(currentDate.getDate() + 7);
                    }
                }
                
                hideGlobalLoader();
                
                showAlert(
                    'Concluído!', 
                    `${created} agendamento(s) criado(s).\n${skipped} já existente(s) (ignorados).`,
                    'success'
                );
                
                // Recarregar página de agenda se estiver nela
                if (currentPage === 'agenda') {
                    loadPage('agenda');
                }
                
            } catch (error) {
                console.error('Erro ao gerar agendamentos:', error);
                showAlert('Erro', 'Não foi possível gerar os agendamentos.', 'error');
                hideGlobalLoader();
            }
        }
        
        // ===================================================================
        // RELATÓRIOS PDF
        // ===================================================================
        
        /**
         * Gera relatório PDF de agenda semanal/mensal.
         */
        async function generateAgendaPDF() {
            const startDate = $('#report-agenda-inicio').value;
            const endDate = $('#report-agenda-fim').value;
            const professionalId = $('#report-agenda-professional').value;
            
            if (!startDate || !endDate) {
                showAlert('Atenção', 'Por favor, selecione o período.', 'warning');
                return;
            }
            
            showGlobalLoader();
            
            try {
                // Buscar dados
                const appointmentsRef = ref(db, 'appointments');
                const professionalsRef = ref(db, 'professionals');
                const patientsRef = ref(db, 'patients');
                const specialtiesRef = ref(db, 'specialties');
                
                const [apptsSnap, profsSnap, patsSnap, specsSnap] = await Promise.all([
                    get(appointmentsRef),
                    get(professionalsRef),
                    get(patientsRef),
                    get(specialtiesRef)
                ]);
                
                const appointments = apptsSnap.exists() ? apptsSnap.val() : {};
                const professionals = profsSnap.exists() ? profsSnap.val() : {};
                const patients = patsSnap.exists() ? patsSnap.val() : {};
                const specialties = specsSnap.exists() ? specsSnap.val() : {};
                
                // Filtrar agendamentos
                const filteredAppts = Object.entries(appointments)
                    .filter(([_, appt]) => {
                        if (appt.date < startDate || appt.date > endDate) return false;
                        if (professionalId && appt.professionalId !== professionalId) return false;
                        return true;
                    })
                    .map(([id, appt]) => ({ id, ...appt }))
                    .sort((a, b) => {
                        if (a.date !== b.date) return a.date.localeCompare(b.date);
                        return a.startTime.localeCompare(b.startTime);
                    });
                
                if (filteredAppts.length === 0) {
                    showAlert('Aviso', 'Nenhum agendamento encontrado no período selecionado.', 'warning');
                    hideGlobalLoader();
                    return;
                }
                
                // Criar PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Cabeçalho
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('CLÍNICA SINGULAR', 105, 15, { align: 'center' });
                
                doc.setFontSize(14);
                doc.text('Relatório de Agenda', 105, 23, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Período: ${formatDateBR(startDate)} a ${formatDateBR(endDate)}`, 105, 30, { align: 'center' });
                
                if (professionalId) {
                    const profName = professionals[professionalId]?.name || 'Desconhecido';
                    doc.text(`Profissional: ${profName}`, 105, 36, { align: 'center' });
                }
                
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, professionalId ? 42 : 36, { align: 'center' });
                
                // Tabela
                const tableData = filteredAppts.map(appt => [
                    formatDateBR(appt.date),
                    appt.startTime,
                    patients[appt.patientId]?.name || 'Desconhecido',
                    professionals[appt.professionalId]?.name || 'Desconhecido',
                    specialties[appt.specialtyId]?.name || 'Desconhecida',
                    getStatusLabel(appt.status)
                ]);
                
                doc.autoTable({
                    startY: professionalId ? 48 : 42,
                    head: [['Data', 'Horário', 'Paciente', 'Profissional', 'Especialidade', 'Status']],
                    body: tableData,
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [37, 99, 235], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    margin: { top: 10, left: 10, right: 10 }
                });
                
                // Resumo
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text(`Total de agendamentos: ${filteredAppts.length}`, 10, finalY);
                
                // Status count
                const statusCount = filteredAppts.reduce((acc, appt) => {
                    acc[appt.status] = (acc[appt.status] || 0) + 1;
                    return acc;
                }, {});
                
                let yPos = finalY + 6;
                Object.entries(statusCount).forEach(([status, count]) => {
                    doc.setFont(undefined, 'normal');
                    doc.text(`${getStatusLabel(status)}: ${count}`, 10, yPos);
                    yPos += 5;
                });
                
                // Salvar
                doc.save(`agenda_${startDate}_${endDate}.pdf`);
                
                hideGlobalLoader();
                showAlert('Sucesso', 'PDF gerado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showAlert('Erro', 'Não foi possível gerar o relatório.', 'error');
                hideGlobalLoader();
            }
        }
        
        /**
         * Gera relatório financeiro mensal em PDF.
         */
        async function generateFinanceiroPDF() {
            const monthInput = $('#report-financeiro-mes').value;
            
            if (!monthInput) {
                showAlert('Atenção', 'Por favor, selecione o mês/ano.', 'warning');
                return;
            }
            
            showGlobalLoader();
            
            try {
                const [year, month] = monthInput.split('-');
                const startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
                
                // Buscar dados
                const appointmentsRef = ref(db, 'appointments');
                const professionalsRef = ref(db, 'professionals');
                const patientsRef = ref(db, 'patients');
                const specialtiesRef = ref(db, 'specialties');
                
                const [apptsSnap, profsSnap, patsSnap, specsSnap] = await Promise.all([
                    get(appointmentsRef),
                    get(professionalsRef),
                    get(patientsRef),
                    get(specialtiesRef)
                ]);
                
                const appointments = apptsSnap.exists() ? apptsSnap.val() : {};
                const professionals = profsSnap.exists() ? profsSnap.val() : {};
                const patients = patsSnap.exists() ? patsSnap.val() : {};
                const specialties = specsSnap.exists() ? specsSnap.val() : {};
                
                // Filtrar agendamentos com financial
                const filteredAppts = Object.entries(appointments)
                    .filter(([_, appt]) => 
                        appt.date >= startDate && 
                        appt.date <= endDate && 
                        appt.status === 'present' &&
                        appt.financial
                    )
                    .map(([id, appt]) => ({ id, ...appt }));
                
                if (filteredAppts.length === 0) {
                    showAlert('Aviso', 'Nenhum atendimento presente encontrado no período.', 'warning');
                    hideGlobalLoader();
                    return;
                }
                
                // Cálculos
                let totalReceitas = 0;
                let totalComissoes = 0;
                const byProfessional = {};
                const bySpecialty = {};
                
                filteredAppts.forEach(appt => {
                    const receita = appt.financial.patientValue || 0;
                    const comissao = appt.financial.professionalValue || 0;
                    
                    totalReceitas += receita;
                    totalComissoes += comissao;
                    
                    // Por profissional
                    const profId = appt.professionalId;
                    if (!byProfessional[profId]) {
                        byProfessional[profId] = {
                            name: professionals[profId]?.name || 'Desconhecido',
                            receitas: 0,
                            comissoes: 0,
                            atendimentos: 0
                        };
                    }
                    byProfessional[profId].receitas += receita;
                    byProfessional[profId].comissoes += comissao;
                    byProfessional[profId].atendimentos += 1;
                    
                    // Por especialidade
                    const specId = appt.specialtyId;
                    if (!bySpecialty[specId]) {
                        bySpecialty[specId] = {
                            name: specialties[specId]?.name || 'Desconhecida',
                            receitas: 0,
                            atendimentos: 0
                        };
                    }
                    bySpecialty[specId].receitas += receita;
                    bySpecialty[specId].atendimentos += 1;
                });
                
                // Criar PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Cabeçalho
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('CLÍNICA SINGULAR', 105, 15, { align: 'center' });
                
                doc.setFontSize(14);
                doc.text('Relatório Financeiro Mensal', 105, 23, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const monthName = new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                doc.text(`Período: ${monthName}`, 105, 30, { align: 'center' });
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 36, { align: 'center' });
                
                // Resumo Geral
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('RESUMO GERAL', 10, 48);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Total de Atendimentos: ${filteredAppts.length}`, 10, 56);
                doc.text(`Total de Receitas: R$ ${totalReceitas.toFixed(2)}`, 10, 62);
                doc.text(`Total de Comissões: R$ ${totalComissoes.toFixed(2)}`, 10, 68);
                doc.text(`Líquido para Clínica: R$ ${(totalReceitas - totalComissoes).toFixed(2)}`, 10, 74);
                
                // Tabela por Profissional
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('POR PROFISSIONAL', 10, 86);
                
                const profData = Object.values(byProfessional).map(p => [
                    p.name,
                    p.atendimentos,
                    `R$ ${p.receitas.toFixed(2)}`,
                    `R$ ${p.comissoes.toFixed(2)}`,
                    `R$ ${(p.receitas - p.comissoes).toFixed(2)}`
                ]);
                
                doc.autoTable({
                    startY: 90,
                    head: [['Profissional', 'Atend.', 'Receitas', 'Comissões', 'Líquido']],
                    body: profData,
                    styles: { fontSize: 9, cellPadding: 2 },
                    headStyles: { fillColor: [34, 197, 94], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [245, 245, 245] }
                });
                
                // Tabela por Especialidade
                const specStartY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('POR ESPECIALIDADE', 10, specStartY);
                
                const specData = Object.values(bySpecialty).map(s => [
                    s.name,
                    s.atendimentos,
                    `R$ ${s.receitas.toFixed(2)}`,
                    `R$ ${(s.receitas / s.atendimentos).toFixed(2)}`
                ]);
                
                doc.autoTable({
                    startY: specStartY + 4,
                    head: [['Especialidade', 'Atend.', 'Receitas', 'Média/Atend.']],
                    body: specData,
                    styles: { fontSize: 9, cellPadding: 2 },
                    headStyles: { fillColor: [34, 197, 94], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [245, 245, 245] }
                });
                
                // Salvar
                doc.save(`financeiro_${year}_${month}.pdf`);
                
                hideGlobalLoader();
                showAlert('Sucesso', 'PDF gerado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showAlert('Erro', 'Não foi possível gerar o relatório.', 'error');
                hideGlobalLoader();
            }
        }
        
        /**
         * Gera relatório de comissões por profissional.
         */
        async function generateComissaoPDF() {
            const professionalId = $('#report-comissao-professional').value;
            const monthInput = $('#report-comissao-mes').value;
            
            if (!professionalId || !monthInput) {
                showAlert('Atenção', 'Por favor, selecione o profissional e o mês.', 'warning');
                return;
            }
            
            showGlobalLoader();
            
            try {
                const [year, month] = monthInput.split('-');
                const startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
                
                // Buscar dados
                const appointmentsRef = ref(db, 'appointments');
                const professionalsRef = ref(db, 'professionals');
                const patientsRef = ref(db, 'patients');
                const specialtiesRef = ref(db, 'specialties');
                
                const [apptsSnap, profsSnap, patsSnap, specsSnap] = await Promise.all([
                    get(appointmentsRef),
                    get(professionalsRef),
                    get(patientsRef),
                    get(specialtiesRef)
                ]);
                
                const appointments = apptsSnap.exists() ? apptsSnap.val() : {};
                const professionals = profsSnap.exists() ? profsSnap.val() : {};
                const patients = patsSnap.exists() ? patsSnap.val() : {};
                const specialties = specsSnap.exists() ? specsSnap.val() : {};
                
                const professional = professionals[professionalId];
                if (!professional) {
                    showAlert('Erro', 'Profissional não encontrado.', 'error');
                    hideGlobalLoader();
                    return;
                }
                
                // Filtrar agendamentos
                const filteredAppts = Object.entries(appointments)
                    .filter(([_, appt]) => 
                        appt.professionalId === professionalId &&
                        appt.date >= startDate && 
                        appt.date <= endDate && 
                        appt.status === 'present' &&
                        appt.financial
                    )
                    .map(([id, appt]) => ({ id, ...appt }))
                    .sort((a, b) => a.date.localeCompare(b.date));
                
                if (filteredAppts.length === 0) {
                    showAlert('Aviso', 'Nenhum atendimento encontrado no período.', 'warning');
                    hideGlobalLoader();
                    return;
                }
                
                // Cálculos
                let totalComissao = 0;
                
                // Criar PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Cabeçalho
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('CLÍNICA SINGULAR', 105, 15, { align: 'center' });
                
                doc.setFontSize(14);
                doc.text('Relatório de Comissões', 105, 23, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Profissional: ${professional.name}`, 105, 30, { align: 'center' });
                const monthName = new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                doc.text(`Período: ${monthName}`, 105, 36, { align: 'center' });
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 42, { align: 'center' });
                
                // Tabela de Atendimentos
                const tableData = filteredAppts.map(appt => {
                    const comissao = appt.financial.professionalValue || 0;
                    totalComissao += comissao;
                    
                    return [
                        formatDateBR(appt.date),
                        appt.startTime,
                        patients[appt.patientId]?.name || 'Desconhecido',
                        specialties[appt.specialtyId]?.name || 'Desconhecida',
                        `R$ ${(appt.financial.patientValue || 0).toFixed(2)}`,
                        `${appt.financial.discount || 0}%`,
                        `R$ ${comissao.toFixed(2)}`
                    ];
                });
                
                doc.autoTable({
                    startY: 50,
                    head: [['Data', 'Hora', 'Paciente', 'Especialidade', 'Valor', 'Desc.', 'Comissão']],
                    body: tableData,
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [147, 51, 234], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    columnStyles: {
                        4: { halign: 'right' },
                        5: { halign: 'center' },
                        6: { halign: 'right', fontStyle: 'bold' }
                    }
                });
                
                // Resumo
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Total de Atendimentos: ${filteredAppts.length}`, 10, finalY);
                doc.text(`Total de Comissões: R$ ${totalComissao.toFixed(2)}`, 10, finalY + 8);
                
                // Salvar
                doc.save(`comissoes_${professional.name.replace(/\s+/g, '_')}_${year}_${month}.pdf`);
                
                hideGlobalLoader();
                showAlert('Sucesso', 'PDF gerado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showAlert('Erro', 'Não foi possível gerar o relatório.', 'error');
                hideGlobalLoader();
            }
        }
        
        /**
         * Gera relatório de pacotes ativos.
         */
        async function generatePacotesPDF() {
            const filter = $('#report-pacotes-filter').value;
            
            showGlobalLoader();
            
            try {
                // Buscar pacientes
                const patientsRef = ref(db, 'patients');
                const specialtiesRef = ref(db, 'specialties');
                
                const [patsSnap, specsSnap] = await Promise.all([
                    get(patientsRef),
                    get(specialtiesRef)
                ]);
                
                const patients = patsSnap.exists() ? patsSnap.val() : {};
                const specialties = specsSnap.exists() ? specsSnap.val() : {};
                
                // Filtrar pacientes com pacotes
                const patientsWithPackages = Object.entries(patients)
                    .filter(([_, patient]) => patient.packages && patient.packages.length > 0)
                    .map(([id, patient]) => ({ id, ...patient }));
                
                if (patientsWithPackages.length === 0) {
                    showAlert('Aviso', 'Nenhum paciente com pacotes encontrado.', 'warning');
                    hideGlobalLoader();
                    return;
                }
                
                // Preparar dados
                const packageData = [];
                patientsWithPackages.forEach(patient => {
                    patient.packages.forEach(pkg => {
                        const remaining = pkg.totalSessions - (pkg.usedSessions || 0);
                        
                        // Aplicar filtro
                        if (filter === 'active' && remaining <= 0) return;
                        if (filter === 'expiring' && remaining > 3) return;
                        
                        packageData.push({
                            patientName: patient.name,
                            specialtyName: specialties[pkg.specialtyId]?.name || 'Desconhecida',
                            totalSessions: pkg.totalSessions,
                            usedSessions: pkg.usedSessions || 0,
                            remaining: remaining,
                            value: pkg.packageValue,
                            status: remaining > 0 ? 'Ativo' : 'Concluído'
                        });
                    });
                });
                
                if (packageData.length === 0) {
                    showAlert('Aviso', 'Nenhum pacote encontrado com os filtros selecionados.', 'warning');
                    hideGlobalLoader();
                    return;
                }
                
                // Ordenar por paciente
                packageData.sort((a, b) => a.patientName.localeCompare(b.patientName));
                
                // Criar PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Cabeçalho
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('CLÍNICA SINGULAR', 105, 15, { align: 'center' });
                
                doc.setFontSize(14);
                doc.text('Relatório de Pacotes', 105, 23, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const filterLabels = {
                    all: 'Todos os pacotes',
                    active: 'Apenas com sessões restantes',
                    expiring: 'Próximos a expirar (≤3 sessões)'
                };
                doc.text(`Filtro: ${filterLabels[filter]}`, 105, 30, { align: 'center' });
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 36, { align: 'center' });
                
                // Tabela
                const tableData = packageData.map(pkg => [
                    pkg.patientName,
                    pkg.specialtyName,
                    pkg.totalSessions,
                    pkg.usedSessions,
                    pkg.remaining,
                    `R$ ${pkg.value.toFixed(2)}`,
                    pkg.status
                ]);
                
                doc.autoTable({
                    startY: 44,
                    head: [['Paciente', 'Especialidade', 'Total', 'Usadas', 'Restantes', 'Valor', 'Status']],
                    body: tableData,
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [249, 115, 22], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    columnStyles: {
                        2: { halign: 'center' },
                        3: { halign: 'center' },
                        4: { halign: 'center', fontStyle: 'bold' },
                        5: { halign: 'right' },
                        6: { halign: 'center' }
                    }
                });
                
                // Resumo
                const finalY = doc.lastAutoTable.finalY + 10;
                const totalPackages = packageData.length;
                const activePackages = packageData.filter(p => p.remaining > 0).length;
                const totalValue = packageData.reduce((sum, p) => sum + p.value, 0);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text(`Total de Pacotes: ${totalPackages}`, 10, finalY);
                doc.text(`Pacotes Ativos: ${activePackages}`, 10, finalY + 6);
                doc.text(`Valor Total: R$ ${totalValue.toFixed(2)}`, 10, finalY + 12);
                
                // Salvar
                doc.save(`pacotes_${filter}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                hideGlobalLoader();
                showAlert('Sucesso', 'PDF gerado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showAlert('Erro', 'Não foi possível gerar o relatório.', 'error');
                hideGlobalLoader();
            }
        }
        
        /**
         * Funções auxiliares para PDFs.
         */
        function formatDateBR(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        function getStatusLabel(status) {
            const labels = {
                scheduled: 'Agendado',
                confirmed: 'Confirmado',
                present: 'Presente',
                absent: 'Ausente',
                cancelled: 'Cancelado'
            };
            return labels[status] || status;
        }
        
        /**
         * Formata CPF: 000.000.000-00
         */
        function formatCPF(value) {
            if (!value) return '';
            // Remove tudo que não é número
            const numbers = value.replace(/\D/g, '');
            // Limita a 11 dígitos
            const limited = numbers.substring(0, 11);
            // Aplica a máscara
            return limited
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        }
        
        /**
         * Formata Telefone: (00) 00000-0000 ou (00) 0000-0000
         */
        function formatPhone(value) {
            if (!value) return '';
            // Remove tudo que não é número
            const numbers = value.replace(/\D/g, '');
            // Limita a 11 dígitos (DDD + 9 dígitos)
            const limited = numbers.substring(0, 11);
            
            // Aplica a máscara
            if (limited.length <= 10) {
                // Telefone fixo: (00) 0000-0000
                return limited
                    .replace(/(\d{2})(\d)/, '($1) $2')
                    .replace(/(\d{4})(\d{1,4})$/, '$1-$2');
            } else {
                // Celular: (00) 00000-0000
                return limited
                    .replace(/(\d{2})(\d)/, '($1) $2')
                    .replace(/(\d{5})(\d{1,4})$/, '$1-$2');
            }
        }
        
        /**
         * Remove formatação de CPF
         */
        function unformatCPF(value) {
            return value ? value.replace(/\D/g, '') : '';
        }
        
        /**
         * Remove formatação de telefone
         */
        function unformatPhone(value) {
            return value ? value.replace(/\D/g, '') : '';
        }
        
        /**
         * Aplica máscara de CPF em um input
         */
        function applyCPFMask(inputElement) {
            if (!inputElement) return;
            
            inputElement.addEventListener('input', function(e) {
                const cursorPosition = this.selectionStart;
                const oldLength = this.value.length;
                
                this.value = formatCPF(this.value);
                
                const newLength = this.value.length;
                const diff = newLength - oldLength;
                
                // Ajusta posição do cursor
                this.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
            });
            
            // Formata valor inicial se existir
            if (inputElement.value) {
                inputElement.value = formatCPF(inputElement.value);
            }
        }
        
        /**
         * Aplica máscara de telefone em um input
         */
        function applyPhoneMask(inputElement) {
            if (!inputElement) return;
            
            inputElement.addEventListener('input', function(e) {
                const cursorPosition = this.selectionStart;
                const oldLength = this.value.length;
                
                this.value = formatPhone(this.value);
                
                const newLength = this.value.length;
                const diff = newLength - oldLength;
                
                // Ajusta posição do cursor
                this.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
            });
            
            // Formata valor inicial se existir
            if (inputElement.value) {
                inputElement.value = formatPhone(inputElement.value);
            }
        }
        
        /**
         * Conecta event listeners aos botões após carregamento das páginas.
         */
        function setupPageEventListeners() {
            // Botão adicionar especialidade
            const btnAddEspecialidade = $('#add-especialidade-btn');
            if (btnAddEspecialidade) {
                btnAddEspecialidade.addEventListener('click', () => openModalEspecialidade());
            }
            
            // Botão adicionar profissional
            const btnAddProfessional = $('#add-professional-btn');
            if (btnAddProfessional) {
                btnAddProfessional.addEventListener('click', () => openModalProfissional());
            }
            
            // Botão adicionar paciente
            const btnAddPaciente = $('#add-patient-btn');
            if (btnAddPaciente) {
                btnAddPaciente.addEventListener('click', () => openModalPaciente());
            }
            
            // Botão adicionar agendamento
            const btnAddAgendamento = $('#add-appointment-btn');
            if (btnAddAgendamento) {
                btnAddAgendamento.addEventListener('click', () => {
                    const today = new Date().toISOString().split('T')[0];
                    showAppointmentModal(null, { date: today });
                });
            }
            
            // Botão adicionar horário fixo
            const btnAddAgendaFixa = $('#add-agenda-fixa-btn');
            if (btnAddAgendaFixa) {
                btnAddAgendaFixa.addEventListener('click', () => openModalHorarioFixo());
            }
            
            // Aplicar máscaras em todos os campos de CPF e Telefone
            applyInputMasks();
            
            // Outros botões dinâmicos são conectados via onclick inline nas tabelas
        }
        
        /**
         * Aplica máscaras de CPF e Telefone em todos os inputs do projeto
         */
        function applyInputMasks() {
            // CPF - Profissional
            applyCPFMask($('#prof-cpf'));
            
            // Telefone - Profissional
            applyPhoneMask($('#prof-phone'));
            
            // CPF - Responsável do Paciente
            applyCPFMask($('#resp-cpf'));
            
            // Telefone - Responsável do Paciente
            applyPhoneMask($('#resp-phone'));
            
            // CPF - Usuário
            applyCPFMask($('#user-cpf'));
            
            // Telefone - Usuário
            applyPhoneMask($('#user-phone'));
            
            // Telefone - Configurações da Clínica
            applyPhoneMask($('#config-clinic-phone'));
        }

        // Event Listeners para os formulários
        $('#form-especialidade')?.addEventListener('submit', saveEspecialidade);
        $('#form-profissional')?.addEventListener('submit', saveProfissional);
        $('#form-status')?.addEventListener('submit', saveStatus);
        $('#form-paciente')?.addEventListener('submit', savePaciente);
        $('#form-agendamento')?.addEventListener('submit', saveAgendamento);
        $('#form-horario-fixo')?.addEventListener('submit', saveHorarioFixo);


        // --- VIRTUAL FILE: auth.js ---
        
        // Estado global de autenticação
        let currentUser = null;
        let currentUserProfile = null; // { uid, email, name, role, status }
        
        /**
        * Lida com o submit do formulário de login.
        */
        async function handleLogin(event) {
            event.preventDefault();
            const email = $('#login-email').value;
            const password = $('#login-password').value;
            $loginError.textContent = '';
            showGlobalLoader();

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // O sucesso é tratado pelo onAuthStateChanged
            } catch (error) {
                console.error("Erro de login:", error.code, error.message);
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    $loginError.textContent = 'Email ou senha inválidos.';
                } else if (error.code === 'auth/api-key-not-valid') {
                    $loginError.textContent = 'Erro de configuração: API Key do Firebase inválida.';
                } else {
                    $loginError.textContent = `Erro ao tentar fazer login. (${error.code})`;
                }
                hideGlobalLoader();
            }
        }
        
        /**
        * Lida com o clique no botão de logout.
        */
        async function handleLogout() {
            try {
                // Limpa listeners de dados antes de deslogar
                clearAllDataListeners();
                
                await signOut(auth);
                // O sucesso é tratado pelo onAuthStateChanged
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
            }
        }
        
        /**
        * Atualiza a UI para a tela de login.
        */
        function showLoginView() {
            $loginView.style.display = 'flex';
            $appView.style.display = 'none';
            $mobileMenu.style.display = 'none';
            hideGlobalLoader();
        }
        
        /**
        * Atualiza a UI para a tela principal da aplicação.
        */
        function showAppView(userProfile) {
            $loginView.style.display = 'none';
            $appView.style.display = 'flex'; // 'flex' por causa do layout com sidebar
            
            // Preenche informações do usuário
            const userName = userProfile.name || 'Usuário';
            const userRole = userProfile.role || 'desconhecido';
            
            $('#user-name').textContent = userName;
            $('#user-role').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
            $('#mobile-user-name').textContent = userName;
            $('#mobile-user-role').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
            
            // Atualiza a navegação baseada na role
            updateNavigation(userRole);
            hideGlobalLoader();
        }
        
        /**
        * Observador principal do estado de autenticação.
        */
        function initAuthListener() {
            showGlobalLoader();
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Usuário autenticado:", user.uid);
                    // 1. Usuário está logado. Buscar perfil no Realtime Database.
                    try {
                        const userProfileRef = ref(db, `users/${user.uid}`);
                        const snapshot = await get(userProfileRef);
                        
                        if (snapshot.exists()) {
                            currentUserProfile = { uid: user.uid, ...snapshot.val() };
                            currentUser = user;
                            
                            if (currentUserProfile.status === 'inactive') {
                                console.warn("Usuário inativo. Deslogando.");
                                showAlert('Acesso Negado', 'Sua conta está inativa. Contate o administrador.', 'error');
                                await handleLogout();
                                return;
                            }
                            
                            // 2. Mostrar a aplicação
                            showAppView(currentUserProfile);
                            
                            // 3. Iniciar listeners de dados
                            initDataListeners(currentUserProfile.role, currentUserProfile.uid);

                            // 4. Navegar para a rota correta
                            navigateToHash();
                            
                        } else {
                            // Usuário autenticado no Firebase, mas sem perfil no DB
                            console.error("Erro crítico: Perfil de usuário não encontrado no DB.");
                            showAlert('Erro de Perfil', 'Seu perfil de usuário não foi encontrado. Contate o suporte.', 'error');
                            await handleLogout();
                        }
                    } catch (error) {
                        console.error("Erro ao buscar perfil do usuário:", error);
                        showAlert('Erro de Conexão', 'Não foi possível carregar seu perfil. Tente novamente.', 'error');
                        await handleLogout();
                    }
                } else {
                    // 0. Usuário está deslogado.
                    console.log("Nenhum usuário autenticado.");
                    currentUser = null;
                    currentUserProfile = null;
                    showLoginView();
                }
            });
        }

        // --- VIRTUAL FILE: app.js (Router & Navegação) ---
        
        let calendarInstance = null; // Instância do FullCalendar
        let chartInstances = {}; // Instâncias do Chart.js
        let dataListeners = []; // Armazena referências para 'off()' do Firebase
        let currentPage = null; // Página/rota atual

        // Definição das rotas e permissões (atualizado para novo sistema)
        const routes = {
            '#/dashboard': { 
                title: 'Dashboard', 
                icon: 'layout-dashboard', 
                roles: ['administrator'],
                load: loadDashboardPage
            },
            '#/agenda': { 
                title: 'Agenda', 
                icon: 'calendar-days', 
                roles: ['administrator', 'reception', 'therapist'],
                load: loadAgendaPage
            },
            '#/agendas-fixas': { 
                title: 'Agendas Fixas', 
                icon: 'calendar-check', 
                roles: ['administrator', 'reception'],
                load: loadAgendasFixasPage
            },
            '#/profissionais': { 
                title: 'Profissionais', 
                icon: 'user-check', 
                roles: ['administrator', 'reception'],
                load: loadProfissionaisPage
            },
            '#/especialidades': { 
                title: 'Especialidades', 
                icon: 'clipboard-list', 
                roles: ['administrator'],
                load: loadEspecialidadesPage
            },
            '#/pacientes': { 
                title: 'Pacientes', 
                icon: 'users', 
                roles: ['administrator', 'reception'],
                load: loadPacientesPage
            },
            '#/atendimentos': { 
                title: 'Atendimentos', 
                icon: 'clipboard-check', 
                roles: ['administrator', 'reception'],
                load: loadAtendimentosPage
            },
            '#/financeiro': { 
                title: 'Financeiro', 
                icon: 'dollar-sign', 
                roles: ['administrator', 'reception'],
                load: loadPagamentosPage
            },
            '#/relatorios': { 
                title: 'Relatórios', 
                icon: 'file-text', 
                roles: ['administrator', 'reception'],
                load: loadRelatoriosPage
            },
            '#/minha-agenda': { 
                title: 'Minha Agenda', 
                icon: 'calendar', 
                roles: ['therapist'],
                load: loadMinhaAgendaPage
            },
            '#/auditoria': { 
                title: 'Auditoria', 
                icon: 'shield-check', 
                roles: ['administrator'],
                load: loadAuditoriaPage
            },
            '#/usuarios': { 
                title: 'Usuários', 
                icon: 'user-cog', 
                roles: ['administrator'],
                load: loadUsuariosPage
            },
            '#/configuracoes': { 
                title: 'Configurações', 
                icon: 'settings', 
                roles: ['administrator'],
                load: loadConfiguracoesPage
            }
        };
        
        /**
         * Atualiza os links da barra de navegação (desktop e mobile)
         * com base na role do usuário.
         */
        function updateNavigation(role) {
            const navHtml = Object.entries(routes)
                .filter(([path, route]) => route.roles.includes(role))
                .map(([path, route]) => `
                    <a href="${path}" data-route="${path}"
                       class="nav-link text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-4 py-3 text-sm font-medium rounded-md">
                        <svg class="mr-3 h-5 w-5 flex-shrink-0 text-gray-400 group-hover:text-gray-500" data-lucide="${route.icon}"></svg>
                        ${route.title}
                    </a>
                `).join('');
                
            $('#app-nav').innerHTML = navHtml;
            $('#mobile-app-nav').innerHTML = navHtml;
            
            // Adiciona ícones
            lucide.createIcons({
                nodes: document.querySelectorAll('#app-nav svg, #mobile-app-nav svg')
            });
        }
        
        /**
         * O "router" principal. Lida com a mudança de hash.
         */
        function navigateToHash() {
            // Se estiver no login, não faz nada
            if (!currentUserProfile) return;
            
            const role = currentUserProfile.role;
            let hash = window.location.hash;

            // Se hash estiver vazio ou for inválido, redireciona para a página inicial da role
            if (!hash || !routes[hash] || !routes[hash].roles.includes(role)) {
                if (role === 'administrator') hash = '#/dashboard';
                else if (role === 'reception') hash = '#/agenda';
                else if (role === 'therapist') hash = '#/agenda';
                
                // Atualiza o hash sem adicionar ao histórico
                window.history.replaceState(null, '', hash);
            }
            
            // Oculta todas as páginas
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            
            // Remove o 'active' de todos os links
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('bg-gray-100', 'text-gray-900'));
            
            // Carrega a página correta
            const route = routes[hash];
            if (route) {
                const pageId = hash.substring(2) + '-page'; // ex: #/dashboard -> dashboard-page
                const pageEl = $(`#${pageId}`);
                
                if (pageEl) {
                    pageEl.classList.add('active');
                    $pageTitle.textContent = route.title;
                    
                    // Ativa o link de navegação
                    document.querySelectorAll(`.nav-link[data-route="${hash}"]`).forEach(link => {
                        link.classList.add('bg-gray-100', 'text-gray-900');
                    });
                    
                    // Fecha o menu mobile ao navegar
                    if ($mobileMenu.style.display !== 'none') {
                        toggleMobileMenu();
                    }

                    // Atualizar página atual
                    currentPage = hash;

                    // Remove listeners antigos de páginas que não estamos mais
                    if (hash !== '#/profissionais') removeProfessionalsListener();
                    if (hash !== '#/especialidades') removeSpecialtiesListener();
                    if (hash !== '#/pacientes') removePatientsListener();
                    if (hash !== '#/agendas-fixas') removeFixedSchedulesListener();
                    if (hash !== '#/usuarios') removeUsersListener();

                    // Chama a função de load da página
                    if (route.load) {
                        try {
                            route.load();
                            
                            // Configura listeners em tempo real após carregar a página
                            if (hash === '#/profissionais') setupProfessionalsListener();
                            if (hash === '#/especialidades') setupSpecialtiesListener();
                            if (hash === '#/pacientes') setupPatientsListener();
                            if (hash === '#/agendas-fixas') setupFixedSchedulesListener();
                            if (hash === '#/usuarios') setupUsersListener();
                            
                            // Conecta event listeners após carregar a página
                            setupPageEventListeners();
                        } catch (error) {
                            console.error(`Erro ao carregar a página ${hash}:`, error);
                            showAlert('Erro na Página', `Não foi possível carregar a página ${route.title}.`, 'error');
                        }
                    }
                    
                } else {
                    console.error(`Elemento da página #${pageId} não encontrado.`);
                }
            }
        }
        
        /**
         * Inicializa os listeners de dados principais (ex: agenda)
         */
        function initDataListeners(role, uid) {
            // Limpa listeners antigos (ex: se o usuário trocou)
            clearAllDataListeners();
            
            // Exemplo: Listener para a agenda
            // Esta query pode precisar ser mais específica (ex: por mês)
            let agendaQuery;
            if (role === 'therapist') {
                // Terapeuta só vê a própria agenda
                agendaQuery = query(ref(db, 'appointments'), orderByChild('therapistId'), equalTo(uid));
            } else {
                // Admin/Recepção veem tudo (limitado por performance, idealmente filtrar por data)
                agendaQuery = query(ref(db, 'appointments')); // Perigoso sem filtros!
                console.warn("Query de agenda aberta. Em produção, filtre por data.");
            }
            
            const agendaRef = agendaQuery;
            const agendaListener = onValue(agendaRef, async (snapshot) => {
                const appointmentsData = snapshot.val() || {};
                const appointmentsList = Object.keys(appointmentsData).map(key => ({
                    id: key,
                    ...appointmentsData[key]
                }));
                
                // Atualiza o FullCalendar se ele estiver visível/instanciado
                if (calendarInstance) {
                    const events = await appointmentsToEvents(appointmentsList);
                    calendarInstance.removeAllEvents();
                    calendarInstance.addEventSource(events);
                    updateAgendaStats();
                }
            }, (error) => {
                console.error("Erro ao ouvir agenda:", error);
            });
            
            // Salva o listener para poder removê-lo
            dataListeners.push({ ref: agendaRef, listener: agendaListener });
        }
        
        /**
         * Remove todos os listeners do Firebase abertos.
         */
        function clearAllDataListeners() {
            dataListeners.forEach(({ ref, listener }) => {
                try {
                    off(ref, 'value', listener);
                } catch(e) {
                    console.warn("Erro ao remover listener:", e);
                }
            });
            dataListeners = [];
            console.log("Listeners de dados removidos.");
        }

        /**
         * Controla o menu mobile.
         */
        function toggleMobileMenu() {
            if ($mobileMenu.style.display === 'none') {
                $mobileMenu.style.display = 'block';
                // Adiciona um pequeno delay para a animação de entrada (se houver CSS)
            } else {
                $mobileMenu.style.display = 'none';
            }
        }
        
        /**
         * Função principal de inicialização da aplicação.
         */
        function initApp() {
            // Handlers de Login/Logout
            $loginForm.addEventListener('submit', handleLogin);
            $logoutButton.addEventListener('click', handleLogout);
            $mobileLogoutButton.addEventListener('click', handleLogout);
            
            // Handlers do Menu Mobile
            $mobileMenuButton.addEventListener('click', toggleMobileMenu);
            $mobileMenuClose.addEventListener('click', toggleMobileMenu);
            $mobileMenuOverlay.addEventListener('click', toggleMobileMenu);

            // Handler do Router
            window.addEventListener('hashchange', navigateToHash);
            
            // Handlers de Modal
            $modalSecondaryBtn.addEventListener('click', hideModal);
            
            // Adiciona duplo clique para fechar todos os modais
            const modals = [
                { element: $('#modal-container'), closeFunc: hideModal },
                { element: $('#modal-especialidade'), closeFunc: () => $('#modal-especialidade').style.display = 'none' },
                { element: $('#modal-profissional'), closeFunc: () => $('#modal-profissional').style.display = 'none' },
                { element: $('#modal-status'), closeFunc: () => $('#modal-status').style.display = 'none' },
                { element: $('#modal-paciente'), closeFunc: () => $('#modal-paciente').style.display = 'none' },
                { element: $('#modal-agendamento'), closeFunc: () => $('#modal-agendamento').style.display = 'none' },
                { element: $('#modal-horario-fixo'), closeFunc: () => $('#modal-horario-fixo').classList.add('hidden') },
                { element: $('#modal-usuario'), closeFunc: () => $('#modal-usuario').classList.add('hidden') }
            ];
            
            modals.forEach(modal => {
                if (modal.element) {
                    addDoubleClickToCloseModal(modal.element, modal.closeFunc);
                }
            });

            // Handlers de Sincronização
            window.addEventListener('online', processSyncQueue);
            window.addEventListener('offline', () => updateSyncStatus('offline', 'Offline'));

            // Inicia o DB Offline
            initOfflineDb().then(() => {
                console.log("Banco de dados offline pronto.");
                // Tenta sincronizar ao iniciar
                processSyncQueue();
            });

            // Inicia o listener de autenticação (ponto de entrada)
            initAuthListener();
            
            // Renderiza ícones iniciais (login)
            lucide.createIcons();
        }

        
        // --- VIRTUAL FILE: dashboard.js ---
        
        function destroyCharts() {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
        }

        async function loadDashboardPage() {
            console.log("Carregando Dashboard...");
            
            // Limpa gráficos antigos
            destroyCharts();
            
            try {
                // Buscar todos os dados necessários
                const appointmentsRef = ref(db, 'appointments');
                const patientsRef = ref(db, 'patients');
                const specialtiesRef = ref(db, 'specialties');
                
                const [apptsSnap, patsSnap, specsSnap] = await Promise.all([
                    get(appointmentsRef),
                    get(patientsRef),
                    get(specialtiesRef)
                ]);
                
                const appointments = apptsSnap.exists() ? Object.values(apptsSnap.val()) : [];
                const patients = patsSnap.exists() ? patsSnap.val() : {};
                const specialties = specsSnap.exists() ? specsSnap.val() : {};
                
                // Calcular métricas
                const today = new Date();
                const currentMonth = today.toISOString().slice(0, 7); // YYYY-MM
                
                // Agendamentos do mês atual
                const appointmentsThisMonth = appointments.filter(appt => 
                    appt.date && appt.date.startsWith(currentMonth)
                );
                
                // Cards de Estatísticas
                updateDashboardStats(appointmentsThisMonth, patients);
                
                // Gráfico: Status dos Agendamentos
                renderStatusChart(appointmentsThisMonth);
                
                // Gráfico: Receitas Mensais (últimos 6 meses)
                renderReceitasChart(appointments);
                
                // Ranking de Especialidades
                renderEspecialidadesRanking(appointmentsThisMonth, specialties);
                
                // Inicializa ícones
                lucide.createIcons();
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                showAlert('Erro', 'Não foi possível carregar os dados do dashboard.', 'error');
            }
        }
        
        /**
         * Atualiza cards de estatísticas.
         */
        function updateDashboardStats(appointmentsThisMonth, patients) {
            // Total de Agendamentos
            const totalAgendamentos = appointmentsThisMonth.length;
            $('#stat-total-agendamentos').textContent = totalAgendamentos;
            
            // Taxa de Presença
            const presentes = appointmentsThisMonth.filter(a => a.status === 'present').length;
            const finalizados = appointmentsThisMonth.filter(a => 
                ['present', 'absent', 'cancelled'].includes(a.status)
            ).length;
            const taxaPresenca = finalizados > 0 ? Math.round((presentes / finalizados) * 100) : 0;
            $('#stat-taxa-presenca').textContent = `${taxaPresenca}%`;
            
            // Receita do Mês
            const receitaMes = appointmentsThisMonth
                .filter(a => a.status === 'present' && a.financial)
                .reduce((sum, a) => sum + (a.financial.patientValue || 0), 0);
            $('#stat-receita-mes').textContent = `R$ ${receitaMes.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            
            // Pacotes Ativos
            let pacotesAtivos = 0;
            Object.values(patients).forEach(patient => {
                if (patient.packages && patient.packages.length > 0) {
                    patient.packages.forEach(pkg => {
                        const remaining = pkg.totalSessions - (pkg.usedSessions || 0);
                        if (remaining > 0) pacotesAtivos++;
                    });
                }
            });
            $('#stat-pacotes-ativos').textContent = pacotesAtivos;
        }
        
        /**
         * Renderiza gráfico de status dos agendamentos.
         */
        function renderStatusChart(appointmentsThisMonth) {
            const statusCount = {
                scheduled: 0,
                present: 0,
                absent: 0,
                cancelled: 0
            };
            
            appointmentsThisMonth.forEach(appt => {
                if (statusCount.hasOwnProperty(appt.status)) {
                    statusCount[appt.status]++;
                }
            });
            
            const ctx = $('#chart-status').getContext('2d');
            chartInstances.chartStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Agendado', 'Presente', 'Ausente', 'Cancelado'],
                    datasets: [{
                        data: [
                            statusCount.scheduled,
                            statusCount.present,
                            statusCount.absent,
                            statusCount.cancelled
                        ],
                        backgroundColor: [
                            'rgb(59, 130, 246)',   // Azul
                            'rgb(34, 197, 94)',    // Verde
                            'rgb(239, 68, 68)',    // Vermelho
                            'rgb(156, 163, 175)'   // Cinza
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Renderiza gráfico de receitas mensais (últimos 6 meses).
         */
        function renderReceitasChart(appointments) {
            const today = new Date();
            const months = [];
            const receitas = [];
            
            // Gerar últimos 6 meses
            for (let i = 5; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthKey = date.toISOString().slice(0, 7); // YYYY-MM
                const monthLabel = date.toLocaleDateString('pt-BR', { month: 'short' }).replace('.', '');
                
                months.push(monthLabel);
                
                // Calcular receita do mês
                const receita = appointments
                    .filter(a => 
                        a.date && 
                        a.date.startsWith(monthKey) && 
                        a.status === 'present' && 
                        a.financial
                    )
                    .reduce((sum, a) => sum + (a.financial.patientValue || 0), 0);
                
                receitas.push(receita);
            }
            
            const ctx = $('#chart-receitas').getContext('2d');
            chartInstances.chartReceitas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Receita (R$)',
                        data: receitas,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `R$ ${context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Renderiza ranking de especialidades.
         */
        function renderEspecialidadesRanking(appointmentsThisMonth, specialties) {
            // Contar atendimentos por especialidade
            const specCount = {};
            
            appointmentsThisMonth.forEach(appt => {
                if (appt.specialtyId) {
                    specCount[appt.specialtyId] = (specCount[appt.specialtyId] || 0) + 1;
                }
            });
            
            // Converter para array e ordenar
            const ranking = Object.entries(specCount)
                .map(([id, count]) => ({
                    id,
                    name: specialties[id]?.name || 'Desconhecida',
                    count,
                    color: specialties[id]?.color || '#3B82F6'
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5); // Top 5
            
            // Encontrar o máximo para calcular percentual
            const maxCount = ranking.length > 0 ? ranking[0].count : 1;
            
            // Renderizar HTML
            const container = $('#ranking-especialidades');
            
            if (ranking.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                        <p class="text-sm">Nenhum atendimento neste mês</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = ranking.map((spec, index) => {
                const percentage = Math.round((spec.count / maxCount) * 100);
                const colors = [
                    'bg-purple-500',
                    'bg-blue-500',
                    'bg-green-500',
                    'bg-yellow-500',
                    'bg-orange-500'
                ];
                
                return `
                    <div class="flex items-center gap-4">
                        <div class="flex-shrink-0 w-8 text-center">
                            <span class="text-2xl font-bold text-gray-400">${index + 1}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-semibold text-gray-900">${spec.name}</span>
                                <span class="text-sm font-medium text-gray-600">${spec.count} atend.</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="${colors[index]} h-2.5 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }


        // --- VIRTUAL FILE: agenda.js ---

        /**
         * Converte appointments do Firebase para eventos do FullCalendar
         */
        /**
         * Converte appointments em eventos do FullCalendar
         */
        async function appointmentsToEvents(appointments) {
            // Filtrar apenas agendamentos com data e hora válidas
            const validAppointments = appointments.filter(appt => 
                appt && appt.date && appt.time && appt.therapistId
            );
            
            if (validAppointments.length === 0) {
                console.log('Nenhum agendamento válido encontrado');
                return [];
            }
            
            // Cache para nomes
            const patientsCache = {};
            const professionalsCache = {};
            
            const events = await Promise.all(validAppointments.map(async (appt) => {
                const start = `${appt.date}T${appt.time}`;
                
                // Verificar se tem paciente (agendamento confirmado) ou é slot vago
                let patientName = appt.patientId ? 'Paciente' : 'Horário Disponível';
                let isAvailable = !appt.patientId;
                
                if (appt.patientId) {
                    if (!patientsCache[appt.patientId]) {
                        try {
                            const patientSnapshot = await get(ref(db, `patients/${appt.patientId}`));
                            if (patientSnapshot.exists()) {
                                patientsCache[appt.patientId] = patientSnapshot.val().name;
                            }
                        } catch (error) {
                            console.error('Erro ao buscar paciente:', error);
                        }
                    }
                    patientName = patientsCache[appt.patientId] || 'Paciente';
                }
                
                // Buscar nome do profissional
                let therapistName = 'Profissional';
                if (appt.therapistId) {
                    if (!professionalsCache[appt.therapistId]) {
                        try {
                            const profSnapshot = await get(ref(db, `professionals/${appt.therapistId}`));
                            if (profSnapshot.exists()) {
                                professionalsCache[appt.therapistId] = profSnapshot.val().name;
                            }
                        } catch (error) {
                            console.error('Erro ao buscar profissional:', error);
                        }
                    }
                    therapistName = professionalsCache[appt.therapistId] || 'Profissional';
                }
                
                // Título do evento
                const title = isAvailable ? `🕐 Disponível - ${therapistName}` : patientName;
                
                // Cor do evento
                let backgroundColor, borderColor;
                if (isAvailable) {
                    // Slot vago - cor cinza claro
                    backgroundColor = '#e5e7eb';
                    borderColor = '#9ca3af';
                } else {
                    // Agendamento com paciente - cor por status
                    backgroundColor = getStatusColor(appt.status);
                    borderColor = getStatusColor(appt.status);
                }
                
                return {
                    id: appt.id,
                    title: title,
                    start: start,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    textColor: isAvailable ? '#6b7280' : '#ffffff',
                    extendedProps: {
                        ...appt,
                        patientName: patientName,
                        therapistName: therapistName,
                        isAvailable: isAvailable
                    }
                };
            }));
            
            return events;
        }

        function loadAgendaPage() {
            console.log("Carregando Agenda...");
            const calendarEl = $('#calendar');
            
            // Popular filtros
            populateAgendaFilters();
            
            // Configurar eventos de filtro
            setupAgendaFilterListeners();
            
            // Destrói instância antiga se existir
            if (calendarInstance) {
                calendarInstance.destroy();
            }

            calendarInstance = new FullCalendar.Calendar(calendarEl, {
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                buttonText: {
                    today: 'Hoje',
                    month: 'Mês',
                    week: 'Semana',
                    day: 'Dia',
                    list: 'Lista'
                },
                initialView: 'dayGridMonth',
                editable: true,
                selectable: true,
                slotMinTime: '07:00:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                height: 'auto',
                expandRows: true,
                
                // Configurações de visualização
                views: {
                    dayGridMonth: {
                        dayMaxEvents: 3,
                        moreLinkText: 'mais',
                        displayEventTime: true,
                        displayEventEnd: false
                    },
                    timeGridWeek: {
                        slotLabelFormat: {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        },
                        eventTimeFormat: {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        }
                    },
                    timeGridDay: {
                        slotLabelFormat: {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        },
                        eventTimeFormat: {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        }
                    },
                    listWeek: {
                        listDayFormat: {
                            weekday: 'long',
                            day: 'numeric',
                            month: 'long'
                        },
                        listDaySideFormat: false
                    }
                },
                
                // Cores e conteúdo dos eventos
                eventDidMount: function(info) {
                    const status = info.event.extendedProps.status;
                    const patientName = info.event.extendedProps.patientName || 'Paciente';
                    const therapistName = info.event.extendedProps.therapistName || 'Profissional';
                    
                    // Aplicar cores
                    info.el.style.backgroundColor = getStatusColor(status);
                    info.el.style.borderColor = getStatusColor(status);
                    info.el.style.borderLeft = `4px solid ${getStatusColor(status)}`;
                    
                    // Customizar conteúdo do evento
                    const timeText = info.el.querySelector('.fc-event-time');
                    const titleText = info.el.querySelector('.fc-event-title');
                    
                    if (titleText) {
                        titleText.innerHTML = `<strong>${patientName}</strong><br><small>${therapistName}</small>`;
                    }
                    
                    // Adicionar tooltip
                    info.el.title = `${patientName}\n${therapistName}\nStatus: ${getStatusLabel(status)}`;
                },
                
                // Atualizar estatísticas ao mudar de view
                datesSet: function(info) {
                    updateAgendaStats();
                },
                
                // --- Event Handlers ---
                
                /**
                 * Clique em um evento existente (atendimento)
                 */
                eventClick: (info) => {
                    const appt = {
                        id: info.event.id,  // Garantir que o ID do evento está incluído
                        ...info.event.extendedProps
                    };
                    console.log("Clicou no evento:", appt);
                    console.log("Event ID:", info.event.id);
                    console.log("Extended Props:", info.event.extendedProps);
                    showAttendanceModal(appt);
                },

                /**
                 * Clique em um horário vago (novo atendimento)
                 */
                select: (info) => {
                    console.log("Selecionou horário:", info);
                    showAppointmentModal(null, {
                        date: info.start.toISOString().split('T')[0],
                        time: info.start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                        therapistId: (currentUserProfile.role === 'therapist') ? currentUserProfile.uid : null
                    });
                    calendarInstance.unselect();
                },
                
                /**
                 * Arrastar e soltar um evento (mudar horário)
                 */
                eventDrop: async (info) => {
                    const appt = info.event.extendedProps;
                    const newDate = info.event.start.toISOString().split('T')[0];
                    const newTime = info.event.start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    console.log(`Movendo ${appt.id} para ${newDate} ${newTime}`);
                    
                    // 1. Verificar Conflito
                    const conflict = await checkAppointmentConflict(newDate, newTime, appt.therapistId, appt.patientId, appt.id);
                    if (conflict) {
                        showAlert('Conflito de Horário', conflict, 'error');
                        info.revert(); // Reverte a mudança visual
                        return;
                    }
                    
                    // 2. Salvar alteração
                    try {
                        const apptRef = ref(db, `appointments/${appt.id}`);
                        await update(apptRef, {
                            date: newDate,
                            time: newTime,
                            // TODO: Log de auditoria
                        });
                        console.log("Atendimento movido com sucesso.");
                        updateAgendaStats();
                    } catch (error) {
                        console.error("Erro ao mover atendimento:", error);
                        showAlert('Erro', 'Não foi possível salvar a alteração.', 'error');
                        info.revert();
                    }
                }
            });
            
            // Força a renderização e o carregamento dos dados que o listener já pode ter
            calendarInstance.render();
            // Dispara o listener de dados novamente para carregar
            initDataListeners(currentUserProfile.role, currentUserProfile.uid); 
            
            // Atualizar estatísticas iniciais
            setTimeout(() => updateAgendaStats(), 500);
        }
        
        /**
         * Retorna cor baseada no status
         */
        function getStatusColor(status) {
            const colors = {
                'scheduled': '#3b82f6', // blue-500
                'confirmed': '#10b981', // green-500
                'present': '#8b5cf6',   // purple-500
                'absent': '#ef4444',    // red-500
                'cancelled': '#9ca3af'  // gray-400
            };
            return colors[status] || colors.scheduled;
        }
        
        /**
         * Popula os filtros da agenda
         */
        async function populateAgendaFilters() {
            try {
                // Carregar profissionais
                const profsRef = ref(db, 'professionals');
                const profsSnapshot = await get(profsRef);
                
                const therapistFilter = $('#filter-calendar-therapist');
                if (therapistFilter) {
                    therapistFilter.innerHTML = '<option value="">Todos os Profissionais</option>';
                    
                    if (profsSnapshot.exists()) {
                        const profs = profsSnapshot.val();
                        Object.keys(profs).forEach(id => {
                            const prof = profs[id];
                            if (prof.active !== false) {
                                const option = document.createElement('option');
                                option.value = id;
                                option.textContent = prof.name;
                                therapistFilter.appendChild(option);
                            }
                        });
                    }
                }
                
                // Carregar especialidades
                const specsRef = ref(db, 'specialties');
                const specsSnapshot = await get(specsRef);
                
                const specialtyFilter = $('#filter-calendar-specialty');
                if (specialtyFilter) {
                    specialtyFilter.innerHTML = '<option value="">Todas as Especialidades</option>';
                    
                    if (specsSnapshot.exists()) {
                        const specs = specsSnapshot.val();
                        Object.keys(specs).forEach(id => {
                            const spec = specs[id];
                            if (spec.active !== false) {
                                const option = document.createElement('option');
                                option.value = id;
                                option.textContent = spec.name;
                                specialtyFilter.appendChild(option);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao popular filtros:', error);
            }
        }
        
        /**
         * Configura listeners dos filtros
         */
        function setupAgendaFilterListeners() {
            const applyBtn = $('#apply-calendar-filters');
            if (applyBtn) {
                applyBtn.addEventListener('click', applyAgendaFilters);
            }
        }
        
        /**
         * Aplica filtros no calendário
         */
        function applyAgendaFilters() {
            if (!calendarInstance) return;
            
            const therapistId = $('#filter-calendar-therapist')?.value;
            const specialtyId = $('#filter-calendar-specialty')?.value;
            const status = $('#filter-calendar-status')?.value;
            
            // Recarregar eventos com filtros
            const events = calendarInstance.getEvents();
            
            events.forEach(event => {
                const props = event.extendedProps;
                let show = true;
                
                if (therapistId && props.therapistId !== therapistId) show = false;
                if (specialtyId && props.specialtyId !== specialtyId) show = false;
                if (status && props.status !== status) show = false;
                
                if (show) {
                    event.setProp('display', 'auto');
                } else {
                    event.setProp('display', 'none');
                }
            });
            
            updateAgendaStats();
        }
        
        /**
         * Atualiza estatísticas da agenda
         */
        function updateAgendaStats() {
            if (!calendarInstance) return;
            
            const today = new Date().toISOString().split('T')[0];
            const events = calendarInstance.getEvents();
            
            // Filtrar eventos de hoje que estão visíveis
            const todayEvents = events.filter(e => {
                const eventDate = e.start.toISOString().split('T')[0];
                return eventDate === today && e.display !== 'none';
            });
            
            const totalToday = todayEvents.length;
            const confirmed = todayEvents.filter(e => e.extendedProps.status === 'confirmed').length;
            const pending = todayEvents.filter(e => e.extendedProps.status === 'scheduled').length;
            const present = todayEvents.filter(e => e.extendedProps.status === 'present').length;
            
            // Atualizar DOM
            const totalEl = $('#stat-total-today');
            const confirmedEl = $('#stat-confirmed');
            const pendingEl = $('#stat-pending');
            const presentEl = $('#stat-present');
            
            if (totalEl) totalEl.textContent = totalToday;
            if (confirmedEl) confirmedEl.textContent = confirmed;
            if (pendingEl) pendingEl.textContent = pending;
            if (presentEl) presentEl.textContent = present;
        }

        /**
         * Modal de Novo Atendimento / Edição
         */
        async function showAppointmentModal(appointmentData = null, defaults = {}) {
            const isEditing = !!appointmentData;
            const data = isEditing ? appointmentData : defaults;
            
            const title = isEditing ? 'Editar Atendimento' : 'Novo Atendimento';
            
            // Buscar dados ANTES de montar o HTML
            let patientsOptions = '<option value="">Selecione...</option>';
            let professionalsOptions = '<option value="">Selecione...</option>';
            let specialtiesOptions = '<option value="">Selecione...</option>';
            
            try {
                // Buscar pacientes
                const patientsSnapshot = await get(ref(db, 'patients'));
                if (patientsSnapshot.exists()) {
                    const patients = patientsSnapshot.val();
                    Object.keys(patients).forEach(id => {
                        const patient = patients[id];
                        if (patient.active !== false) {
                            const selected = data.patientId === id ? 'selected' : '';
                            patientsOptions += `<option value="${id}" ${selected}>${patient.name}</option>`;
                        }
                    });
                }
                
                // Buscar profissionais
                const professionalsSnapshot = await get(ref(db, 'professionals'));
                if (professionalsSnapshot.exists()) {
                    const professionals = professionalsSnapshot.val();
                    Object.keys(professionals).forEach(id => {
                        const prof = professionals[id];
                        if (prof.active !== false) {
                            const selected = data.therapistId === id ? 'selected' : '';
                            professionalsOptions += `<option value="${id}" ${selected}>${prof.name}</option>`;
                        }
                    });
                }
                
                // Buscar especialidades
                const specialtiesSnapshot = await get(ref(db, 'specialties'));
                if (specialtiesSnapshot.exists()) {
                    const specialties = specialtiesSnapshot.val();
                    Object.keys(specialties).forEach(id => {
                        const specialty = specialties[id];
                        if (specialty.active !== false) {
                            const selected = data.specialtyId === id ? 'selected' : '';
                            specialtiesOptions += `<option value="${id}" ${selected}>${specialty.name}</option>`;
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
            
            const contentHtml = `
                <form id="appointment-form" class="space-y-4">
                    <input type="hidden" id="appt-id" value="${data.id || ''}">
                    <div>
                        <label for="appt-patient" class="block text-sm font-medium text-gray-700">Paciente</label>
                        <select id="appt-patient" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            ${patientsOptions}
                        </select>
                    </div>
                    <div>
                        <label for="appt-therapist" class="block text-sm font-medium text-gray-700">Profissional</label>
                        <select id="appt-therapist" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            ${professionalsOptions}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="appt-date" class="block text-sm font-medium text-gray-700">Data</label>
                            <input type="date" id="appt-date" value="${data.date || ''}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="appt-time" class="block text-sm font-medium text-gray-700">Hora</label>
                            <input type="time" id="appt-time" value="${data.time || ''}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                     <div>
                        <label for="appt-specialty" class="block text-sm font-medium text-gray-700">Especialidade</label>
                        <select id="appt-specialty" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            ${specialtiesOptions}
                        </select>
                    </div>
                </form>
            `;
            
            showModal({
                title,
                contentHtml,
                icon: 'calendar-plus',
                primaryText: isEditing ? 'Atualizar' : 'Salvar',
                onPrimaryClick: handleSaveAppointment,
                onSecondaryClick: hideModal
            });
            
            // Prevenir submit do formulário
            const appointmentForm = $('#appointment-form');
            if (appointmentForm) {
                appointmentForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    return false;
                });
            }
        }

        /**
         * Modal de Registro de Presença
         */
        async function showAttendanceModal(appointmentData) {
            const title = `Registrar Atendimento`;
            
            // Debug: verificar dados recebidos
            console.log("showAttendanceModal - appointmentData:", appointmentData);
            
            // Garantir que temos um ID
            const appointmentId = appointmentData.id || appointmentData.appointmentId || '';
            
            if (!appointmentId) {
                console.error("Erro: appointmentData não contém ID:", appointmentData);
                showAlert('Erro', 'Não foi possível identificar o evento. Tente novamente.', 'error');
                return;
            }
            
            // Carregar lista de pacientes para o select
            let patientsOptionsHtml = '<option value="">Selecione um paciente</option>';
            try {
                const patientsSnapshot = await get(ref(db, 'patients'));
                if (patientsSnapshot.exists()) {
                    const patients = patientsSnapshot.val();
                    Object.keys(patients).forEach(id => {
                        const selected = appointmentData.patientId === id ? 'selected' : '';
                        patientsOptionsHtml += `<option value="${id}" ${selected}>${patients[id].name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar pacientes:', error);
            }
            
            const contentHtml = `
                <form id="attendance-form" class="space-y-4">
                    <input type="hidden" id="attendance-appt-id" value="${appointmentId}">
                    
                    <div>
                        <label for="attendance-patient-select" class="block text-sm font-medium text-gray-700">Paciente</label>
                        <select id="attendance-patient-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            ${patientsOptionsHtml}
                        </select>
                    </div>
                    
                    <p><strong>Profissional:</strong> ${appointmentData.therapistName || 'Profissional'}</p>
                    <p><strong>Data/Hora:</strong> ${formatDate(appointmentData.date)} às ${appointmentData.time}</p>
                    
                    <fieldset class="mt-4">
                        <legend class="text-base font-medium text-gray-900">Status do Atendimento</legend>
                        <div class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="status-presence" name="status" type="radio" value="presence" ${appointmentData.status === 'presence' ? 'checked' : ''} class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="status-presence" class="ml-3 block text-sm font-medium text-gray-700">Presença</label>
                            </div>
                            <div class="flex items-center">
                                <input id="status-absence" name="status" type="radio" value="absence" ${appointmentData.status === 'absence' ? 'checked' : ''} class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="status-absence" class="ml-3 block text-sm font-medium text-gray-700">Ausência (Gera cobrança)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="status-cancellation" name="status" type="radio" value="cancellation" ${appointmentData.status === 'cancellation' ? 'checked' : ''} class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="status-cancellation" class="ml-3 block text-sm font-medium text-gray-700">Cancelamento (Não gera cobrança)</label>
                            </div>
                        </div>
                    </fieldset>
                    
                    <div>
                        <label for="appt-observation" class="block text-sm font-medium text-gray-700">Observação</label>
                        <textarea id="appt-observation" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${appointmentData.observation || ''}</textarea>
                        <p id="observation-warning" class="text-xs text-red-600 mt-1" style="display: none;">Observação é obrigatória para cancelamento.</p>
                    </div>
                </form>
            `;
            
            // Configurar modal com botões condicionais
            const modalConfig = {
                title,
                contentHtml,
                icon: 'check-square',
                primaryText: 'Salvar',
                onPrimaryClick: handleMarkAttendance,
                onSecondaryClick: hideModal
            };
            
            // Adicionar botão de exclusão apenas para administradores
            if (currentUserProfile && currentUserProfile.role === 'administrator') {
                modalConfig.tertiaryText = 'Excluir Evento';
                modalConfig.tertiaryClass = 'bg-red-600 hover:bg-red-700 text-white';
                modalConfig.onTertiaryClick = () => confirmDeleteAppointment(appointmentData.id);
            }
            
            showModal(modalConfig);
            
            // Prevenir submit do formulário
            const attendanceForm = $('#attendance-form');
            if (attendanceForm) {
                attendanceForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    return false;
                });
            }
            
            // Adiciona listener para o campo 'Cancelamento'
            const radioCancel = $('#status-cancellation');
            const obsWarning = $('#observation-warning');
            if (radioCancel && obsWarning) {
                radioCancel.addEventListener('change', () => {
                    if (radioCancel.checked) {
                        obsWarning.style.display = 'block';
                    }
                });
            }
            
            const radioPresence = $('#status-presence');
            const radioAbsence = $('#status-absence');
            if (radioPresence && obsWarning) {
                radioPresence.addEventListener('change', () => obsWarning.style.display = 'none');
            }
            if (radioAbsence && obsWarning) {
                radioAbsence.addEventListener('change', () => obsWarning.style.display = 'none');
            }
        }

        /**
         * Salva o registro de presença (Presença/Ausência/Cancelamento)
         */
        async function handleMarkAttendance() {
            const appointmentIdEl = $('#attendance-appt-id');
            const appointmentId = appointmentIdEl ? appointmentIdEl.value : null;
            
            if (!appointmentId) {
                showAlert('Erro', 'ID do atendimento não encontrado.', 'error');
                return;
            }
            
            const patientSelectEl = $('#attendance-patient-select');
            const selectedPatientId = patientSelectEl ? patientSelectEl.value : null;
            
            if (!selectedPatientId) {
                showAlert('Campo Obrigatório', 'Selecione um paciente.', 'warning');
                return;
            }
            
            const statusChecked = document.querySelector('input[name="status"]:checked');
            const newStatus = statusChecked ? statusChecked.value : null;
            
            if (!newStatus) {
                showAlert('Campo Obrigatório', 'Selecione um status (Presença/Ausência/Cancelamento).', 'warning');
                return;
            }
            
            const observationEl = $('#appt-observation');
            const observation = observationEl ? observationEl.value : '';

            // Validação de Cancelamento
            if (newStatus === 'cancellation' && !observation.trim()) {
                const obsWarningEl = $('#observation-warning');
                if (obsWarningEl) obsWarningEl.style.display = 'block';
                showAlert('Campo Obrigatório', 'A observação é obrigatória ao marcar um cancelamento.', 'warning');
                return;
            }

            const dataToUpdate = {
                patientId: selectedPatientId,
                status: newStatus,
                observation: observation,
                recordedBy: currentUserProfile.uid,
                recordedAt: serverTimestamp()
            };
            
            console.log("Atualizando atendimento:", appointmentId, dataToUpdate);

            try {
                const apptRef = ref(db, `appointments/${appointmentId}`);
                await update(apptRef, dataToUpdate);
                console.log("Status de atendimento atualizado com sucesso.");
                hideModal();
                // O FullCalendar será atualizado pelo listener (onValue)
            } catch (error) {
                console.error("Erro ao registrar presença:", error);
                showAlert('Erro', 'Não foi possível salvar o registro.', 'error');
                // TODO: Adicionar à fila offline
                // addToSyncQueue('UPDATE_ATTENDANCE', { appointmentId, data: dataToUpdate });
            }
        }
        
        /**
         * Confirmação para excluir um evento/agendamento
         */
        async function confirmDeleteAppointment(appointmentId) {
            if (!appointmentId) {
                showAlert('Erro', 'ID do evento não encontrado.', 'error');
                return;
            }
            
            // Buscar dados do evento para mostrar na confirmação
            try {
                const apptRef = ref(db, `appointments/${appointmentId}`);
                const snapshot = await get(apptRef);
                
                if (!snapshot.exists()) {
                    showAlert('Erro', 'Evento não encontrado.', 'error');
                    return;
                }
                
                const apptData = snapshot.val();
                
                // Buscar nome do paciente
                let patientName = 'Sem paciente';
                if (apptData.patientId) {
                    const patientSnapshot = await get(ref(db, `patients/${apptData.patientId}`));
                    if (patientSnapshot.exists()) {
                        patientName = patientSnapshot.val().name;
                    }
                }
                
                const eventInfo = `
Data: ${formatDate(apptData.date)}
Horário: ${apptData.time}
Paciente: ${patientName}
                `.trim();
                
                const confirmed = await showConfirm(
                    '⚠️ Excluir Evento da Agenda',
                    `Tem certeza que deseja EXCLUIR este evento?\n\n${eventInfo}\n\nEsta ação NÃO pode ser desfeita.`
                );
                
                if (!confirmed) return;
                
                await deleteAppointment(appointmentId);
                
            } catch (error) {
                console.error("Erro ao buscar dados do evento:", error);
                showAlert('Erro', 'Não foi possível carregar os dados do evento.', 'error');
            }
        }
        
        /**
         * Exclui um evento/agendamento
         */
        async function deleteAppointment(appointmentId) {
            try {
                showGlobalLoader();
                
                // Buscar dados antes de excluir (para auditoria)
                const apptRef = ref(db, `appointments/${appointmentId}`);
                const snapshot = await get(apptRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Erro', 'Evento não encontrado.', 'error');
                    return;
                }
                
                const apptData = snapshot.val();
                
                // Excluir o evento
                await set(apptRef, null);
                
                // Registrar auditoria
                await logAudit('delete', 'appointment', appointmentId, [
                    { field: 'date', oldValue: apptData.date, newValue: '' },
                    { field: 'time', oldValue: apptData.time, newValue: '' },
                    { field: 'patientId', oldValue: apptData.patientId || '', newValue: '' },
                    { field: 'action', oldValue: 'active', newValue: 'Evento excluído pelo administrador' }
                ]);
                
                hideGlobalLoader();
                hideModal();
                showAlert('Sucesso', 'Evento excluído com sucesso!', 'success');
                
                // Atualizar agenda se estiver aberta
                if (currentPage === '#/agenda' && calendarInstance) {
                    calendarInstance.refetchEvents();
                }
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao excluir evento:", error);
                showAlert('Erro', 'Não foi possível excluir o evento: ' + error.message, 'error');
            }
        }
        
        /**
         * Salva um novo atendimento ou edição.
         */
        async function handleSaveAppointment() {
            // Coleta dados do form
            const appointmentIdEl = $('#appt-id');
            const appointmentId = appointmentIdEl ? appointmentIdEl.value : '';
            
            const patientEl = $('#appt-patient');
            const therapistEl = $('#appt-therapist');
            const dateEl = $('#appt-date');
            const timeEl = $('#appt-time');
            const specialtyEl = $('#appt-specialty');
            
            // Debug: verificar se os elementos existem
            console.log('Elementos do formulário:', {
                patientEl,
                therapistEl,
                dateEl,
                timeEl,
                specialtyEl
            });
            
            const patientId = patientEl?.value;
            const therapistId = therapistEl?.value;
            const date = dateEl?.value;
            const time = timeEl?.value;
            const specialtyId = specialtyEl?.value;
            
            // Debug: verificar valores
            console.log('Valores do formulário:', {
                patientId,
                therapistId,
                date,
                time,
                specialtyId
            });
            
            // Validação simples
            if (!patientId || !therapistId || !date || !time || !specialtyId) {
                showAlert('Campos Vazios', 'Por favor, preencha todos os campos.', 'warning');
                return;
            }

            const isEditing = !!appointmentId;
            
            // 1. Verificar Conflito
            const conflict = await checkAppointmentConflict(date, time, therapistId, patientId, appointmentId);
            if (conflict) {
                showAlert('Conflito de Horário', conflict, 'error');
                return;
            }
            
            // 2. Montar objeto
            const appointmentData = {
                patientId,
                therapistId,
                date,
                time,
                specialtyId,
                status: 'scheduled', // Padrão
                recordedBy: currentUserProfile.uid,
                recordedAt: serverTimestamp()
            };

            // 3. Salvar no Firebase
            try {
                let apptRef;
                if (isEditing) {
                    // Atualiza
                    apptRef = ref(db, `appointments/${appointmentId}`);
                    await update(apptRef, appointmentData);
                    console.log("Atendimento atualizado com sucesso.");
                } else {
                    // Cria novo
                    apptRef = push(ref(db, 'appointments'));
                    await set(apptRef, appointmentData);
                    console.log("Atendimento criado com sucesso.");
                }
                hideModal();
                // O FullCalendar será atualizado pelo listener
            } catch (error) {
                console.error("Erro ao salvar atendimento:", error);
                showAlert('Erro', 'Não foi possível salvar o atendimento.', 'error');
                // TODO: Adicionar à fila offline
            }
        }

        // --- VIRTUAL FILE: pacientes.js ---
        
        // Cache local de pacientes para busca
        let localPatientsCache = [];

        async function loadPacientesPage() {
            console.log("Carregando Pacientes...");
            // Limpa a tabela
            const tableBody = $('#pacientes-table-body');
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">Carregando...</td></tr>`;

            try {
                const patientsRef = ref(db, 'patients');
                const snapshot = await get(patientsRef);
                
                if (!snapshot.exists()) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">Nenhum paciente encontrado.</td></tr>`;
                    localPatientsCache = [];
                    return;
                }
                
                const patientsData = snapshot.val();
                localPatientsCache = Object.keys(patientsData).map(key => ({
                    id: key,
                    ...patientsData[key]
                }));
                
                renderPacientesTable(localPatientsCache);

            } catch (error) {
                console.error("Erro ao buscar pacientes:", error);
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-red-500">Erro ao carregar pacientes.</td></tr>`;
            }
        }
        
        /**
         * Renderiza a tabela de pacientes
         */
        function renderPacientesTable(patients) {
            const tableBody = $('#pacientes-table-body');
            if (patients.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">Nenhum paciente encontrado.</td></tr>`;
                 return;
            }
            
            tableBody.innerHTML = patients.map(patient => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${patient.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${patient.responsible?.name || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${patient.responsible?.phone ? formatPhone(patient.responsible.phone) : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${patient.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${patient.status === 'active' ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editPaciente('${patient.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                            Editar
                        </button>
                        <button onclick="viewPatientDetails('${patient.id}')" class="text-gray-600 hover:text-gray-900">
                            Detalhes
                        </button>
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons({ nodes: tableBody.querySelectorAll('svg') });
        }

        // Listeners em tempo real para pacientes
        let patientsListener = null;
        
        function setupPatientsListener() {
            // Remove listener anterior se existir
            if (patientsListener) {
                off(ref(db, 'patients'), 'value', patientsListener);
            }
            
            // Configura novo listener
            const patientsRef = ref(db, 'patients');
            patientsListener = onValue(patientsRef, (snapshot) => {
                // Só atualiza se estivermos na página de pacientes
                if (currentPage === '#/pacientes') {
                    if (!snapshot.exists()) {
                        localPatientsCache = [];
                        renderPacientesTable([]);
                        return;
                    }
                    
                    const patientsData = snapshot.val();
                    localPatientsCache = Object.keys(patientsData).map(key => ({
                        id: key,
                        ...patientsData[key]
                    }));
                    
                    renderPacientesTable(localPatientsCache);
                }
            });
        }
        
        function removePatientsListener() {
            if (patientsListener) {
                off(ref(db, 'patients'), 'value', patientsListener);
                patientsListener = null;
            }
        }

        // Listeners em tempo real para usuários
        let usersListener = null;
        
        function setupUsersListener() {
            // Remove listener anterior se existir
            if (usersListener) {
                off(ref(db, 'users'), 'value', usersListener);
            }
            
            // Configura novo listener
            const usersRef = ref(db, 'users');
            usersListener = onValue(usersRef, (snapshot) => {
                // Só atualiza se estivermos na página de usuários
                if (currentPage === '#/usuarios') {
                    allUsers = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        allUsers = Object.keys(data).map(id => ({
                            id,
                            ...data[id]
                        }));
                    }
                    renderUsuariosTable(allUsers);
                }
            });
        }
        
        function removeUsersListener() {
            if (usersListener) {
                off(ref(db, 'users'), 'value', usersListener);
                usersListener = null;
            }
        }

        /**
         * Visualiza detalhes do paciente (pacotes, valores customizados, etc).
         */
        async function viewPatientDetails(patientId) {
            try {
                showGlobalLoader();
                const patientRef = ref(db, `patients/${patientId}`);
                const snapshot = await get(patientRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Erro', 'Paciente não encontrado.', 'error');
                    return;
                }
                
                const patient = snapshot.val();
                hideGlobalLoader();
                
                // Montar HTML com informações detalhadas
                let packagesHtml = '<p class="text-gray-500">Nenhum pacote ativo</p>';
                if (patient.packages && Object.keys(patient.packages).length > 0) {
                    packagesHtml = `
                        <div class="space-y-2">
                            ${Object.entries(patient.packages).map(([pkgId, pkg]) => `
                                <div class="p-3 bg-gray-50 rounded-md">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-medium text-sm">Especialidade: ${pkg.specialtyId}</p>
                                            <p class="text-sm text-gray-600">Sessões: ${pkg.usedSessions || 0}/${pkg.totalSessions}</p>
                                            <p class="text-sm text-gray-600">Valor/sessão: R$ ${(pkg.valuePerSession || 0).toFixed(2)}</p>
                                        </div>
                                        <span class="px-2 py-1 text-xs rounded-full ${pkg.active !== false ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                            ${pkg.active !== false ? 'Ativo' : 'Inativo'}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                let customValuesHtml = '<p class="text-gray-500">Valores padrão</p>';
                if (patient.customValues && Object.keys(patient.customValues).length > 0) {
                    customValuesHtml = `
                        <div class="space-y-1">
                            ${Object.entries(patient.customValues).map(([specId, data]) => `
                                <p class="text-sm"><strong>${specId}:</strong> R$ ${data.value.toFixed(2)}</p>
                            `).join('')}
                        </div>
                    `;
                }
                
                const detailsHtml = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Informações Pessoais</h4>
                            <p class="text-sm"><strong>Nome:</strong> ${patient.name}</p>
                            <p class="text-sm"><strong>Data de Nascimento:</strong> ${patient.birthDate}</p>
                            <p class="text-sm"><strong>Responsável:</strong> ${patient.responsible?.name}</p>
                            <p class="text-sm"><strong>Telefone:</strong> ${patient.responsible?.phone ? formatPhone(patient.responsible.phone) : '-'}</p>
                            <p class="text-sm"><strong>CPF:</strong> ${patient.responsible?.cpf ? formatCPF(patient.responsible.cpf) : '-'}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Desconto Global</h4>
                            <p class="text-sm">${patient.globalDiscount || 0}%</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Valores Customizados</h4>
                            ${customValuesHtml}
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Pacotes</h4>
                            ${packagesHtml}
                        </div>
                    </div>
                `;
                
                showModal({
                    title: `Detalhes: ${patient.name}`,
                    contentHtml: detailsHtml,
                    icon: 'user',
                    primaryText: 'Editar',
                    onPrimaryClick: () => {
                        hideModal();
                        editPaciente(patientId);
                    },
                    secondaryText: 'Fechar',
                    onSecondaryClick: hideModal
                });
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao buscar detalhes do paciente:", error);
                showAlert('Erro', 'Não foi possível carregar os detalhes do paciente.', 'error');
            }
        }
        
        /**
         * Modal de Novo Paciente / Edição (LEGADO - será removido)
         */
        function showPatientModal(patientData = null) {
            // Esta função foi substituída por openModalPaciente
            // Mantida para compatibilidade com código antigo
            if (patientData) {
                editPaciente(patientData.id);
            } else {
                openModalPaciente();
                openModalPaciente();
            }
        }

        // --- VIRTUAL FILE: pagamentos.js ---
        // --- VIRTUAL FILE: pagamentos.js ---
        
        let financialData = {
            appointments: [],
            professionals: {},
            specialties: {},
            patients: {},
            filtered: []
        };
        
        async function loadPagamentosPage() {
            console.log("Carregando Gestão Financeira...");
            
            try {
                showGlobalLoader();
                
                // Carregar todos os dados necessários
                await Promise.all([
                    loadFinancialAppointments(),
                    loadFinancialProfessionals(),
                    loadFinancialSpecialties(),
                    loadFinancialPatients()
                ]);
                
                // Popular filtros
                populateFinancialFilters();
                
                // Configurar listeners dos filtros
                setupFinancialFilters();
                
                // Aplicar filtros e renderizar
                applyFinancialFilters();
                
                hideGlobalLoader();
                
                // Criar ícones
                lucide.createIcons({ nodes: $('#financeiro-page') });
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao carregar gestão financeira:", error);
                showAlert('Erro', 'Não foi possível carregar os dados financeiros.', 'error');
            }
        }
        
        async function loadFinancialAppointments() {
            const appointmentsRef = ref(db, 'appointments');
            const snapshot = await get(appointmentsRef);
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                financialData.appointments = Object.keys(data).map(id => ({
                    id,
                    ...data[id]
                }));
            } else {
                financialData.appointments = [];
            }
        }
        
        async function loadFinancialProfessionals() {
            const professionalsRef = ref(db, 'professionals');
            const snapshot = await get(professionalsRef);
            
            if (snapshot.exists()) {
                financialData.professionals = snapshot.val();
            } else {
                financialData.professionals = {};
            }
        }
        
        async function loadFinancialSpecialties() {
            const specialtiesRef = ref(db, 'specialties');
            const snapshot = await get(specialtiesRef);
            
            if (snapshot.exists()) {
                financialData.specialties = snapshot.val();
            } else {
                financialData.specialties = {};
            }
        }
        
        async function loadFinancialPatients() {
            const patientsRef = ref(db, 'patients');
            const snapshot = await get(patientsRef);
            
            if (snapshot.exists()) {
                financialData.patients = snapshot.val();
            } else {
                financialData.patients = {};
            }
        }
        
        function populateFinancialFilters() {
            // Popular select de profissionais
            const profSelect = $('#financial-professional-filter');
            if (profSelect) {
                profSelect.innerHTML = '<option value="">Todos os Profissionais</option>';
                Object.entries(financialData.professionals)
                    .filter(([_, prof]) => prof.active !== false)
                    .sort((a, b) => a[1].name.localeCompare(b[1].name))
                    .forEach(([id, prof]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = prof.name;
                        profSelect.appendChild(option);
                    });
            }
            
            // Popular select de especialidades
            const specSelect = $('#financial-specialty-filter');
            if (specSelect) {
                specSelect.innerHTML = '<option value="">Todas as Especialidades</option>';
                Object.entries(financialData.specialties)
                    .filter(([_, spec]) => spec.active !== false)
                    .sort((a, b) => a[1].name.localeCompare(b[1].name))
                    .forEach(([id, spec]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = spec.name;
                        specSelect.appendChild(option);
                    });
            }
        }
        
        function setupFinancialFilters() {
            const periodFilter = $('#financial-period-filter');
            const professionalFilter = $('#financial-professional-filter');
            const specialtyFilter = $('#financial-specialty-filter');
            const statusFilter = $('#financial-status-filter');
            const customDateRange = $('#custom-date-range');
            const startDate = $('#financial-start-date');
            const endDate = $('#financial-end-date');
            
            // Listener para período
            periodFilter?.addEventListener('change', () => {
                if (periodFilter.value === 'custom') {
                    customDateRange.style.display = 'grid';
                } else {
                    customDateRange.style.display = 'none';
                }
                applyFinancialFilters();
            });
            
            // Listeners para outros filtros
            professionalFilter?.addEventListener('change', applyFinancialFilters);
            specialtyFilter?.addEventListener('change', applyFinancialFilters);
            statusFilter?.addEventListener('change', applyFinancialFilters);
            startDate?.addEventListener('change', applyFinancialFilters);
            endDate?.addEventListener('change', applyFinancialFilters);
        }
        
        function applyFinancialFilters() {
            const period = $('#financial-period-filter')?.value || 'month';
            const professionalId = $('#financial-professional-filter')?.value || '';
            const specialtyId = $('#financial-specialty-filter')?.value || '';
            const status = $('#financial-status-filter')?.value || '';
            
            // Calcular intervalo de datas
            let startDate, endDate;
            const now = new Date();
            
            if (period === 'custom') {
                const startInput = $('#financial-start-date')?.value;
                const endInput = $('#financial-end-date')?.value;
                startDate = startInput ? new Date(startInput) : new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = endInput ? new Date(endInput) : new Date();
            } else {
                const ranges = getDateRange(period);
                startDate = ranges.start;
                endDate = ranges.end;
            }
            
            // Filtrar appointments
            financialData.filtered = financialData.appointments.filter(appt => {
                // Filtro de data
                const apptDate = new Date(appt.date);
                if (apptDate < startDate || apptDate > endDate) return false;
                
                // Filtro de profissional
                if (professionalId && appt.therapistId !== professionalId) return false;
                
                // Filtro de especialidade
                if (specialtyId && appt.specialtyId !== specialtyId) return false;
                
                // Filtro de status
                if (status && appt.status !== status) return false;
                
                return true;
            });
            
            // Renderizar dados
            renderFinancialDashboard();
        }
        
        function getDateRange(period) {
            const now = new Date();
            let start, end = new Date();
            
            switch(period) {
                case 'today':
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek);
                    break;
                case 'month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    start = new Date(now.getFullYear(), quarter * 3, 1);
                    break;
                case 'year':
                    start = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
            }
            
            return { start, end };
        }
        
        function renderFinancialDashboard() {
            calculateKPIs();
            renderOverviewTab();
            renderProfessionalsTab();
            renderSpecialtiesTab();
            renderPatientsTab();
            
            lucide.createIcons({ nodes: $('#financeiro-page') });
        }
        
        function calculateKPIs() {
            let grossRevenue = 0;
            let netRevenue = 0;
            let totalCommissions = 0;
            let attendanceCount = 0;
            
            financialData.filtered.forEach(appt => {
                // Considerar apenas atendimentos realizados ou com ausência (que gera cobrança)
                if (appt.status === 'presence' || appt.status === 'absence') {
                    const specialty = financialData.specialties[appt.specialtyId];
                    if (specialty) {
                        const patientValue = parseFloat(specialty.patientValue) || 0;
                        const professionalValue = parseFloat(specialty.professionalValue) || 0;
                        
                        grossRevenue += patientValue;
                        totalCommissions += professionalValue;
                        attendanceCount++;
                    }
                }
            });
            
            netRevenue = grossRevenue - totalCommissions;
            const avgTicket = attendanceCount > 0 ? grossRevenue / attendanceCount : 0;
            const commissionPercentage = grossRevenue > 0 ? (totalCommissions / grossRevenue) * 100 : 0;
            const netPercentage = grossRevenue > 0 ? (netRevenue / grossRevenue) * 100 : 0;
            
            // Atualizar KPIs
            $('#kpi-gross-revenue').textContent = formatCurrency(grossRevenue);
            $('#kpi-gross-count').textContent = `${attendanceCount} atendimento${attendanceCount !== 1 ? 's' : ''}`;
            
            $('#kpi-net-revenue').textContent = formatCurrency(netRevenue);
            $('#kpi-net-percentage').textContent = `${netPercentage.toFixed(1)}% da bruta`;
            
            $('#kpi-commissions').textContent = formatCurrency(totalCommissions);
            $('#kpi-commission-percentage').textContent = `${commissionPercentage.toFixed(1)}% da bruta`;
            
            $('#kpi-avg-ticket').textContent = formatCurrency(avgTicket);
            $('#kpi-avg-description').textContent = 'por atendimento';
        }
        
        function renderOverviewTab() {
            const container = $('#overview-content');
            if (!container) return;
            
            // Agrupar por status
            const byStatus = {};
            financialData.filtered.forEach(appt => {
                const status = appt.status || 'scheduled';
                if (!byStatus[status]) {
                    byStatus[status] = { count: 0, revenue: 0 };
                }
                byStatus[status].count++;
                if (status === 'presence' || status === 'absence') {
                    const specialty = financialData.specialties[appt.specialtyId];
                    if (specialty) {
                        byStatus[status].revenue += parseFloat(specialty.patientValue) || 0;
                    }
                }
            });
            
            const statusLabels = {
                'presence': 'Presença',
                'absence': 'Ausência',
                'scheduled': 'Agendado',
                'confirmed': 'Confirmado',
                'cancellation': 'Cancelamento'
            };
            
            const statusColors = {
                'presence': 'bg-green-100 text-green-800',
                'absence': 'bg-red-100 text-red-800',
                'scheduled': 'bg-blue-100 text-blue-800',
                'confirmed': 'bg-purple-100 text-purple-800',
                'cancelled': 'bg-gray-100 text-gray-800'
            };
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            
            Object.entries(byStatus).forEach(([status, data]) => {
                html += `
                    <div class="border rounded-lg p-4 ${statusColors[status] || 'bg-gray-100'}">
                        <h4 class="font-semibold mb-2">${statusLabels[status] || status}</h4>
                        <p class="text-2xl font-bold">${data.count}</p>
                        <p class="text-sm opacity-75">${formatCurrency(data.revenue)}</p>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Adicionar tabela de atendimentos
            html += `
                <div class="mt-6">
                    <h4 class="font-semibold mb-4">Últimos Atendimentos</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Paciente</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Profissional</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            const recent = [...financialData.filtered]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            recent.forEach(appt => {
                const patient = financialData.patients[appt.patientId];
                const professional = financialData.professionals[appt.therapistId];
                const value = appt.financial?.patientValue || 0;
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">${formatDate(appt.date)}</td>
                        <td class="px-4 py-3 text-sm">${patient?.name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">${professional?.name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm font-medium">${formatCurrency(value)}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 text-xs rounded-full ${statusColors[appt.status] || 'bg-gray-100'}">
                                ${statusLabels[appt.status] || appt.status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            
            container.innerHTML = html;
        }
        
        function renderProfessionalsTab() {
            const container = $('#professionals-content');
            if (!container) return;
            
            // Agrupar por profissional
            const byProfessional = {};
            
            financialData.filtered.forEach(appt => {
                const profId = appt.therapistId;
                if (!profId) return;
                
                if (!byProfessional[profId]) {
                    byProfessional[profId] = {
                        name: financialData.professionals[profId]?.name || 'Desconhecido',
                        count: 0,
                        revenue: 0,
                        commission: 0,
                        appointments: []
                    };
                }
                
                if (appt.status === 'presence' || appt.status === 'absence') {
                    const specialty = financialData.specialties[appt.specialtyId];
                    if (specialty) {
                        const revenue = parseFloat(specialty.patientValue) || 0;
                        const commission = parseFloat(specialty.professionalValue) || 0;
                        
                        byProfessional[profId].count++;
                        byProfessional[profId].revenue += revenue;
                        byProfessional[profId].commission += commission;
                        byProfessional[profId].appointments.push(appt);
                    }
                }
            });
            
            let html = '<div class="space-y-4">';
            
            const sorted = Object.entries(byProfessional)
                .sort((a, b) => b[1].revenue - a[1].revenue);
            
            sorted.forEach(([profId, data]) => {
                const avgTicket = data.count > 0 ? data.revenue / data.count : 0;
                const netRevenue = data.revenue - data.commission;
                
                html += `
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-semibold text-lg">${data.name}</h4>
                                <p class="text-sm text-gray-600">${data.count} atendimento${data.count !== 1 ? 's' : ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Receita Bruta</p>
                                <p class="text-2xl font-bold text-blue-600">${formatCurrency(data.revenue)}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-green-50 p-3 rounded">
                                <p class="text-xs text-gray-600 mb-1">Receita Líquida</p>
                                <p class="font-semibold text-green-700">${formatCurrency(netRevenue)}</p>
                            </div>
                            <div class="bg-purple-50 p-3 rounded">
                                <p class="text-xs text-gray-600 mb-1">Comissão</p>
                                <p class="font-semibold text-purple-700">${formatCurrency(data.commission)}</p>
                            </div>
                            <div class="bg-orange-50 p-3 rounded">
                                <p class="text-xs text-gray-600 mb-1">Ticket Médio</p>
                                <p class="font-semibold text-orange-700">${formatCurrency(avgTicket)}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (sorted.length === 0) {
                html += '<p class="text-gray-500 text-center py-8">Nenhum dado encontrado para o período selecionado.</p>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderSpecialtiesTab() {
            const container = $('#specialties-content');
            if (!container) return;
            
            // Agrupar por especialidade
            const bySpecialty = {};
            
            financialData.filtered.forEach(appt => {
                const specId = appt.specialtyId;
                if (!specId) return;
                
                if (!bySpecialty[specId]) {
                    bySpecialty[specId] = {
                        name: financialData.specialties[specId]?.name || 'Desconhecida',
                        count: 0,
                        revenue: 0,
                        commission: 0
                    };
                }
                
                if (appt.status === 'presence' || appt.status === 'absence') {
                    const specialty = financialData.specialties[specId];
                    if (specialty) {
                        const revenue = parseFloat(specialty.patientValue) || 0;
                        const commission = parseFloat(specialty.professionalValue) || 0;
                        
                        bySpecialty[specId].count++;
                        bySpecialty[specId].revenue += revenue;
                        bySpecialty[specId].commission += commission;
                    }
                }
            });
            
            const sorted = Object.entries(bySpecialty)
                .sort((a, b) => b[1].revenue - a[1].revenue);
            
            const totalRevenue = sorted.reduce((sum, [_, data]) => sum + data.revenue, 0);
            
            let html = '<div class="space-y-4">';
            
            sorted.forEach(([specId, data]) => {
                const percentage = totalRevenue > 0 ? (data.revenue / totalRevenue) * 100 : 0;
                const avgTicket = data.count > 0 ? data.revenue / data.count : 0;
                
                html += `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold">${data.name}</h4>
                            <span class="text-sm text-gray-600">${percentage.toFixed(1)}% do total</span>
                        </div>
                        <div class="flex items-center space-x-4 mb-3">
                            <div class="flex-1">
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <p class="text-gray-600">Receita</p>
                                <p class="font-semibold">${formatCurrency(data.revenue)}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Atendimentos</p>
                                <p class="font-semibold">${data.count}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Ticket Médio</p>
                                <p class="font-semibold">${formatCurrency(avgTicket)}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (sorted.length === 0) {
                html += '<p class="text-gray-500 text-center py-8">Nenhum dado encontrado para o período selecionado.</p>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderPatientsTab() {
            const container = $('#patients-content');
            if (!container) return;
            
            // Agrupar por paciente
            const byPatient = {};
            
            financialData.filtered.forEach(appt => {
                const patientId = appt.patientId;
                if (!patientId) return;
                
                if (!byPatient[patientId]) {
                    byPatient[patientId] = {
                        name: financialData.patients[patientId]?.name || 'Desconhecido',
                        count: 0,
                        revenue: 0,
                        lastAppointment: null,
                        appointments: []
                    };
                }
                
                byPatient[patientId].appointments.push(appt);
                
                if (appt.status === 'presence' || appt.status === 'absence') {
                    const specialty = financialData.specialties[appt.specialtyId];
                    if (specialty) {
                        const revenue = parseFloat(specialty.patientValue) || 0;
                        byPatient[patientId].count++;
                        byPatient[patientId].revenue += revenue;
                    }
                }
                
                if (!byPatient[patientId].lastAppointment || new Date(appt.date) > new Date(byPatient[patientId].lastAppointment)) {
                    byPatient[patientId].lastAppointment = appt.date;
                }
            });
            
            const sorted = Object.entries(byPatient)
                .sort((a, b) => b[1].revenue - a[1].revenue);
            
            let html = '<div class="overflow-x-auto">';
            html += `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paciente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Atendimentos</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Receita Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket Médio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Atend.</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            sorted.forEach(([patientId, data]) => {
                const avgTicket = data.count > 0 ? data.revenue / data.count : 0;
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${data.name}</div>
                            <div class="text-sm text-gray-500">${data.appointments.length} agendamento${data.appointments.length !== 1 ? 's' : ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.count}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${formatCurrency(data.revenue)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(avgTicket)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.lastAppointment ? formatDate(data.lastAppointment) : 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            if (sorted.length === 0) {
                html = '<p class="text-gray-500 text-center py-8">Nenhum dado encontrado para o período selecionado.</p>';
            }
            
            container.innerHTML = html;
        }
        
        function switchFinancialTab(tabName) {
            // Atualizar botões
            document.querySelectorAll('.financial-tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.className = 'financial-tab-btn border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600';
                } else {
                    btn.className = 'financial-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300';
                }
            });
            
            // Atualizar conteúdo
            document.querySelectorAll('.financial-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const activeTab = $(`#financial-tab-${tabName}`);
            if (activeTab) {
                activeTab.classList.remove('hidden');
            }
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }
        
        // --- VIRTUAL FILE: relatorios.js ---
        async function loadRelatoriosPage() {
            console.log("Carregando Relatórios...");
            
            try {
                // Carregar profissionais para os selects
                const professionalsRef = ref(db, 'professionals');
                const snapshot = await get(professionalsRef);
                
                if (snapshot.exists()) {
                    const professionals = snapshot.val();
                    const profList = Object.entries(professionals)
                        .filter(([_, prof]) => prof.active)
                        .sort((a, b) => a[1].name.localeCompare(b[1].name));
                    
                    // Popular select de agenda
                    const agendaSelect = $('#report-agenda-professional');
                    if (agendaSelect) {
                        agendaSelect.innerHTML = '<option value="">Todos</option>';
                        profList.forEach(([id, prof]) => {
                            const opt = document.createElement('option');
                            opt.value = id;
                            opt.textContent = prof.name;
                            agendaSelect.appendChild(opt);
                        });
                    }
                    
                    // Popular select de comissões
                    const comissaoSelect = $('#report-comissao-professional');
                    if (comissaoSelect) {
                        comissaoSelect.innerHTML = '<option value="">Selecione...</option>';
                        profList.forEach(([id, prof]) => {
                            const opt = document.createElement('option');
                            opt.value = id;
                            opt.textContent = prof.name;
                            comissaoSelect.appendChild(opt);
                        });
                    }
                }
                
                // Definir data padrão (mês atual)
                const today = new Date();
                const currentMonth = today.toISOString().slice(0, 7); // YYYY-MM
                
                const financeiroMes = $('#report-financeiro-mes');
                if (financeiroMes) financeiroMes.value = currentMonth;
                
                const comissaoMes = $('#report-comissao-mes');
                if (comissaoMes) comissaoMes.value = currentMonth;
                
                // Definir período padrão (semana atual)
                const monday = new Date(today);
                monday.setDate(today.getDate() - today.getDay() + 1);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                
                const agendaInicio = $('#report-agenda-inicio');
                if (agendaInicio) agendaInicio.value = monday.toISOString().split('T')[0];
                
                const agendaFim = $('#report-agenda-fim');
                if (agendaFim) agendaFim.value = sunday.toISOString().split('T')[0];
                
                lucide.createIcons();
                
            } catch (error) {
                console.error('Erro ao carregar página de relatórios:', error);
            }
        }

        // --- VIRTUAL FILE: profissionais.js ---
        async function loadProfissionaisPage() {
            console.log("Carregando Profissionais...");
            
            // Buscar profissionais do Firebase
            try {
                const profissionaisRef = ref(db, 'professionals');
                const snapshot = await get(profissionaisRef);
                
                let professionalsList = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    professionalsList = Object.keys(data).map(id => ({
                        id,
                        ...data[id]
                    })).filter(p => p.active !== false);
                }
                
                renderProfissionaisList(professionalsList);
            } catch (error) {
                console.error("Erro ao carregar profissionais:", error);
                showAlert('Erro', 'Não foi possível carregar os profissionais.', 'error');
            }
        }

        function renderProfissionaisList(professionals) {
            const tbody = $('#profissionais-table-body');
            if (!professionals || professionals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400" data-lucide="user-x"></svg>
                            <p class="mt-2">Nenhum profissional cadastrado</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons({ nodes: tbody });
                return;
            }

            tbody.innerHTML = professionals.map(prof => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${prof.name}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-500">
                            ${prof.specialties ? Object.keys(prof.specialties).length + ' especialidade(s)' : 'Nenhuma'}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${prof.email || '-'}</div>
                        <div class="text-sm text-gray-500">${prof.phone ? formatPhone(prof.phone) : '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            Ativo
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editProfessional('${prof.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Editar</button>
                        <button onclick="viewProfessionalSchedule('${prof.id}')" class="text-gray-600 hover:text-gray-900">Agenda</button>
                    </td>
                </tr>
            `).join('');
        }

        // Listeners em tempo real para profissionais
        let professionalsListener = null;
        
        function setupProfessionalsListener() {
            // Remove listener anterior se existir
            if (professionalsListener) {
                off(ref(db, 'professionals'), 'value', professionalsListener);
            }
            
            // Configura novo listener
            const professionalsRef = ref(db, 'professionals');
            professionalsListener = onValue(professionalsRef, (snapshot) => {
                // Só atualiza se estivermos na página de profissionais
                if (currentPage === '#/profissionais') {
                    let professionalsList = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        professionalsList = Object.keys(data).map(id => ({
                            id,
                            ...data[id]
                        })).filter(p => p.active !== false);
                    }
                    renderProfissionaisList(professionalsList);
                }
            });
        }
        
        function removeProfessionalsListener() {
            if (professionalsListener) {
                off(ref(db, 'professionals'), 'value', professionalsListener);
                professionalsListener = null;
            }
        }

        // --- VIRTUAL FILE: especialidades.js ---
        async function loadEspecialidadesPage() {
            console.log("Carregando Especialidades...");
            
            try {
                const especialidadesRef = ref(db, 'specialties');
                const snapshot = await get(especialidadesRef);
                
                let specialtiesList = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    specialtiesList = Object.keys(data).map(id => ({
                        id,
                        ...data[id]
                    })).filter(s => s.active !== false);
                }
                
                renderEspecialidadesList(specialtiesList);
            } catch (error) {
                console.error("Erro ao carregar especialidades:", error);
                showAlert('Erro', 'Não foi possível carregar as especialidades.', 'error');
            }
        }

        function renderEspecialidadesList(specialties) {
            const grid = $('#especialidades-grid');
            if (!specialties || specialties.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" data-lucide="clipboard-x"></svg>
                        <p class="mt-2">Nenhuma especialidade cadastrada</p>
                    </div>
                `;
                lucide.createIcons({ nodes: grid });
                return;
            }

            grid.innerHTML = specialties.map(spec => `
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-semibold text-gray-900">${spec.name}</h3>
                        <button onclick="editEspecialidade('${spec.id}')" class="text-blue-600 hover:text-blue-900">
                            <svg class="h-5 w-5" data-lucide="edit"></svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${spec.description || 'Sem descrição'}</p>
                    <div class="border-t pt-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-500">Valor Paciente</p>
                                <p class="text-lg font-bold text-green-600">R$ ${(spec.patientValue || spec.defaultValue || 0).toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Repasse Prof.</p>
                                <p class="text-lg font-bold text-blue-600">R$ ${(spec.professionalValue || (spec.defaultValue ? spec.defaultValue * 0.5 : 0) || 0).toFixed(2)}</p>
                            </div>
                        </div>
                        ${(!spec.patientValue && !spec.professionalValue && spec.defaultValue) ? `
                            <p class="text-xs text-yellow-600 mt-2">⚠️ Migrar valores antigos</p>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            lucide.createIcons({ nodes: grid });
        }

        // Listeners em tempo real para especialidades
        let specialtiesListener = null;
        
        function setupSpecialtiesListener() {
            // Remove listener anterior se existir
            if (specialtiesListener) {
                off(ref(db, 'specialties'), 'value', specialtiesListener);
            }
            
            // Configura novo listener
            const specialtiesRef = ref(db, 'specialties');
            specialtiesListener = onValue(specialtiesRef, (snapshot) => {
                // Só atualiza se estivermos na página de especialidades
                if (currentPage === '#/especialidades') {
                    let specialtiesList = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        specialtiesList = Object.keys(data).map(id => ({
                            id,
                            ...data[id]
                        })).filter(s => s.active !== false);
                    }
                    renderEspecialidadesList(specialtiesList);
                }
            });
        }
        
        function removeSpecialtiesListener() {
            if (specialtiesListener) {
                off(ref(db, 'specialties'), 'value', specialtiesListener);
                specialtiesListener = null;
            }
        }

        // --- VIRTUAL FILE: agendas-fixas.js ---
        async function loadAgendasFixasPage() {
            console.log("Carregando Agendas Fixas...");
            
            try {
                const schedulesRef = ref(db, 'fixedSchedules');
                const snapshot = await get(schedulesRef);
                
                let schedulesList = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Buscar dados de profissionais e especialidades
                    const professionalsRef = ref(db, 'professionals');
                    const specialtiesRef = ref(db, 'specialties');
                    const [profSnapshot, specSnapshot] = await Promise.all([
                        get(professionalsRef),
                        get(specialtiesRef)
                    ]);
                    
                    const professionals = profSnapshot.exists() ? profSnapshot.val() : {};
                    const specialties = specSnapshot.exists() ? specSnapshot.val() : {};
                    
                    schedulesList = Object.keys(data).map(id => {
                        const schedule = data[id];
                        return {
                            id,
                            ...schedule,
                            professionalName: professionals[schedule.professionalId]?.name || 'Desconhecido',
                            specialtyName: specialties[schedule.specialtyId]?.name || 'Desconhecida'
                        };
                    });
                }
                
                renderAgendasFixasList(schedulesList);
            } catch (error) {
                console.error("Erro ao carregar agendas fixas:", error);
                showAlert('Erro', 'Não foi possível carregar as agendas fixas.', 'error');
            }
        }

        function renderAgendasFixasList(schedules) {
            const container = $('#agendas-fixas-list');
            
            if (!schedules || schedules.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i data-lucide="calendar-x" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                        <p class="text-lg font-medium">Nenhum horário fixo cadastrado</p>
                        <p class="text-sm mt-2">Clique em "Nova Agenda Fixa" para começar</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const daysOfWeek = {
                0: 'Domingo',
                1: 'Segunda-feira',
                2: 'Terça-feira',
                3: 'Quarta-feira',
                4: 'Quinta-feira',
                5: 'Sexta-feira',
                6: 'Sábado'
            };
            
            // Agrupar por dia da semana
            const groupedByDay = schedules.reduce((acc, schedule) => {
                const day = schedule.dayOfWeek;
                if (!acc[day]) acc[day] = [];
                acc[day].push(schedule);
                return acc;
            }, {});
            
            // Ordenar cada dia por horário
            Object.keys(groupedByDay).forEach(day => {
                groupedByDay[day].sort((a, b) => a.startTime.localeCompare(b.startTime));
            });
            
            // Renderizar agrupado por dia
            let html = '';
            [1, 2, 3, 4, 5, 6, 0].forEach(dayNum => { // Segunda a Domingo
                if (!groupedByDay[dayNum] || groupedByDay[dayNum].length === 0) return;
                
                html += `
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i>
                            ${daysOfWeek[dayNum]}
                        </h3>
                        <div class="space-y-2">
                            ${groupedByDay[dayNum].map(schedule => `
                                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${schedule.active === false ? 'bg-gray-50 opacity-60' : 'bg-white'}">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-semibold rounded-full">
                                                    ${schedule.startTime}
                                                </span>
                                                ${schedule.active === false ? 
                                                    '<span class="px-2 py-0.5 bg-gray-200 text-gray-600 text-xs font-medium rounded">INATIVO</span>' : 
                                                    '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-medium rounded">ATIVO</span>'
                                                }
                                            </div>
                                            <div class="text-sm text-gray-700 space-y-1">
                                                <p><span class="font-semibold">Profissional:</span> ${schedule.professionalName}</p>
                                                <p><span class="font-semibold">Especialidade:</span> ${schedule.specialtyName}</p>
                                                ${schedule.notes ? `<p class="text-gray-600 italic mt-2">${schedule.notes}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="flex gap-2 ml-4">
                                            <button onclick="toggleFixedScheduleActive('${schedule.id}', ${schedule.active !== false})" 
                                                class="p-2 ${schedule.active !== false ? 'text-gray-500 hover:text-gray-700' : 'text-green-500 hover:text-green-700'} transition-colors" 
                                                title="${schedule.active !== false ? 'Desativar' : 'Ativar'}">
                                                <i data-lucide="${schedule.active !== false ? 'toggle-right' : 'toggle-left'}" class="w-5 h-5"></i>
                                            </button>
                                            <button onclick="editHorarioFixo('${schedule.id}')" 
                                                class="p-2 text-blue-600 hover:text-blue-800 transition-colors" 
                                                title="Editar">
                                                <i data-lucide="edit" class="w-5 h-5"></i>
                                            </button>
                                            <button onclick="deleteHorarioFixo('${schedule.id}')" 
                                                class="p-2 text-red-600 hover:text-red-800 transition-colors" 
                                                title="Excluir">
                                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            if (!html) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i data-lucide="calendar-x" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                        <p class="text-lg font-medium">Nenhum horário fixo cadastrado</p>
                    </div>
                `;
            } else {
                container.innerHTML = html;
            }
            
            lucide.createIcons();
        }

        // Listeners em tempo real para agendas fixas
        let fixedSchedulesListener = null;
        let schedulesCachedProfessionals = {};
        let schedulesCachedSpecialties = {};
        
        async function setupFixedSchedulesListener() {
            // Remove listener anterior se existir
            if (fixedSchedulesListener) {
                off(ref(db, 'fixedSchedules'), 'value', fixedSchedulesListener);
            }
            
            // Carregar profissionais e especialidades em cache
            try {
                const [profSnapshot, specSnapshot] = await Promise.all([
                    get(ref(db, 'professionals')),
                    get(ref(db, 'specialties'))
                ]);
                
                schedulesCachedProfessionals = profSnapshot.exists() ? profSnapshot.val() : {};
                schedulesCachedSpecialties = specSnapshot.exists() ? specSnapshot.val() : {};
            } catch (error) {
                console.error('Erro ao carregar cache:', error);
            }
            
            // Configura novo listener
            const schedulesRef = ref(db, 'fixedSchedules');
            fixedSchedulesListener = onValue(schedulesRef, (snapshot) => {
                // Só atualiza se estivermos na página de agendas fixas
                if (currentPage === '#/agendas-fixas') {
                    let schedulesList = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        schedulesList = Object.keys(data).map(id => {
                            const schedule = data[id];
                            return {
                                id,
                                ...schedule,
                                professionalName: schedulesCachedProfessionals[schedule.professionalId]?.name || 'Desconhecido',
                                specialtyName: schedulesCachedSpecialties[schedule.specialtyId]?.name || 'Desconhecida'
                            };
                        });
                    }
                    renderAgendasFixasList(schedulesList);
                }
            });
        }
        
        function removeFixedSchedulesListener() {
            if (fixedSchedulesListener) {
                off(ref(db, 'fixedSchedules'), 'value', fixedSchedulesListener);
                fixedSchedulesListener = null;
            }
        }

        // --- VIRTUAL FILE: atendimentos.js ---
        async function loadAtendimentosPage() {
            console.log("Carregando Atendimentos...");
            
            try {
                const appointmentsRef = ref(db, 'appointments');
                const snapshot = await get(appointmentsRef);
                
                let appointmentsList = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    appointmentsList = Object.keys(data).map(id => ({
                        id,
                        ...data[id]
                    })).sort((a, b) => new Date(b.date) - new Date(a.date));
                }
                
                // Buscar dados relacionados
                const patientsSnapshot = await get(ref(db, 'patients'));
                const professionalsSnapshot = await get(ref(db, 'professionals'));
                const specialtiesSnapshot = await get(ref(db, 'specialties'));
                
                const patients = patientsSnapshot.exists() ? patientsSnapshot.val() : {};
                const professionals = professionalsSnapshot.exists() ? professionalsSnapshot.val() : {};
                const specialties = specialtiesSnapshot.exists() ? specialtiesSnapshot.val() : {};
                
                // Enriquecer dados dos atendimentos
                appointmentsList = appointmentsList.map(app => {
                    const patient = patients[app.patientId] || {};
                    const professional = professionals[app.therapistId] || {};
                    const specialty = specialties[app.specialtyId] || {};
                    
                    return {
                        ...app,
                        patientName: patient.name || 'Não encontrado',
                        professionalName: professional.name || 'Não encontrado',
                        specialtyName: specialty.name || 'Não definida',
                        patientValue: specialty.patientValue || 0,
                        professionalValue: specialty.professionalValue || 0
                    };
                });
                
                renderAtendimentosList(appointmentsList);
            } catch (error) {
                console.error("Erro ao carregar atendimentos:", error);
                showAlert('Erro', 'Não foi possível carregar os atendimentos.', 'error');
            }
        }

        function renderAtendimentosList(appointments) {
            const tbody = $('#atendimentos-table-body');
            if (!appointments || appointments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400" data-lucide="calendar-x"></svg>
                            <p class="mt-2">Nenhum atendimento encontrado</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons({ nodes: tbody });
                return;
            }

            const statusColors = {
                scheduled: 'bg-gray-100 text-gray-800',
                presence: 'bg-green-100 text-green-800',
                absence: 'bg-red-100 text-red-800',
                cancellation: 'bg-yellow-100 text-yellow-800'
            };

            const statusLabels = {
                scheduled: 'Agendado',
                presence: 'Presença',
                absence: 'Ausência',
                cancellation: 'Cancelamento'
            };

            tbody.innerHTML = appointments.map(app => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${formatDate(app.date)}</div>
                        <div class="text-sm text-gray-500">${app.time || 'undefined - undefined'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${app.patientName || 'Carregando...'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${app.professionalName || 'Carregando...'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-500">${app.specialtyName || 'Carregando...'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[app.status] || statusColors.scheduled}">
                            ${statusLabels[app.status] || app.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        ${app.status === 'presence' || app.status === 'absence' ? `
                            <div class="text-sm">
                                <div>Pac: R$ ${(app.patientValue || 0).toFixed(2)}</div>
                                <div class="text-gray-500">Rep: R$ ${(app.professionalValue || 0).toFixed(2)}</div>
                            </div>
                        ` : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewAppointmentDetails('${app.id}')" class="text-blue-600 hover:text-blue-900">Detalhes</button>
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons({ nodes: tbody });
        }

        // --- VIRTUAL FILE: financeiro.js ---
        async function loadFinanceiroPage() {
            console.log("Carregando Financeiro...");
            
            try {
                const appointmentsRef = ref(db, 'appointments');
                const snapshot = await get(appointmentsRef);
                
                let totalReceber = 0;
                let totalRepasses = 0;
                
                if (snapshot.exists()) {
                    // Buscar especialidades para obter os valores
                    const specialtiesSnapshot = await get(ref(db, 'specialties'));
                    const specialties = specialtiesSnapshot.exists() ? specialtiesSnapshot.val() : {};
                    
                    const data = snapshot.val();
                    Object.values(data).forEach(app => {
                        // Só conta atendimentos com presença ou ausência
                        if (app.status === 'presence' || app.status === 'absence') {
                            const specialty = specialties[app.specialtyId];
                            if (specialty) {
                                totalReceber += specialty.patientValue || 0;
                                totalRepasses += specialty.professionalValue || 0;
                            }
                        }
                    });
                }
                
                $('#total-receber').textContent = `R$ ${totalReceber.toFixed(2)}`;
                $('#total-repasses').textContent = `R$ ${totalRepasses.toFixed(2)}`;
                $('#saldo-liquido').textContent = `R$ ${(totalReceber - totalRepasses).toFixed(2)}`;
                
            } catch (error) {
                console.error("Erro ao carregar financeiro:", error);
                showAlert('Erro', 'Não foi possível carregar dados financeiros.', 'error');
            }
        }

        // --- VIRTUAL FILE: minha-agenda.js ---
        async function loadMinhaAgendaPage() {
            console.log("Carregando Minha Agenda (Therapist)...");
            
            if (!currentUserProfile.professionalId) {
                showAlert('Erro', 'Perfil de profissional não encontrado.', 'error');
                return;
            }
            
            try {
                const appointmentsRef = ref(db, 'appointments');
                const q = query(appointmentsRef, orderByChild('professionalId'), equalTo(currentUserProfile.professionalId));
                const snapshot = await get(q);
                
                let myAppointments = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    myAppointments = Object.keys(data).map(id => ({
                        id,
                        ...data[id]
                    }));
                }
                
                // Renderizar calendário e resumo
                renderTherapistCalendar(myAppointments);
                updateTherapistSummary(myAppointments);
                
            } catch (error) {
                console.error("Erro ao carregar minha agenda:", error);
                showAlert('Erro', 'Não foi possível carregar sua agenda.', 'error');
            }
        }

        function renderTherapistCalendar(appointments) {
            // TODO: Implementar FullCalendar para therapist (apenas visualização)
            $('#therapist-calendar').innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" data-lucide="calendar"></svg>
                    <p class="mt-2">Calendário em desenvolvimento</p>
                </div>
            `;
            lucide.createIcons({ nodes: $('#therapist-calendar') });
        }

        function updateTherapistSummary(appointments) {
            const thisMonth = appointments.filter(app => {
                const appDate = new Date(app.date);
                const now = new Date();
                return appDate.getMonth() === now.getMonth() && appDate.getFullYear() === now.getFullYear();
            });
            
            const present = thisMonth.filter(app => app.status === 'present').length;
            const total = thisMonth.length;
            const totalValue = thisMonth
                .filter(app => app.status === 'present' && app.financial)
                .reduce((sum, app) => sum + (app.financial.professionalValue || 0), 0);
            
            $('#my-total-appointments').textContent = total;
            $('#my-present').textContent = present;
            $('#my-total-value').textContent = `R$ ${totalValue.toFixed(2)}`;
        }

        // --- VIRTUAL FILE: usuarios.js ---
        
        let currentEditingUserId = null;
        let allUsers = [];
        
        /**
         * Carrega a página de usuários
         */
        async function loadUsuariosPage() {
            console.log("Carregando Usuários...");
            
            try {
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                
                allUsers = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    allUsers = Object.keys(data).map(id => ({
                        id,
                        ...data[id]
                    }));
                }
                
                renderUsuariosTable(allUsers);
                setupUsuariosFilters();
                
            } catch (error) {
                console.error("Erro ao carregar usuários:", error);
                showAlert('Erro', 'Não foi possível carregar os usuários.', 'error');
            }
        }
        
        /**
         * Renderiza a tabela de usuários
         */
        function renderUsuariosTable(users) {
            const tbody = $('#usuarios-table-body');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" data-lucide="users"></svg>
                            <p class="text-lg font-medium">Nenhum usuário encontrado</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons({ nodes: tbody });
                return;
            }
            
            const roleLabels = {
                'administrator': 'Administrador',
                'reception': 'Recepção',
                'therapist': 'Terapeuta'
            };
            
            const roleColors = {
                'administrator': 'bg-purple-100 text-purple-800',
                'reception': 'bg-blue-100 text-blue-800',
                'therapist': 'bg-green-100 text-green-800'
            };
            
            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white font-semibold">
                                    ${(user.name || user.email || '?').charAt(0).toUpperCase()}
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.name || 'Sem nome'}</div>
                                <div class="text-sm text-gray-500">${user.cpf ? formatCPF(user.cpf) : '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${user.email}</div>
                        <div class="text-sm text-gray-500">${user.phone ? formatPhone(user.phone) : '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${roleColors[user.role] || 'bg-gray-100 text-gray-800'}">
                            ${roleLabels[user.role] || user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.active !== false ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.active !== false ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('pt-BR') : 'Nunca'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editUsuario('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                            Editar
                        </button>
                        <button onclick="toggleUserStatus('${user.id}', ${user.active !== false})" 
                            class="${user.active !== false ? 'text-orange-600 hover:text-orange-900' : 'text-green-600 hover:text-green-900'} mr-3">
                            ${user.active !== false ? 'Desativar' : 'Ativar'}
                        </button>
                        <button onclick="deleteUsuario('${user.id}')" class="text-red-600 hover:text-red-900">
                            Excluir
                        </button>
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons({ nodes: tbody });
        }
        
        /**
         * Configura filtros da página de usuários
         */
        function setupUsuariosFilters() {
            const searchInput = $('#search-usuarios');
            const filterRole = $('#filter-role');
            const filterStatus = $('#filter-status');
            
            const applyFilters = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const roleFilter = filterRole.value;
                const statusFilter = filterStatus.value;
                
                const filtered = allUsers.filter(user => {
                    const matchSearch = !searchTerm || 
                        (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                        (user.email && user.email.toLowerCase().includes(searchTerm));
                    
                    const matchRole = !roleFilter || user.role === roleFilter;
                    
                    const matchStatus = !statusFilter || 
                        (statusFilter === 'active' && user.active !== false) ||
                        (statusFilter === 'inactive' && user.active === false);
                    
                    return matchSearch && matchRole && matchStatus;
                });
                
                renderUsuariosTable(filtered);
            };
            
            searchInput.addEventListener('input', applyFilters);
            filterRole.addEventListener('change', applyFilters);
            filterStatus.addEventListener('change', applyFilters);
        }
        
        /**
         * Abre modal para criar/editar usuário
         */
        async function openModalUsuario(userId = null) {
            currentEditingUserId = userId;
            const modal = $('#modal-usuario');
            const title = $('#modal-usuario-title');
            const form = $('#form-usuario');
            const passwordContainer = $('#password-container');
            const professionalLinkContainer = $('#professional-link-container');
            
            // Carregar lista de profissionais para vinculação
            await loadProfessionalsForLink();
            
            if (userId) {
                // Editar
                title.textContent = 'Editar Usuário';
                passwordContainer.querySelector('label').innerHTML = 'Nova Senha (deixe em branco para manter)';
                $('#user-password').removeAttribute('required');
                
                try {
                    showGlobalLoader();
                    const userRef = ref(db, `users/${userId}`);
                    const snapshot = await get(userRef);
                    
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        $('#user-id').value = userId;
                        $('#user-name').value = userData.name || '';
                        $('#user-email').value = userData.email || '';
                        $('#user-role').value = userData.role || '';
                        $('#user-phone').value = formatPhone(userData.phone || '');
                        $('#user-cpf').value = formatCPF(userData.cpf || '');
                        $('#user-password').value = ''; // Limpar senha
                        $('#user-active').checked = userData.active !== false;
                        $('#user-professional-id').value = userData.professionalId || '';
                        
                        // Mostrar/ocultar vinculação de profissional
                        if (userData.role === 'therapist') {
                            professionalLinkContainer.classList.remove('hidden');
                        } else {
                            professionalLinkContainer.classList.add('hidden');
                        }
                    }
                    
                    hideGlobalLoader();
                } catch (error) {
                    hideGlobalLoader();
                    console.error("Erro ao carregar usuário:", error);
                    showAlert('Erro', 'Não foi possível carregar os dados do usuário.', 'error');
                    return;
                }
            } else {
                // Criar - Reset form para novo usuário
                form.reset();
                $('#user-active').checked = true;
                $('#user-id').value = '';
                
                title.textContent = 'Novo Usuário';
                passwordContainer.querySelector('label').innerHTML = 'Senha *';
                $('#user-password').setAttribute('required', 'required');
                professionalLinkContainer.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
            lucide.createIcons({ nodes: modal });
        }
        
        /**
         * Fecha modal de usuário
         */
        function closeModalUsuario() {
            $('#modal-usuario').classList.add('hidden');
            currentEditingUserId = null;
        }
        
        /**
         * Carrega lista de profissionais para vinculação
         */
        async function loadProfessionalsForLink() {
            try {
                const profsRef = ref(db, 'professionals');
                const snapshot = await get(profsRef);
                
                const select = $('#user-professional-id');
                select.innerHTML = '<option value="">Nenhum</option>';
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.keys(data).forEach(id => {
                        const prof = data[id];
                        if (prof.active !== false) {
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = prof.name;
                            select.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error("Erro ao carregar profissionais:", error);
            }
        }
        
        /**
         * Evento de mudança de função do usuário
         */
        $('#user-role')?.addEventListener('change', (e) => {
            const professionalLinkContainer = $('#professional-link-container');
            if (e.target.value === 'therapist') {
                professionalLinkContainer.classList.remove('hidden');
            } else {
                professionalLinkContainer.classList.add('hidden');
                $('#user-professional-id').value = '';
            }
        });
        
        /**
         * Salva usuário (criar ou editar)
         */
        $('#form-usuario')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                showGlobalLoader();
                
                const userId = $('#user-id').value;
                const name = $('#user-name').value.trim();
                const email = $('#user-email').value.trim().toLowerCase();
                const password = $('#user-password').value;
                const role = $('#user-role').value;
                const phone = $('#user-phone').value.trim();
                const cpf = $('#user-cpf').value.trim();
                const active = $('#user-active').checked;
                const professionalId = $('#user-professional-id').value || null;
                
                // Validações
                if (!name || !email || !role) {
                    hideGlobalLoader();
                    showAlert('Atenção', 'Preencha todos os campos obrigatórios.', 'warning');
                    return;
                }
                
                if (!userId && !password) {
                    hideGlobalLoader();
                    showAlert('Atenção', 'A senha é obrigatória para novos usuários.', 'warning');
                    return;
                }
                
                if (password && password.length < 6) {
                    hideGlobalLoader();
                    showAlert('Atenção', 'A senha deve ter no mínimo 6 caracteres.', 'warning');
                    return;
                }
                
                const userData = {
                    name,
                    email,
                    role,
                    phone: unformatPhone(phone) || null,
                    cpf: unformatCPF(cpf) || null,
                    active,
                    professionalId,
                    updatedAt: Date.now(),
                    updatedBy: currentUser.uid
                };
                
                if (userId) {
                    // Editar usuário existente
                    const userRef = ref(db, `users/${userId}`);
                    const oldSnapshot = await get(userRef);
                    const oldData = oldSnapshot.val();
                    
                    // Se mudou a senha, atualizar (em produção, isso requer Firebase Admin SDK)
                    // Por ora, vamos apenas salvar um indicador
                    if (password) {
                        userData.passwordChanged = Date.now();
                        // TODO: Implementar mudança de senha via Cloud Function
                    }
                    
                    await update(userRef, userData);
                    
                    await logAudit('update', 'user', userId, [
                        { field: 'name', oldValue: oldData.name, newValue: name },
                        { field: 'role', oldValue: oldData.role, newValue: role },
                        { field: 'active', oldValue: String(oldData.active), newValue: String(active) }
                    ]);
                    
                    showAlert('Sucesso', 'Usuário atualizado com sucesso!', 'info');
                    
                } else {
                    // Criar novo usuário
                    // NOTA: Em produção, a criação de usuários deve ser feita via Cloud Function
                    // que usará o Firebase Admin SDK para criar a autenticação
                    
                    // Por ora, vamos apenas criar o registro no database
                    const newUserRef = push(ref(db, 'users'));
                    userData.createdAt = Date.now();
                    userData.createdBy = currentUser.uid;
                    userData.tempPassword = password; // Armazenar temporariamente
                    
                    await set(newUserRef, userData);
                    
                    await logAudit('create', 'user', newUserRef.key, [
                        { field: 'email', oldValue: '', newValue: email },
                        { field: 'role', oldValue: '', newValue: role }
                    ]);
                    
                    showAlert('Sucesso', 
                        'Usuário criado com sucesso! IMPORTANTE: Em produção, um email será enviado para o usuário criar sua senha.',
                        'info'
                    );
                }
                
                hideGlobalLoader();
                closeModalUsuario();
                await loadUsuariosPage();
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao salvar usuário:", error);
                showAlert('Erro', 'Não foi possível salvar o usuário: ' + error.message, 'error');
            }
        });
        
        /**
         * Edita um usuário
         */
        async function editUsuario(userId) {
            await openModalUsuario(userId);
        }
        
        /**
         * Ativa/Desativa um usuário
         */
        async function toggleUserStatus(userId, currentStatus) {
            try {
                const action = currentStatus ? 'desativar' : 'ativar';
                const confirmed = await showConfirm(
                    `${action.charAt(0).toUpperCase() + action.slice(1)} Usuário`,
                    `Tem certeza que deseja ${action} este usuário?`
                );
                
                if (!confirmed) return;
                
                showGlobalLoader();
                
                const userRef = ref(db, `users/${userId}`);
                await update(userRef, {
                    active: !currentStatus,
                    updatedAt: Date.now(),
                    updatedBy: currentUser.uid
                });
                
                await logAudit('status_change', 'user', userId, [
                    { field: 'active', oldValue: String(currentStatus), newValue: String(!currentStatus) }
                ]);
                
                hideGlobalLoader();
                showAlert('Sucesso', `Usuário ${action}do com sucesso!`, 'info');
                await loadUsuariosPage();
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao alterar status:", error);
                showAlert('Erro', 'Não foi possível alterar o status do usuário.', 'error');
            }
        }
        
        /**
         * Exclui um usuário
         */
        async function deleteUsuario(userId) {
            try {
                // Buscar dados do usuário para mostrar no alerta
                const userRef = ref(db, `users/${userId}`);
                const snapshot = await get(userRef);
                
                if (!snapshot.exists()) {
                    showAlert('Erro', 'Usuário não encontrado.', 'error');
                    return;
                }
                
                const userData = snapshot.val();
                
                // Impedir exclusão do próprio usuário
                if (userId === currentUser.uid) {
                    showAlert('Atenção', 'Você não pode excluir sua própria conta!', 'warning');
                    return;
                }
                
                // Confirmação dupla
                const confirmed1 = await showConfirm(
                    '⚠️ Excluir Usuário - Confirmação 1/2',
                    `Tem certeza que deseja excluir o usuário "${userData.name || userData.email}"? Esta ação é IRREVERSÍVEL!`
                );
                
                if (!confirmed1) return;
                
                const confirmed2 = await showConfirm(
                    '⚠️ Excluir Usuário - Confirmação 2/2',
                    'ÚLTIMA CONFIRMAÇÃO: Todos os dados deste usuário serão permanentemente excluídos. Continuar?'
                );
                
                if (!confirmed2) return;
                
                showGlobalLoader();
                
                // Registrar auditoria ANTES de excluir
                await logAudit('delete', 'user', userId, [
                    { field: 'name', oldValue: userData.name || '', newValue: '' },
                    { field: 'email', oldValue: userData.email || '', newValue: '' },
                    { field: 'role', oldValue: userData.role || '', newValue: '' }
                ]);
                
                // Excluir usuário
                await set(userRef, null);
                
                hideGlobalLoader();
                showAlert('Sucesso', 'Usuário excluído com sucesso!', 'info');
                await loadUsuariosPage();
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao excluir usuário:", error);
                showAlert('Erro', 'Não foi possível excluir o usuário: ' + error.message, 'error');
            }
        }

        // --- VIRTUAL FILE: auditoria.js ---
        async function loadAuditoriaPage() {
            console.log("Carregando Auditoria...");
            
            try {
                const auditRef = ref(db, 'auditLog');
                const snapshot = await get(auditRef);
                
                let auditLogs = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    auditLogs = Object.keys(data).map(id => ({
                        id,
                        ...data[id]
                    })).sort((a, b) => b.timestamp - a.timestamp).slice(0, 100); // Últimos 100
                }
                
                renderAuditLogs(auditLogs);
                
                // Carregar lista de backups
                await loadBackupsList();
                
            } catch (error) {
                console.error("Erro ao carregar auditoria:", error);
                showAlert('Erro', 'Não foi possível carregar o registro de auditoria.', 'error');
            }
        }

        function renderAuditLogs(logs) {
            const tbody = $('#auditoria-table-body');
            if (!logs || logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400" data-lucide="shield-off"></svg>
                            <p class="mt-2">Nenhum registro de auditoria encontrado</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons({ nodes: tbody });
                return;
            }

            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${new Date(log.timestamp).toLocaleString('pt-BR')}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${log.userName}</div>
                        <div class="text-sm text-gray-500">${log.userRole}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${log.action}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${log.entityType || '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${log.changes && Array.isArray(log.changes) 
                            ? log.changes.map(c => `${c.field}: ${c.oldValue} → ${c.newValue}`).join('<br>') 
                            : (log.details || '-')}
                    </td>
                </tr>
            `).join('');
        }

        // ===== FUNÇÕES DE BACKUP E RESTAURAÇÃO =====
        
        /**
         * Cria um backup completo do banco de dados
         */
        async function createBackup() {
            try {
                const confirmed = await showConfirm(
                    'Criar Backup',
                    'Deseja criar um backup completo do banco de dados? Isso pode levar alguns minutos.'
                );
                
                if (!confirmed) return;
                
                showGlobalLoader();
                
                // Buscar todos os dados
                const dbRef = ref(db);
                const snapshot = await get(dbRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Aviso', 'Não há dados para fazer backup.', 'warning');
                    return;
                }
                
                const allData = snapshot.val();
                const timestamp = Date.now();
                const backupData = {
                    createdAt: timestamp,
                    createdBy: currentUser.uid,
                    createdByName: currentUserProfile.name || currentUser.email,
                    data: allData
                };
                
                // Salvar backup no Firebase
                const backupRef = ref(db, `backups/${timestamp}`);
                await set(backupRef, backupData);
                
                // Registrar auditoria
                await logAudit('backup', 'database', 'full', [
                    { field: 'action', oldValue: '', newValue: 'Backup completo criado' }
                ]);
                
                hideGlobalLoader();
                showAlert('Sucesso', 'Backup criado com sucesso!', 'info');
                
                // Atualizar lista de backups
                loadBackupsList();
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao criar backup:", error);
                showAlert('Erro', 'Não foi possível criar o backup: ' + error.message, 'error');
            }
        }
        
        /**
         * Carrega a lista de backups disponíveis
         */
        async function loadBackupsList() {
            try {
                const backupsRef = ref(db, 'backups');
                const snapshot = await get(backupsRef);
                
                const backupsList = $('#backups-list');
                
                if (!snapshot.exists()) {
                    backupsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Nenhum backup disponível</p>';
                    return;
                }
                
                const data = snapshot.val();
                const backups = Object.keys(data).map(key => ({
                    id: key,
                    ...data[key]
                })).sort((a, b) => b.createdAt - a.createdAt);
                
                const isLastBackup = (index) => index === 0; // Último backup (mais recente)
                
                backupsList.innerHTML = backups.map((backup, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-200 hover:bg-gray-100 transition-colors">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <svg class="w-4 h-4 text-blue-600" data-lucide="database"></svg>
                                <span class="text-sm font-medium text-gray-900">
                                    ${new Date(backup.createdAt).toLocaleString('pt-BR')}
                                </span>
                                ${isLastBackup(index) ? '<span class="ml-2 px-2 py-0.5 bg-green-100 text-green-800 text-xs font-semibold rounded">Mais Recente</span>' : ''}
                            </div>
                            <p class="text-xs text-gray-600">Por: ${backup.createdByName || 'Desconhecido'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="restoreBackup('${backup.id}')" 
                                class="px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded hover:bg-green-700 transition-colors flex items-center gap-1">
                                <svg class="w-3 h-3" data-lucide="refresh-cw"></svg>
                                Restaurar
                            </button>
                            ${!isLastBackup(index) ? `
                                <button onclick="deleteBackup('${backup.id}')" 
                                    class="px-3 py-1.5 bg-red-600 text-white text-xs font-medium rounded hover:bg-red-700 transition-colors flex items-center gap-1">
                                    <svg class="w-3 h-3" data-lucide="trash-2"></svg>
                                    Excluir
                                </button>
                            ` : `
                                <button disabled
                                    class="px-3 py-1.5 bg-gray-300 text-gray-500 text-xs font-medium rounded cursor-not-allowed flex items-center gap-1"
                                    title="O backup mais recente não pode ser excluído">
                                    <svg class="w-3 h-3" data-lucide="lock"></svg>
                                    Protegido
                                </button>
                            `}
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons({ nodes: backupsList });
                
            } catch (error) {
                console.error("Erro ao carregar backups:", error);
            }
        }
        
        /**
         * Abre modal para restaurar backup
         */
        async function openRestoreModal() {
            const backupsRef = ref(db, 'backups');
            const snapshot = await get(backupsRef);
            
            if (!snapshot.exists()) {
                showAlert('Aviso', 'Não há backups disponíveis para restauração.', 'warning');
                return;
            }
            
            await loadBackupsList();
            
            showAlert(
                'Restauração de Backup',
                'Selecione um backup na lista abaixo para restaurar. ATENÇÃO: Isso substituirá TODOS os dados atuais!',
                'warning'
            );
        }
        
        /**
         * Restaura um backup específico
         */
        async function restoreBackup(backupId) {
            try {
                const confirmed1 = await showConfirm(
                    'Confirmar Restauração - Etapa 1/3',
                    '⚠️ ATENÇÃO: Esta ação substituirá TODOS os dados atuais pelos dados do backup. Tem certeza?'
                );
                
                if (!confirmed1) return;
                
                const confirmed2 = await showConfirm(
                    'Confirmar Restauração - Etapa 2/3',
                    '⚠️ ÚLTIMA CHANCE: Os dados atuais serão PERMANENTEMENTE substituídos. Continuar?'
                );
                
                if (!confirmed2) return;
                
                const confirmed3 = await showConfirm(
                    'Confirmar Restauração - Etapa 3/3',
                    '⚠️ CONFIRMAÇÃO FINAL: Digite "RESTAURAR" para confirmar (em letras maiúsculas)'
                );
                
                if (!confirmed3) return;
                
                showGlobalLoader();
                
                // Buscar dados do backup
                const backupRef = ref(db, `backups/${backupId}`);
                const snapshot = await get(backupRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Erro', 'Backup não encontrado.', 'error');
                    return;
                }
                
                const backupData = snapshot.val();
                
                // Criar backup de segurança antes de restaurar
                const currentDbRef = ref(db);
                const currentSnapshot = await get(currentDbRef);
                const autoBackupData = {
                    createdAt: Date.now(),
                    createdBy: currentUser.uid,
                    createdByName: currentUserProfile.name || currentUser.email,
                    data: currentSnapshot.val(),
                    autoBackup: true,
                    beforeRestore: backupId
                };
                
                await set(ref(db, `backups/auto_${Date.now()}`), autoBackupData);
                
                // Restaurar dados (exceto a própria pasta de backups)
                const restoreData = { ...backupData.data };
                
                // Manter os backups atuais
                const currentBackupsRef = ref(db, 'backups');
                const currentBackupsSnapshot = await get(currentBackupsRef);
                if (currentBackupsSnapshot.exists()) {
                    restoreData.backups = currentBackupsSnapshot.val();
                }
                
                // Aplicar restauração
                await set(ref(db), restoreData);
                
                // Registrar auditoria
                await logAudit('restore', 'database', backupId, [
                    { field: 'action', oldValue: '', newValue: `Backup ${backupId} restaurado` }
                ]);
                
                hideGlobalLoader();
                showAlert('Sucesso', 'Backup restaurado com sucesso! A página será recarregada.', 'info');
                
                // Recarregar a página após 2 segundos
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao restaurar backup:", error);
                showAlert('Erro', 'Não foi possível restaurar o backup: ' + error.message, 'error');
            }
        }
        
        /**
         * Exclui um backup específico
         */
        async function deleteBackup(backupId) {
            try {
                // Verificar se é o último backup
                const backupsRef = ref(db, 'backups');
                const snapshot = await get(backupsRef);
                
                if (!snapshot.exists()) {
                    showAlert('Erro', 'Nenhum backup encontrado.', 'error');
                    return;
                }
                
                const data = snapshot.val();
                const backups = Object.keys(data).map(key => ({
                    id: key,
                    createdAt: data[key].createdAt
                })).sort((a, b) => b.createdAt - a.createdAt);
                
                // Verificar se é o último backup (mais recente)
                if (backups.length === 1) {
                    showAlert('Ação Bloqueada', 'Não é possível excluir o único backup disponível. Sempre deve haver pelo menos um backup.', 'warning');
                    return;
                }
                
                if (backups[0].id === backupId) {
                    showAlert('Ação Bloqueada', 'Não é possível excluir o backup mais recente. Sempre deve haver pelo menos um backup protegido.', 'warning');
                    return;
                }
                
                // Buscar dados do backup para mostrar na confirmação
                const backupData = data[backupId];
                const backupDate = new Date(backupData.createdAt).toLocaleString('pt-BR');
                
                const confirmed = await showConfirm(
                    'Excluir Backup',
                    `Tem certeza que deseja excluir o backup de ${backupDate}?\n\nCriado por: ${backupData.createdByName || 'Desconhecido'}\n\nEsta ação não pode ser desfeita.`
                );
                
                if (!confirmed) return;
                
                showGlobalLoader();
                
                // Excluir o backup
                const backupRef = ref(db, `backups/${backupId}`);
                await set(backupRef, null);
                
                // Registrar auditoria
                await logAudit('delete', 'backup', backupId, [
                    { field: 'action', oldValue: backupDate, newValue: 'Backup excluído' }
                ]);
                
                hideGlobalLoader();
                showAlert('Sucesso', 'Backup excluído com sucesso!', 'success');
                
                // Atualizar lista de backups
                loadBackupsList();
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao excluir backup:", error);
                showAlert('Erro', 'Não foi possível excluir o backup: ' + error.message, 'error');
            }
        }
        
        /**
         * Apaga todos os dados do banco (mantém estrutura)
         */
        async function deleteAllData() {
            try {
                const confirmed1 = await showConfirm(
                    '🚨 EXCLUSÃO TOTAL - Confirmação 1/3',
                    'ATENÇÃO: Você está prestes a APAGAR TODOS OS DADOS do sistema. Continuar?'
                );
                
                if (!confirmed1) return;
                
                const confirmed2 = await showConfirm(
                    '🚨 EXCLUSÃO TOTAL - Confirmação 2/3',
                    'Esta ação é IRREVERSÍVEL! Todos os pacientes, profissionais, agendas e dados serão PERMANENTEMENTE excluídos. Tem ABSOLUTA certeza?'
                );
                
                if (!confirmed2) return;
                
                const confirmed3 = await showConfirm(
                    '🚨 EXCLUSÃO TOTAL - Confirmação 3/3',
                    'ÚLTIMA CONFIRMAÇÃO: Um backup automático será criado antes da exclusão. Prosseguir com a exclusão completa?'
                );
                
                if (!confirmed3) return;
                
                showGlobalLoader();
                
                // Criar backup automático antes de apagar
                const dbRef = ref(db);
                const snapshot = await get(dbRef);
                
                if (snapshot.exists()) {
                    const autoBackupData = {
                        createdAt: Date.now(),
                        createdBy: currentUser.uid,
                        createdByName: currentUserProfile.name || currentUser.email,
                        data: snapshot.val(),
                        autoBackup: true,
                        beforeDeletion: true
                    };
                    
                    await set(ref(db, `backups/auto_delete_${Date.now()}`), autoBackupData);
                }
                
                // Apagar todos os dados principais (mantém users e backups)
                const entitiesToDelete = [
                    'patients',
                    'professionals',
                    'specialties',
                    'appointments',
                    'fixedSchedules',
                    'auditLog',
                    'attendances'
                ];
                
                for (const entity of entitiesToDelete) {
                    await set(ref(db, entity), null);
                }
                
                // Registrar auditoria
                await logAudit('delete_all', 'database', 'all', [
                    { field: 'action', oldValue: 'Dados existentes', newValue: 'Todos os dados excluídos' }
                ]);
                
                hideGlobalLoader();
                showAlert('Concluído', 'Todos os dados foram excluídos. Um backup foi criado automaticamente. A página será recarregada.', 'info');
                
                // Recarregar a página após 2 segundos
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao excluir dados:", error);
                showAlert('Erro', 'Não foi possível excluir os dados: ' + error.message, 'error');
            }
        }

        /**
         * Confirmação para limpar atendimentos
         */
        async function confirmClearAppointments() {
            const confirmed = await showConfirm(
                '⚠️ Limpar Todos os Atendimentos',
                'ATENÇÃO: Esta ação irá REMOVER TODOS os atendimentos do sistema, mantendo apenas o mais recente como backup de segurança.\n\nEsta ação NÃO pode ser desfeita.\n\nDeseja continuar?'
            );
            
            if (!confirmed) return;
            
            await clearAllAppointments();
        }

        /**
         * Limpa todos os atendimentos, mantendo o mais recente
         */
        async function clearAllAppointments() {
            try {
                showGlobalLoader();
                
                const appointmentsRef = ref(db, 'appointments');
                const snapshot = await get(appointmentsRef);
                
                if (!snapshot.exists()) {
                    hideGlobalLoader();
                    showAlert('Aviso', 'Nenhum atendimento encontrado para excluir.', 'warning');
                    return;
                }
                
                const data = snapshot.val();
                const appointments = Object.keys(data).map(key => ({
                    id: key,
                    createdAt: data[key].createdAt || 0
                })).sort((a, b) => b.createdAt - a.createdAt);
                
                // Verificar se há atendimentos
                if (appointments.length === 0) {
                    hideGlobalLoader();
                    showAlert('Aviso', 'Nenhum atendimento encontrado para excluir.', 'warning');
                    return;
                }
                
                // Se houver apenas um atendimento
                if (appointments.length === 1) {
                    hideGlobalLoader();
                    showAlert('Ação Bloqueada', 'Existe apenas um atendimento. Não é possível excluir o único atendimento disponível.', 'warning');
                    return;
                }
                
                // Manter o mais recente (primeiro da lista ordenada)
                const mostRecentId = appointments[0].id;
                const appointmentsToDelete = appointments.slice(1); // Todos exceto o primeiro
                
                console.log(`Excluindo ${appointmentsToDelete.length} atendimentos, mantendo o mais recente (${mostRecentId})`);
                
                // Excluir todos exceto o mais recente
                const deletePromises = appointmentsToDelete.map(appt => {
                    const apptRef = ref(db, `appointments/${appt.id}`);
                    return set(apptRef, null);
                });
                
                await Promise.all(deletePromises);
                
                // Registrar auditoria
                await logAudit('delete_bulk', 'appointments', 'all', [
                    { field: 'count', oldValue: appointments.length.toString(), newValue: '1' },
                    { field: 'kept', oldValue: '', newValue: mostRecentId },
                    { field: 'action', oldValue: '', newValue: 'Limpeza de atendimentos mantendo o mais recente' }
                ]);
                
                hideGlobalLoader();
                showAlert('Sucesso', `${appointmentsToDelete.length} atendimentos foram excluídos com sucesso! O atendimento mais recente foi mantido como backup.`, 'success');
                
                // Atualizar página se estiver na agenda
                if (currentPage === '#/agenda') {
                    loadAgendaPage();
                }
                
            } catch (error) {
                hideGlobalLoader();
                console.error("Erro ao limpar atendimentos:", error);
                showAlert('Erro', 'Não foi possível limpar os atendimentos: ' + error.message, 'error');
            }
        }

        // --- VIRTUAL FILE: configuracoes.js ---
        async function loadConfiguracoesPage() {
            console.log("Carregando Configurações...");
            
            // Mostrar zona de perigo apenas para administradores
            const dangerZone = $('#danger-zone-section');
            if (dangerZone && currentUserProfile && currentUserProfile.role === 'administrator') {
                dangerZone.style.display = 'block';
                lucide.createIcons({ nodes: dangerZone });
            }
            
            try {
                const configRef = ref(db, 'systemSettings');
                const snapshot = await get(configRef);
                
                if (snapshot.exists()) {
                    const config = snapshot.val();
                    
                    // Preencher campos
                    if (config.clinic) {
                        $('#config-clinic-name').value = config.clinic.name || '';
                        $('#config-clinic-cnpj').value = config.clinic.cnpj || '';
                        $('#config-clinic-phone').value = formatPhone(config.clinic.phone || '');
                        $('#config-clinic-email').value = config.clinic.email || '';
                    }
                    
                    if (config.financial) {
                        $('#config-default-repass').value = config.financial.defaultRepassPercentage || 70;
                        $('#config-auto-reports').checked = config.financial.autoGenerateReports || false;
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar configurações:", error);
                showAlert('Erro', 'Não foi possível carregar as configurações.', 'error');
            }
        }


        // --- EXPOSIÇÃO DE FUNÇÕES GLOBAIS PARA ONCLICK ---
        // Estas funções precisam estar acessíveis globalmente para serem chamadas via onclick
        window.editEspecialidade = editEspecialidade;
        window.editProfessional = editProfessional;
        window.viewProfessionalSchedule = viewProfessionalSchedule;
        window.editPaciente = editPaciente;
        window.viewPatientDetails = viewPatientDetails;
        window.viewAppointmentDetails = viewAppointmentDetails;
        window.editAgendamento = editAgendamento;
        window.updateStatus = updateStatus;
        window.editHorarioFixo = editHorarioFixo;
        window.deleteHorarioFixo = deleteHorarioFixo;
        window.toggleFixedScheduleActive = toggleFixedScheduleActive;
        window.generateAppointmentsFromFixedSchedules = generateAppointmentsFromFixedSchedules;
        window.openModalEspecialidade = openModalEspecialidade;
        window.closeModalEspecialidade = closeModalEspecialidade;
        window.openModalProfissional = openModalProfissional;
        window.closeModalProfissional = closeModalProfissional;
        window.openModalPaciente = openModalPaciente;
        window.closeModalPaciente = closeModalPaciente;
        window.openModalAgendamento = openModalAgendamento;
        window.closeModalAgendamento = closeModalAgendamento;
        window.openModalStatus = openModalStatus;
        window.closeModalStatus = closeModalStatus;
        window.openModalHorarioFixo = openModalHorarioFixo;
        window.closeModalHorarioFixo = closeModalHorarioFixo;
        window.switchPatientTab = switchPatientTab;
        window.switchFinancialTab = switchFinancialTab;
        window.addCustomValue = addCustomValue;
        window.removeCustomValue = removeCustomValue;
        window.addPackage = addPackage;
        window.removePackage = removePackage;
        window.updateProfessionalsList = updateProfessionalsList;
        window.checkConflicts = checkConflicts;
        window.addSpecialtyToProf = addSpecialtyToProf;
        window.removeSpecialtyFromProf = removeSpecialtyFromProf;
        window.generateAgendaPDF = generateAgendaPDF;
        window.generateFinanceiroPDF = generateFinanceiroPDF;
        window.generateComissaoPDF = generateComissaoPDF;
        window.generatePacotesPDF = generatePacotesPDF;
        window.showConfirm = showConfirm;
        window.createBackup = createBackup;
        window.openRestoreModal = openRestoreModal;
        window.restoreBackup = restoreBackup;
        window.deleteBackup = deleteBackup;
        window.deleteAllData = deleteAllData;
        window.confirmClearAppointments = confirmClearAppointments;
        window.clearAllAppointments = clearAllAppointments;
        window.confirmDeleteAppointment = confirmDeleteAppointment;
        window.deleteAppointment = deleteAppointment;
        window.openModalUsuario = openModalUsuario;
        window.closeModalUsuario = closeModalUsuario;
        window.editUsuario = editUsuario;
        window.toggleUserStatus = toggleUserStatus;
        window.deleteUsuario = deleteUsuario;


        // --- PONTO DE ENTRADA DA APLICAÇÃO ---
        // Garante que o DOM esteja pronto antes de rodar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

    </script>
</body>
</html>
