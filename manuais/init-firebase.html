<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicializar Banco de Dados - Cl√≠nica Singular</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-12">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">
                    <i data-lucide="database" class="inline-block w-10 h-10 mb-1"></i>
                    Inicializar Banco de Dados
                </h1>
                <p class="text-gray-600">Configure o Firebase Realtime Database com dados de exemplo completos</p>
            </div>

            <!-- Configuration Card -->
            <div class="bg-white rounded-lg shadow-xl p-8 mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i data-lucide="settings" class="w-6 h-6 mr-2"></i>
                    Configura√ß√£o do Firebase
                </h2>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                        <input type="text" id="apiKey" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="AIzaSy...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Auth Domain</label>
                        <input type="text" id="authDomain" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="seu-projeto.firebaseapp.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Database URL</label>
                        <input type="text" id="databaseURL" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://seu-projeto.firebaseio.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project ID</label>
                        <input type="text" id="projectId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="seu-projeto">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Storage Bucket</label>
                        <input type="text" id="storageBucket" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="seu-projeto.appspot.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Messaging Sender ID</label>
                        <input type="text" id="messagingSenderId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="123456789">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">App ID</label>
                        <input type="text" id="appId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="1:123456789:web:abc123">
                    </div>
                </div>

                <button onclick="autoFillFromIndex()" class="mb-4 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    <i data-lucide="copy" class="w-4 h-4 inline mr-2"></i>
                    Copiar do index.html
                </button>
            </div>

            <!-- Data Preview Card -->
            <div class="bg-white rounded-lg shadow-xl p-8 mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i data-lucide="eye" class="w-6 h-6 mr-2"></i>
                    Dados que ser√£o criados
                </h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-blue-600">3</div>
                        <div class="text-sm text-gray-600">Usu√°rios</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-green-600">8</div>
                        <div class="text-sm text-gray-600">Especialidades</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-purple-600">12</div>
                        <div class="text-sm text-gray-600">Profissionais</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-orange-600">20</div>
                        <div class="text-sm text-gray-600">Pacientes</div>
                    </div>
                    <div class="bg-pink-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-pink-600">50</div>
                        <div class="text-sm text-gray-600">Agendamentos</div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-indigo-600">15</div>
                        <div class="text-sm text-gray-600">Hor√°rios Fixos</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-yellow-600">10</div>
                        <div class="text-sm text-gray-600">Pacotes</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-red-600">100+</div>
                        <div class="text-sm text-gray-600">Logs Auditoria</div>
                    </div>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <div class="flex">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-400 mr-3 flex-shrink-0"></i>
                        <div>
                            <p class="text-sm text-yellow-700">
                                <strong>Aten√ß√£o:</strong> Este script ir√° <strong>SOBRESCREVER</strong> todos os dados existentes no Firebase.
                                Certifique-se de ter um backup antes de continuar.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="flex items-center">
                        <input type="checkbox" id="createUsers" checked class="w-4 h-4 text-blue-600">
                        <span class="ml-2 text-sm text-gray-700">Criar Usu√°rios (admin, profissional, visualizador)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="createSpecialties" checked class="w-4 h-4 text-blue-600">
                        <span class="ml-2 text-sm text-gray-700">Criar Especialidades (Psicologia, Fonoaudiologia, etc)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="createProfessionals" checked class="w-4 h-4 text-blue-600">
                        <span class="ml-2 text-sm text-gray-700">Criar Profissionais (12 profissionais com m√∫ltiplas especialidades)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="createPatients" checked class="w-4 h-4 text-blue-600">
                        <span class="ml-2 text-sm text-gray-700">Criar Pacientes (20 pacientes com dados completos e pacotes)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="createAppointments" checked class="w-4 h-4 text-blue-600">
                        <span class="ml-2 text-sm text-gray-700">Criar Agendamentos (50 agendamentos nos √∫ltimos 6 meses)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="createFixedSchedules" checked class="w-4 h-4 text-blue-600">
                        <span class="ml-2 text-sm text-gray-700">Criar Hor√°rios Fixos (15 hor√°rios recorrentes)</span>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4 mb-6">
                <button onclick="initializeDatabase()" class="flex-1 px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg">
                    <i data-lucide="database" class="w-5 h-5 inline mr-2"></i>
                    Inicializar Banco de Dados
                </button>
                <button onclick="clearDatabase()" class="px-6 py-4 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                    <i data-lucide="trash-2" class="w-5 h-5 inline mr-2"></i>
                    Limpar Tudo
                </button>
            </div>

            <!-- Progress Card -->
            <div id="progressCard" class="bg-white rounded-lg shadow-xl p-8 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i data-lucide="activity" class="w-6 h-6 mr-2"></i>
                    Progresso
                </h2>
                <div id="progressLog" class="space-y-2 max-h-96 overflow-y-auto font-mono text-sm"></div>
            </div>

            <!-- Credentials Card -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg shadow-xl p-8 border-2 border-green-200">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="key" class="w-6 h-6 mr-2"></i>
                    Credenciais de Acesso
                </h2>
                <div class="space-y-3">
                    <div class="bg-white p-4 rounded-lg">
                        <div class="font-semibold text-gray-700 mb-1">üëë Administrator</div>
                        <div class="text-sm text-gray-600">Email: <code class="bg-gray-100 px-2 py-1 rounded">admin@clinicasingular.com.br</code></div>
                        <div class="text-sm text-gray-600">Senha: <code class="bg-gray-100 px-2 py-1 rounded">Admin@123</code></div>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <div class="font-semibold text-gray-700 mb-1">üë®‚Äç‚öïÔ∏è Professional</div>
                        <div class="text-sm text-gray-600">Email: <code class="bg-gray-100 px-2 py-1 rounded">profissional@clinicasingular.com.br</code></div>
                        <div class="text-sm text-gray-600">Senha: <code class="bg-gray-100 px-2 py-1 rounded">Prof@123</code></div>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <div class="font-semibold text-gray-700 mb-1">üëÅÔ∏è Viewer</div>
                        <div class="text-sm text-gray-600">Email: <code class="bg-gray-100 px-2 py-1 rounded">visualizador@clinicasingular.com.br</code></div>
                        <div class="text-sm text-gray-600">Senha: <code class="bg-gray-100 px-2 py-1 rounded">View@123</code></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getDatabase, ref, set, remove } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        let app, db, auth;

        // Auto-fill configuration from index.html
        window.autoFillFromIndex = function() {
            // Voc√™ pode copiar a configura√ß√£o do seu index.html aqui
            alert('Preencha os campos com as credenciais do seu Firebase Console:\n\n1. Acesse console.firebase.google.com\n2. Selecione seu projeto\n3. V√° em Configura√ß√µes do Projeto\n4. Copie as credenciais da se√ß√£o "Seus apps"');
        };

        // Initialize Firebase with user inputs
        function initFirebase() {
            const firebaseConfig = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                databaseURL: document.getElementById('databaseURL').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };

            // Validate configuration
            if (!firebaseConfig.apiKey || !firebaseConfig.databaseURL) {
                throw new Error('Configura√ß√£o do Firebase incompleta!');
            }

            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            
            return { app, db, auth };
        }

        // Logging function
        function log(message, type = 'info') {
            const progressCard = document.getElementById('progressCard');
            const progressLog = document.getElementById('progressLog');
            progressCard.classList.remove('hidden');
            
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600'
            };
            
            const icons = {
                info: 'üìã',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `${colors[type]} flex items-start`;
            logEntry.innerHTML = `
                <span class="mr-2">${icons[type]}</span>
                <span>${message}</span>
            `;
            progressLog.appendChild(logEntry);
            progressLog.scrollTop = progressLog.scrollHeight;
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // Format date for Firebase
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Get random item from array
        function randomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        // Create Users
        async function createUsers() {
            log('Criando usu√°rios...', 'info');
            
            const users = [
                {
                    email: 'admin@clinicasingular.com.br',
                    password: 'Admin@123',
                    role: 'administrator',
                    name: 'Administrador Cl√≠nica'
                },
                {
                    email: 'profissional@clinicasingular.com.br',
                    password: 'Prof@123',
                    role: 'professional',
                    name: 'Profissional Teste'
                },
                {
                    email: 'visualizador@clinicasingular.com.br',
                    password: 'View@123',
                    role: 'viewer',
                    name: 'Visualizador Teste'
                }
            ];

            for (const user of users) {
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, user.email, user.password);
                    const uid = userCredential.user.uid;
                    
                    await set(ref(db, `users/${uid}`), {
                        email: user.email,
                        role: user.role,
                        name: user.name,
                        active: true,
                        createdAt: new Date().toISOString()
                    });
                    
                    log(`Usu√°rio criado: ${user.email} (${user.role})`, 'success');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        log(`Usu√°rio j√° existe: ${user.email}`, 'warning');
                    } else {
                        log(`Erro ao criar ${user.email}: ${error.message}`, 'error');
                    }
                }
            }
        }

        // Create Specialties
        async function createSpecialties() {
            log('Criando especialidades...', 'info');
            
            const specialties = [
                { name: 'Psicologia', duration: 50, price: 180.00, commission: 60, color: '#8B5CF6' },
                { name: 'Fonoaudiologia', duration: 45, price: 150.00, commission: 50, color: '#3B82F6' },
                { name: 'Terapia Ocupacional', duration: 50, price: 170.00, commission: 55, color: '#10B981' },
                { name: 'Psicopedagogia', duration: 60, price: 160.00, commission: 55, color: '#F59E0B' },
                { name: 'Nutri√ß√£o', duration: 40, price: 140.00, commission: 45, color: '#EF4444' },
                { name: 'Fisioterapia', duration: 50, price: 150.00, commission: 50, color: '#06B6D4' },
                { name: 'Neuropsicologia', duration: 60, price: 200.00, commission: 70, color: '#6366F1' },
                { name: 'Musicoterapia', duration: 45, price: 130.00, commission: 45, color: '#EC4899' }
            ];

            for (const specialty of specialties) {
                const id = generateId();
                await set(ref(db, `specialties/${id}`), {
                    ...specialty,
                    active: true,
                    createdAt: new Date().toISOString()
                });
                log(`Especialidade criada: ${specialty.name}`, 'success');
            }
            
            return specialties;
        }

        // Create Professionals
        async function createProfessionals(specialtyIds) {
            log('Criando profissionais...', 'info');
            
            const professionals = [
                { name: 'Dra. Ana Paula Silva', council: 'CRP', number: '06/123456', specialties: [0, 3] },
                { name: 'Dr. Carlos Mendes', council: 'CRFa', number: '2-12345', specialties: [1] },
                { name: 'Dra. Beatriz Costa', council: 'CREFITO', number: '3-123456', specialties: [2] },
                { name: 'Dra. Fernanda Lima', council: 'CRP', number: '06/234567', specialties: [0, 6] },
                { name: 'Dr. Gabriel Santos', council: 'CRN', number: '4-12345', specialties: [4] },
                { name: 'Dra. Helena Oliveira', council: 'CREFITO', number: '3-234567', specialties: [5] },
                { name: 'Dra. Isabela Rocha', council: 'CRP', number: '06/345678', specialties: [3] },
                { name: 'Dr. Jo√£o Pedro Alves', council: 'CRFa', number: '2-23456', specialties: [1, 7] },
                { name: 'Dra. Larissa Martins', council: 'CRP', number: '06/456789', specialties: [0] },
                { name: 'Dra. Marina Souza', council: 'CREFITO', number: '3-345678', specialties: [2, 5] },
                { name: 'Dr. Paulo Henrique', council: 'CRP', number: '06/567890', specialties: [6] },
                { name: 'Dra. Rafaela Dias', council: 'MT', number: '12345', specialties: [7] }
            ];

            const createdProfessionals = [];
            
            for (const prof of professionals) {
                const id = generateId();
                const specialtiesData = {};
                
                prof.specialties.forEach(idx => {
                    specialtiesData[specialtyIds[idx]] = true;
                });
                
                const professional = {
                    name: prof.name,
                    professionalCouncil: prof.council,
                    councilNumber: prof.number,
                    phone: `(11) 9${Math.floor(1000 + Math.random() * 9000)}-${Math.floor(1000 + Math.random() * 9000)}`,
                    email: prof.name.toLowerCase().replace(/dra?\.\s/g, '').replace(/\s+/g, '.') + '@clinicasingular.com.br',
                    specialties: specialtiesData,
                    active: true,
                    createdAt: new Date().toISOString()
                };
                
                await set(ref(db, `professionals/${id}`), professional);
                createdProfessionals.push({ id, ...professional });
                log(`Profissional criado: ${prof.name}`, 'success');
            }
            
            return createdProfessionals;
        }

        // Create Patients
        async function createPatients(specialtyIds) {
            log('Criando pacientes...', 'info');
            
            const firstNames = ['Lucas', 'Julia', 'Pedro', 'Maria', 'Gabriel', 'Ana', 'Rafael', 'Beatriz', 'Felipe', 'Carolina', 'Matheus', 'Larissa', 'Thiago', 'Fernanda', 'Bruno', 'Camila', 'Diego', 'Amanda', 'Rodrigo', 'Isabela'];
            const lastNames = ['Silva', 'Santos', 'Oliveira', 'Souza', 'Costa', 'Pereira', 'Rodrigues', 'Alves', 'Nascimento', 'Lima', 'Ara√∫jo', 'Fernandes', 'Carvalho', 'Gomes', 'Martins', 'Rocha', 'Ribeiro', 'Almeida', 'Monteiro', 'Mendes'];
            
            const createdPatients = [];
            
            for (let i = 0; i < 20; i++) {
                const id = generateId();
                const firstName = firstNames[i];
                const lastName = randomItem(lastNames);
                const fullName = `${firstName} ${lastName}`;
                
                const birthYear = 1990 + Math.floor(Math.random() * 20);
                const birthMonth = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
                const birthDay = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
                
                const patient = {
                    name: fullName,
                    birthDate: `${birthYear}-${birthMonth}-${birthDay}`,
                    phone: `(11) 9${Math.floor(1000 + Math.random() * 9000)}-${Math.floor(1000 + Math.random() * 9000)}`,
                    email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}@email.com`,
                    address: `Rua das Flores, ${Math.floor(100 + Math.random() * 900)}`,
                    neighborhood: randomItem(['Centro', 'Jardim Am√©rica', 'Vila Mariana', 'Moema', 'Pinheiros']),
                    city: 'S√£o Paulo',
                    state: 'SP',
                    zipCode: `${Math.floor(10000 + Math.random() * 90000)}-${Math.floor(100 + Math.random() * 900)}`,
                    active: true,
                    createdAt: new Date().toISOString()
                };
                
                // Add discount for some patients
                if (i % 3 === 0) {
                    patient.discount = Math.floor(5 + Math.random() * 20); // 5-25%
                }
                
                // Add custom values for some patients
                if (i % 4 === 0) {
                    patient.customValues = {};
                    const randomSpecialty = randomItem(specialtyIds);
                    patient.customValues[randomSpecialty] = Math.floor(100 + Math.random() * 100); // R$100-200
                }
                
                // Add packages for some patients
                if (i % 2 === 0) {
                    patient.packages = {};
                    const packageId = generateId();
                    const totalSessions = [4, 8, 12, 16][Math.floor(Math.random() * 4)];
                    const usedSessions = Math.floor(Math.random() * (totalSessions / 2));
                    
                    patient.packages[packageId] = {
                        specialtyId: randomItem(specialtyIds),
                        name: `Pacote ${totalSessions} Sess√µes`,
                        totalSessions: totalSessions,
                        usedSessions: usedSessions,
                        price: totalSessions * 150,
                        createdAt: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString()
                    };
                }
                
                await set(ref(db, `patients/${id}`), patient);
                createdPatients.push({ id, ...patient });
                log(`Paciente criado: ${fullName}`, 'success');
            }
            
            return createdPatients;
        }

        // Create Appointments
        async function createAppointments(specialtyIds, professionals, patients) {
            log('Criando agendamentos...', 'info');
            
            const statuses = ['scheduled', 'present', 'absent', 'cancelled'];
            const now = new Date();
            
            for (let i = 0; i < 50; i++) {
                const id = generateId();
                
                // Random date in last 6 months
                const daysAgo = Math.floor(Math.random() * 180);
                const appointmentDate = new Date(now.getTime() - daysAgo * 24 * 60 * 60 * 1000);
                
                const professional = randomItem(professionals);
                const patient = randomItem(patients);
                const specialtyId = randomItem(Object.keys(professional.specialties));
                
                // Get specialty details from the created specialties
                const specialtyRef = ref(db, `specialties/${specialtyId}`);
                const specialtySnapshot = await new Promise((resolve) => {
                    import('https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js').then(({ get }) => {
                        get(specialtyRef).then(resolve);
                    });
                });
                const specialty = specialtySnapshot.val();
                
                const hour = 8 + Math.floor(Math.random() * 9); // 8h-17h
                const minute = [0, 30][Math.floor(Math.random() * 2)];
                const startTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                
                const duration = specialty?.duration || 50;
                const endDate = new Date(appointmentDate.getTime());
                endDate.setHours(hour, minute + duration);
                const endTime = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
                
                // Status based on date (past appointments have finalized statuses)
                let status;
                if (daysAgo > 7) {
                    status = randomItem(['present', 'absent', 'cancelled']);
                } else if (daysAgo > 0) {
                    status = randomItem(['scheduled', 'present']);
                } else {
                    status = 'scheduled';
                }
                
                const patientValue = specialty?.price || 150;
                const professionalValue = specialty?.commission || 50;
                
                const appointment = {
                    date: formatDate(appointmentDate),
                    startTime: startTime,
                    endTime: endTime,
                    duration: duration,
                    patientId: patient.id,
                    professionalId: professional.id,
                    specialtyId: specialtyId,
                    status: status,
                    financial: {
                        patientValue: patientValue,
                        professionalValue: professionalValue,
                        isPaid: status === 'present' ? (Math.random() > 0.3) : false
                    },
                    notes: i % 5 === 0 ? 'Primeira consulta de avalia√ß√£o' : '',
                    createdAt: new Date(appointmentDate.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString()
                };
                
                await set(ref(db, `appointments/${id}`), appointment);
                
                if (i % 10 === 0) {
                    log(`Agendamentos criados: ${i + 1}/50`, 'info');
                }
            }
            
            log('Todos os agendamentos criados!', 'success');
        }

        // Create Fixed Schedules
        async function createFixedSchedules(professionals, specialtyIds) {
            log('Criando hor√°rios fixos...', 'info');
            
            const daysOfWeek = [1, 2, 3, 4, 5]; // Monday to Friday
            const times = ['08:00', '09:00', '10:00', '14:00', '15:00', '16:00'];
            
            let count = 0;
            for (let i = 0; i < 15; i++) {
                const id = generateId();
                const professional = randomItem(professionals);
                const specialtyId = randomItem(Object.keys(professional.specialties));
                const dayOfWeek = randomItem(daysOfWeek);
                const startTime = randomItem(times);
                
                const fixedSchedule = {
                    professionalId: professional.id,
                    specialtyId: specialtyId,
                    dayOfWeek: dayOfWeek,
                    startTime: startTime,
                    duration: 50,
                    active: true,
                    createdAt: new Date().toISOString()
                };
                
                await set(ref(db, `fixedSchedules/${id}`), fixedSchedule);
                count++;
                log(`Hor√°rio fixo criado: ${professional.name.split(' ')[1]} - ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'][dayOfWeek]} ${startTime}`, 'success');
            }
        }

        // Create Audit Logs
        async function createAuditLogs() {
            log('Criando logs de auditoria...', 'info');
            
            const actions = [
                'Criou especialidade',
                'Editou profissional',
                'Criou paciente',
                'Agendou consulta',
                'Cancelou agendamento',
                'Marcou presen√ßa',
                'Gerou relat√≥rio',
                'Criou hor√°rio fixo'
            ];
            
            for (let i = 0; i < 100; i++) {
                const id = generateId();
                const daysAgo = Math.floor(Math.random() * 180);
                const logDate = new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000);
                
                const auditLog = {
                    userId: 'admin-user-id',
                    userName: 'Administrador',
                    action: randomItem(actions),
                    timestamp: logDate.toISOString(),
                    details: 'Opera√ß√£o realizada com sucesso'
                };
                
                await set(ref(db, `auditLogs/${id}`), auditLog);
                
                if (i % 25 === 0) {
                    log(`Logs de auditoria criados: ${i + 1}/100`, 'info');
                }
            }
            
            log('Todos os logs de auditoria criados!', 'success');
        }

        // Main initialization function
        window.initializeDatabase = async function() {
            try {
                log('Iniciando configura√ß√£o do banco de dados...', 'info');
                document.getElementById('progressLog').innerHTML = '';
                
                // Initialize Firebase
                const { db, auth } = initFirebase();
                log('Firebase inicializado com sucesso!', 'success');
                
                // Get checkboxes
                const createUsersCheck = document.getElementById('createUsers').checked;
                const createSpecialtiesCheck = document.getElementById('createSpecialties').checked;
                const createProfessionalsCheck = document.getElementById('createProfessionals').checked;
                const createPatientsCheck = document.getElementById('createPatients').checked;
                const createAppointmentsCheck = document.getElementById('createAppointments').checked;
                const createFixedSchedulesCheck = document.getElementById('createFixedSchedules').checked;
                
                let specialtyIds = [];
                let professionals = [];
                let patients = [];
                
                // Create users
                if (createUsersCheck) {
                    await createUsers();
                }
                
                // Create specialties
                if (createSpecialtiesCheck) {
                    const specialties = await createSpecialties();
                    // Get specialty IDs from database
                    const specialtiesRef = ref(db, 'specialties');
                    const snapshot = await new Promise((resolve) => {
                        import('https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js').then(({ get }) => {
                            get(specialtiesRef).then(resolve);
                        });
                    });
                    if (snapshot.exists()) {
                        specialtyIds = Object.keys(snapshot.val());
                    }
                }
                
                // Create professionals
                if (createProfessionalsCheck && specialtyIds.length > 0) {
                    professionals = await createProfessionals(specialtyIds);
                }
                
                // Create patients
                if (createPatientsCheck && specialtyIds.length > 0) {
                    patients = await createPatients(specialtyIds);
                }
                
                // Create appointments
                if (createAppointmentsCheck && professionals.length > 0 && patients.length > 0) {
                    await createAppointments(specialtyIds, professionals, patients);
                }
                
                // Create fixed schedules
                if (createFixedSchedulesCheck && professionals.length > 0 && specialtyIds.length > 0) {
                    await createFixedSchedules(professionals, specialtyIds);
                }
                
                // Create audit logs
                await createAuditLogs();
                
                log('========================================', 'success');
                log('‚úÖ BANCO DE DADOS INICIALIZADO COM SUCESSO!', 'success');
                log('========================================', 'success');
                log('Voc√™ j√° pode acessar o sistema com as credenciais abaixo.', 'info');
                
            } catch (error) {
                log(`ERRO: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Clear database function
        window.clearDatabase = async function() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° APAGAR TODOS OS DADOS do Firebase!\n\nTem certeza que deseja continuar?')) {
                return;
            }
            
            if (!confirm('üî¥ CONFIRMA√á√ÉO FINAL: Esta a√ß√£o √© IRREVERS√çVEL!\n\nDigite SIM para confirmar.')) {
                return;
            }
            
            try {
                log('Limpando banco de dados...', 'warning');
                document.getElementById('progressLog').innerHTML = '';
                
                const { db } = initFirebase();
                
                const collections = ['users', 'specialties', 'professionals', 'patients', 'appointments', 'fixedSchedules', 'auditLogs'];
                
                for (const collection of collections) {
                    await remove(ref(db, collection));
                    log(`Cole√ß√£o removida: ${collection}`, 'warning');
                }
                
                log('========================================', 'success');
                log('‚úÖ BANCO DE DADOS LIMPO!', 'success');
                log('========================================', 'success');
                
            } catch (error) {
                log(`ERRO: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>
